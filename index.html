<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sequencer</title>
  <script type="module" crossorigin>var fe=Object.defineProperty;var vt=p=>{throw TypeError(p)};var me=(p,d,m)=>d in p?fe(p,d,{enumerable:!0,configurable:!0,writable:!0,value:m}):p[d]=m;var u=(p,d,m)=>me(p,typeof d!="symbol"?d+"":d,m),wt=(p,d,m)=>d.has(p)||vt("Cannot "+m);var o=(p,d,m)=>(wt(p,d,"read from private field"),m?m.call(p):d.get(p)),y=(p,d,m)=>d.has(p)?vt("Cannot add the same private member more than once"):d instanceof WeakSet?d.add(p):d.set(p,m),h=(p,d,m,f)=>(wt(p,d,"write to private field"),f?f.call(p,m):d.set(p,m),m);(async()=>{var O,T,N,A,R,$,B,G,S,M,L,_,j,U,F,z,H,rt,w,k,D;(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(r){if(r.ep)return;r.ep=!0;const n=t(r);fetch(r.href,n)}})();var p=(e=>(e[e.Dom=0]="Dom",e[e.Midi=1]="Midi",e))(p||{}),d=(e=>(e[e.Dom=0]="Dom",e[e.Midi=1]="Midi",e))(d||{}),m=(e=>(e[e.Log=0]="Log",e[e.Dom=1]="Dom",e[e.Midi=2]="Midi",e))(m||{}),f=(e=>(e[e.Playing=0]="Playing",e[e.Paused=1]="Paused",e[e.Stopped=2]="Stopped",e))(f||{}),I=(e=>(e[e.Play=0]="Play",e[e.Pause=1]="Pause",e[e.Resume=2]="Resume",e[e.Stop=3]="Stop",e))(I||{}),C=(e=>(e[e.Finish=0]="Finish",e[e.NoteOn=1]="NoteOn",e[e.NoteOff=2]="NoteOff",e[e.Compute=3]="Compute",e))(C||{});function a(e,t={},...s){const r=document.createElement(e);for(const[n,i]of Object.entries(t))r.setAttribute(n,i);for(const n of s)typeof n=="string"?r.appendChild(document.createTextNode(n)):n&&r.appendChild(n);return r}const E=await navigator.requestMIDIAccess({sysex:!0}).catch(()=>null);function Q(e,t,s){const r=[];if(!E)return r.push(`The ${e} cannot be type MIDI without MIDI access`),r;const n=E[s].values(),i=Array.from(n);if(!i)return r.push(`No MIDI ${s}`),r;const l=i.find(({name:c})=>c===t);return console.log("port",l),l||r.push(`No MIDI ${s} named ${t} for ${e}`),r}function nt(e,t){const s=[],{input:r,output:n}=t;return r?s.push(...Q(e,r,"inputs")):s.push(`No MIDI input for ${e}`),n?s.push(...Q(e,n,"outputs")):s.push(`No MIDI output for ${e}`),s.length||r===n&&s.push(`Input and output are the same for ${e}`),s}function It(e,t){const s=[],{output:r,channel:n}=t;return r?s.push(...Q(e,r,"outputs")):s.push(`No MIDI output for ${e}`),n?(n<1||n>16)&&s.push(`Invalid MIDI channel for ${e}: ${n}`):s.push(`No MIDI channel for ${e}`),s}function Et(e){const t=[];if(e.type===void 0)return t.push("No transporter type"),t;if(!(e.type in p))return t.push(`Invalid transporter type: ${e.type}`),t;if(e.type===p.Midi){if(!E)return t.push("No MIDI access"),t;const{midi:s}=e;if(!s)return t.push("No MIDI config"),t;t.push(...nt("Transporter",s))}return t}function Pt(e,t){const s=[];if(t.type===void 0)return s.push(`No controller type for ${e} part`),s;if(!(t.type in d))return s.push(`Invalid controller type for ${e} part: ${t.type}`),s;if(t.type===d.Midi){if(!E)return s.push("No MIDI access"),s;const{midi:r}=t;if(!r)return s.push("No MIDI config"),s;s.push(...nt(`${e} controller`,r))}return s}function Ot(e,t){const s=[];if(t.type===void 0)return s.push(`No synthesizer type for ${e} part`),s;if(t.type in m||s.push(`Invalid synthesizer type for ${e} part: ${t.type}`),t.type===m.Midi){if(!E)return s.push("No MIDI access"),s;const{midi:r}=t;if(!r)return s.push("No MIDI config"),s;s.push(...It(`${e} synthesizer`,r))}return s}function Mt(e,t){const s=[],{controller:r,synthesizer:n}=t;return r?s.push(...Pt(e,r)):s.push(`No controller for ${e} part`),n?s.push(...Ot(e,n)):s.push(`No synthesizer for ${e} part`),s}function Dt(e){const t=[],s=["bass","drum","keys","lead"];for(const r of s){const n=e[r];if(!n){t.push(`No ${r} part`);continue}t.push(...Mt(r,n))}return t}function kt(e){const t=[],{transporter:s,parts:r}=e;return s?t.push(...Et(s)):t.push("No transporter"),r?t.push(...Dt(r)):t.push("No parts"),t}const Nt=[["DOM",p.Dom],["MIDI",p.Midi]],St=[["DOM",d.Dom],["MIDI",d.Midi]],Lt=[["DOM",m.Dom],["MIDI",m.Midi]],P={CONFIG_FORM_ID:"config-form",TRANSPORTER_CONFIG_ID:"transporter-config",PART_CONFIG_CLASS:"part-config",TYPE_DIV_CLASS:"type-div",MIDI_DIV_CLASS:"midi-div",MIDI_INPUT_SELECT_CLASS:"midi-input-select",MIDI_OUTPUT_SELECT_CLASS:"midi-output-select",REMEMBER_CHECKBOX_ID:"remember-config"};function Z(e,t){if(!e.div)throw new Error("setUpRadioButtons called before render");const s=Array.from(e.div.querySelectorAll('input[type="radio"]'));for(const r of s)for(const[n,i]of t)r.addEventListener("change",()=>{if(!i.div)throw new Error("setUpRadioButtons called before render");i.div.classList[Number(r.value)===n?"remove":"add"]("hidden")})}class tt{constructor(t,s,r){u(this,"name");u(this,"title");u(this,"typeNamesAndEnums");u(this,"inputs");u(this,"div");this.name=t,this.title=s,this.typeNamesAndEnums=r,this.inputs={},this.div=null}render(){const t=this.typeNamesAndEnums.map(([s,r])=>{const n=`${this.name}-${s}`,i=a("input",{id:n,type:"radio",name:this.name,value:r}),l=a("label",{for:n},s);return this.inputs[r]=i,[i,l]}).flat();return this.div=a("div",{class:P.TYPE_DIV_CLASS},this.title,...t)}getConfig(){if(!this.div)throw new Error("getConfig called before render");return Number(this.div.querySelector('input[type="radio"]:checked').value)}}class ot{constructor(){u(this,"inputSelect",null);u(this,"outputSelect",null);u(this,"div",null)}render(){const t=this.inputSelect=a("select",{class:P.MIDI_INPUT_SELECT_CLASS}),s=this.outputSelect=a("select",{class:P.MIDI_OUTPUT_SELECT_CLASS});return this.div=a("div",{},t," \u2192 Here \u2192 ",s)}getConfig(){if(!this.inputSelect||!this.outputSelect)throw new Error("getConfig called before render");return{input:this.inputSelect.value,output:this.outputSelect.value}}}class _t{constructor(){u(this,"select",null);u(this,"input",null);u(this,"div",null)}render(){const t=this.select=a("select",{class:P.MIDI_OUTPUT_SELECT_CLASS}),s=this.input=a("input",{type:"number",name:"channel",min:1,max:16,value:1});return this.div=a("div",{},t," on channel ",s)}getConfig(){if(!this.select||!this.input)throw new Error("getConfig called before render");return{output:this.select.value,channel:this.input.value}}}class Tt{constructor(){u(this,"typeConfig",new tt("transporter-type","Type: ",Nt));u(this,"midiConfig",new ot)}render(){const t=a("legend",{},"TRANSPORTER"),s=this.typeConfig.render(),r=this.midiConfig.render();return a("fieldset",{id:P.TRANSPORTER_CONFIG_ID},t,s,r)}setUp(){Z(this.typeConfig,[[p.Midi,this.midiConfig]])}getConfig(){const t={};return(t.type=this.typeConfig.getConfig())===p.Midi&&(t.midi=this.midiConfig.getConfig()),t}}class At{constructor(t){u(this,"typeConfig");u(this,"midiConfig",new ot);u(this,"div",null);this.typeConfig=new tt(`${t}-controller-type`,"Controller: ",St)}render(){const t=this.typeConfig.render(),s=this.midiConfig.render();return this.div=a("div",{},t,s)}setUp(){Z(this.typeConfig,[[d.Midi,this.midiConfig]])}getConfig(){const t={};return(t.type=this.typeConfig.getConfig())===d.Midi&&(t.midi=this.midiConfig.getConfig()),t}}class Rt{constructor(t){u(this,"typeConfig");u(this,"midiConfig",new _t);this.typeConfig=new tt(`${t}-synthesizer-type`,"Synthesizer: ",Lt)}render(){const t=this.typeConfig.render(),s=this.midiConfig.render();return a("div",{},t,s)}setUp(){Z(this.typeConfig,[[m.Midi,this.midiConfig]])}getConfig(){const t={};return(t.type=this.typeConfig.getConfig())===m.Midi&&(t.midi=this.midiConfig.getConfig()),t}}class q{constructor(t){u(this,"name");u(this,"controllerConfig");u(this,"synthesizerConfig");this.name=t,this.controllerConfig=new At(t),this.synthesizerConfig=new Rt(t)}render(){const t=a("legend",{},this.name.toUpperCase()),s=this.controllerConfig.render(),r=a("hr"),n=this.synthesizerConfig.render();return a("fieldset",{},t,s,r,n)}setUp(){this.controllerConfig.setUp(),this.synthesizerConfig.setUp()}getConfig(){return{controller:this.controllerConfig.getConfig(),synthesizer:this.synthesizerConfig.getConfig()}}}class $t{constructor(){u(this,"div",null)}render(){return this.div=a("div",{class:"problem-div"})}addProblems(t){if(!this.div)throw new Error("addProblems called before render");const s=this.div;s.innerHTML="";for(const r of t){const n=a("p",{},r);s.appendChild(n)}}}class Ut{constructor(){u(this,"refreshButton",null);u(this,"rememberCheckbox",null);u(this,"problemDiv",new $t)}render(){const t=this.refreshButton=a("button",{type:"button"},"Refresh MIDI Ports"),s=this.rememberCheckbox=a("input",{type:"checkbox",id:P.REMEMBER_CHECKBOX_ID}),r=a("label",{for:P.REMEMBER_CHECKBOX_ID},"Remember"),n=a("button",{type:"submit"},"Submit"),i=this.problemDiv.render();return a("div",{},t,s,r,n,i)}setUp(){}}class Ft{constructor(){u(this,"transporterConfig",new Tt);u(this,"partConfigs",{bass:new q("bass"),drum:new q("drum"),keys:new q("keys"),lead:new q("lead")});u(this,"miscellaneousDiv",new Ut);u(this,"form",null)}render(){const t=this.transporterConfig.render(),s=Object.values(this.partConfigs).map(n=>n.render()),r=this.miscellaneousDiv.render();return this.form=a("form",{id:P.CONFIG_FORM_ID},t,...s,r)}setUp(){if(!this.form)throw new Error("setUp called before render");this.transporterConfig.setUp();for(const t of Object.values(this.partConfigs))t.setUp();if(!this.miscellaneousDiv.refreshButton)throw new Error("setUp called before render");this.miscellaneousDiv.refreshButton.addEventListener("mousedown",this.refreshMidi.bind(this)),this.refreshMidi(),this.clickAllFirstRadioButtons(),this.form.classList.remove("hidden")}getConfig(){return{transporter:this.transporterConfig.getConfig(),parts:{bass:this.partConfigs.bass.getConfig(),drum:this.partConfigs.drum.getConfig(),keys:this.partConfigs.keys.getConfig(),lead:this.partConfigs.lead.getConfig()}}}refreshMidi(){if(!this.form)throw new Error("refreshMidi called before render");const t=Array.from(this.form.querySelectorAll('input[type="radio"][value="midi"]'));for(const r of t)r.disabled=!E;if(!E)return;function s(r,n){const i=document.getElementsByClassName(r),l=Array.from(E[n].values()).map(c=>c.name);for(const c of i){const g=c.value||l[0];c.innerHTML="";for(const b of l){const v=a("option",{value:b},b);c.appendChild(v)}l.includes(g)&&(c.value=g)}}s(P.MIDI_INPUT_SELECT_CLASS,"inputs"),s(P.MIDI_OUTPUT_SELECT_CLASS,"outputs")}clickAllFirstRadioButtons(){if(!this.form)throw new Error("clickAllFirstRadioButtons called before render");const t=Array.from(this.form.querySelectorAll('input[type="radio"]:enabled:first-of-type'));for(const s of t)s.click()}getPromise(){return new Promise(t=>{if(!this.form)throw new Error("getPromise called before render");this.form.addEventListener("submit",s=>{if(!this.form)throw new Error("submit event listener called after form was removed");s.preventDefault();const r=this.getConfig(),n=kt(r);this.miscellaneousDiv.problemDiv.addProblems(n),!n.length&&(this.form.remove(),t(r))})})}}async function xt(){const e=new Ft;return document.body.append(e.render()),e.setUp(),await e.getPromise()}const zt=async()=>await xt();function Bt(e){const t=a("h2"),s={previous:a("button",{class:"transporter-button"},"\u23EE"),play:a("button",{class:"transporter-button"},"\u25B6"),pause:a("button",{class:"transporter-button"},"\u23F8"),stop:a("button",{class:"transporter-button"},"\u23F9"),next:a("button",{class:"transporter-button"},"\u23ED")};e.connect=(i,l)=>{s.previous.addEventListener("click",()=>i.goPrevious()),s.next.addEventListener("click",()=>i.goNext()),s.play.addEventListener("click",()=>l.play()),s.pause.addEventListener("click",()=>l.pause()),s.stop.addEventListener("click",()=>l.stop())},e.changeChart=(i,l,c)=>{t.innerText=i,s.previous.disabled=!l,s.next.disabled=!c},e.changePlayback=i=>{s.play.disabled=i===f.Playing,s.pause.disabled=i!==f.Playing,s.stop.disabled=i===f.Stopped};const r=a("div",{},...Object.values(s)),n=a("div",{id:"transporter"},t,r);e.render=()=>n}class Gt{constructor(t){switch(t.type){case p.Dom:Bt(this);break;default:throw new Error(`Invalid Transporter type: ${t}`)}}connect(t,s){}changeChart(t,s,r){}changePlayback(t){}render(){return null}}function et(e){const t=e[0].toUpperCase(),s=parseInt(e[1]);if(isNaN(s))throw new Error(`Invalid pitch: ${e}`);const r={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[t];if(r===void 0)throw new Error(`Invalid pitch name: ${t}`);return 12*s+r}function K(e){return 6e4/e}function V(...e){return e.map(t=>({time:-1/0,type:C.Finish,part:t}))}function it(...e){const t={millisecondsPerBeat:K(120),position:0,bufferEvents:[]};return e.reduce((s,r)=>r(s),t).bufferEvents}function at(e){return t=>Object.assign({},t,{millisecondsPerBeat:K(e)})}function ct(e,t,s,r,n){const i=et(t);return l=>{const{millisecondsPerBeat:c,position:g}=l,b={time:s*c,type:C.NoteOn,part:e,pitch:i,velocity:n},v={time:(s+r)*c,type:C.NoteOff,part:e,pitch:i};return Object.assign({},l,{position:g+r,bufferEvents:[...l.bufferEvents,b,v]})}}function lt(e){return t=>{const{position:s,millisecondsPerBeat:r,bufferEvents:n}=t,i={time:s*r,type:C.Finish,part:e};return Object.assign({},t,{bufferEvents:[...n,i]})}}const jt={title:"Hello World",compose:({bass:e,drum:t,keys:s,lead:r})=>[...V(e,t,s),...it(at(60),ct(r,"C4",0,4,127),lt(r))]},Ht=["C2","D2","E2","F2","G2","A2","B2","C3"];function qt(e){return it(at(120),...Ht.map((t,s)=>ct(e,t,s,.9,127)),lt(e))}const Kt={title:"Bass Scale",compose:({bass:e,drum:t,keys:s,lead:r})=>[...V(t,s,r),...qt(e)]},ut=[["C4",0,1],["C4",1,1],["G4",2,1],["G4",3,1],["A4",4,1],["A4",5,1],["G4",6,2],["F4",8,1],["F4",9,1],["E4",10,1],["E4",11,1],["D4",12,1],["D4",13,1],["C4",14,2],["G4",16,1],["G4",17,1],["F4",18,1],["F4",19,1],["E4",20,1],["E4",21,1],["D4",22,2],["G4",24,1],["G4",25,1],["F4",26,1],["F4",27,1],["E4",28,1],["E4",29,1],["D4",30,2],["C4",32,1],["C4",33,1],["G4",34,1],["G4",35,1],["A4",36,1],["A4",37,1],["G4",38,2],["F4",40,1],["F4",41,1],["E4",42,1],["E4",43,1],["D4",44,1],["D4",45,1],["C4",46,2]];function Vt(e){const t=K(120),s=e.controller.getRangeControl("8va chance: ",0,100,"%");function r([b,v,st]){const J=Math.random()*100;return{time:(v-.1)*t,type:C.Compute,callback:ue=>{const he=s.value,Ct=et(b),bt=J<he?Ct+12:Ct,pe={time:v*t,type:C.NoteOn,part:e,pitch:bt,velocity:127},de={time:(v+st-.1)*t,type:C.NoteOff,part:e,pitch:bt};ue.unshift(pe,de)}}}const n=ut.map(r),[i,l,c]=ut.at(-1)??[0,0,0],g={time:(c+l+.1)*t,type:C.Finish,part:e};return[...n,g]}const Xt={title:"Twinkle Twinkle Little Star",compose:({bass:e,drum:t,keys:s,lead:r})=>[...V(e,t,s),...Vt(r)]},ht=["E3","G3","A3","G3","D4","C4","D4","E4"].map(et),pt=2,dt=pt/ht.length,X=K(165),Yt={title:"On the Run",compose:({bass:e,drum:t,keys:s,lead:r})=>{const n=r.controller.getOptionControl("Repeat again: ",["No","Yes"],"!");function i(c){const g=ht.map((v,st)=>{const J=c+st*dt;return[{time:J*X,type:C.NoteOn,part:r,pitch:v,velocity:127},{time:(J+dt-.05)*X,type:C.NoteOff,part:r,pitch:v}]}).flat(),b=l(c+pt);return[...g,b]}function l(c){return{time:(c-.1)*X,type:C.Compute,callback:g=>{n.value?g.push(...i(c)):g.push({time:c*X,type:C.Finish,part:r})}}}return[...V(e,t,s),l(0)]}},ft=[jt,Kt,Xt,Yt],mt=ft.length;class Wt{constructor(){y(this,O,0);y(this,T,()=>{})}goPrevious(){o(this,O)>0&&(h(this,O,o(this,O)-1),o(this,T).call(this))}goNext(){o(this,O)<mt-1&&(h(this,O,o(this,O)+1),o(this,T).call(this))}connect(t,s){h(this,T,()=>{const r=ft[o(this,O)],n=r.title,i=o(this,O)>0,l=o(this,O)<mt-1;t.changeChart(n,i,l),s.changeChart(r)})}start(){o(this,T).call(this)}}O=new WeakMap,T=new WeakMap;const gt=12,x={min:0,max:127,step:1,default:63};class Jt{constructor(){y(this,N);y(this,A);y(this,R,()=>{});y(this,$,()=>0);const t=a("span",{},"EMPTY");h(this,N,{0:a("span",{},"%%"),1:t,2:a("span",{},"%%")}),h(this,A,a("input",{type:"range",min:x.min,max:x.max,step:x.step,value:x.default})).addEventListener("input",()=>{o(this,R).call(this)})}clear(){h(this,$,()=>0),h(this,R,()=>{});const t=Object.values(o(this,N));for(const s of t)s.textContent=""}get value(){return o(this,$).call(this)}makeIntoRangeControl(t,s,r,n=""){const i=o(this,N),l=i[1],c=o(this,A);i[0].textContent=t,i[2].textContent=n;const g=h(this,$,()=>s+Math.round((r-s)*Number(c.value)/x.max));h(this,R,()=>{l.textContent=g().toString()})()}makeIntoOptionControl(t,s,r=""){const n=o(this,N),i=n[1],l=o(this,A);n[0].textContent=t,n[2].textContent=r;const c=h(this,$,()=>Math.round((s.length-1)*Number(l.value)/x.max));h(this,R,()=>{i.textContent=s[c()]})()}render(){const t=a("label",{class:"lcd"},...Object.values(o(this,N)));return a("div",{class:"controller-module"},t,o(this,A))}}N=new WeakMap,A=new WeakMap,R=new WeakMap,$=new WeakMap;function Qt(e){const t=Array.from({length:gt},()=>new Jt);let s=0;e.clear=()=>{t.forEach(n=>n.clear()),s=0};function r(){if(s>=gt)throw new Error("No more controllers available");const n=t[s];return s+=1,n}e.getRangeControl=(n,i,l,c="")=>{const g=r();return g.makeIntoRangeControl(n,i,l,c),g},e.getOptionControl=(n,i,l="")=>{const c=r();return c.makeIntoOptionControl(n,i,l),c},e.render=()=>{const n=a("h2",{class:"component-title"},"Controller"),i=t.map(c=>c.render()),l=a("div",{class:"controller-row"},...i);return n.addEventListener("click",()=>{l.classList.toggle("hidden")}),a("div",{class:"controller"},n,l)}}class Zt{constructor(t,s){switch(s.type){case d.Dom:Qt(this);break;default:throw new Error(`Invalid Controller type: ${s}`)}}clear(){}getRangeControl(t,s,r,n=""){return{value:0}}getOptionControl(t,s,r=""){return{value:0}}render(){return null}}function te(e){e.noteOn=(t,s,r)=>{console.log("noteOn",t,r,s)},e.noteOff=(t,s)=>{console.log("noteOff",t,s)},e.allNotesOff=()=>{console.log("allNotesOff")}}function ee(e){const t=a("h2",{class:"component-title"},"Synthesizer"),s=a("button",{},"Clear"),r=a("div",{class:"message-row"}),n=a("div",{class:"synthesizer-row"},s,r),i=a("div",{class:"synthesizer"},t,n);function l(c,g){const b=a("div",{class:g},c);r.appendChild(b),r.scrollTop=r.scrollHeight}e.noteOn=(c,g,b,v=!0)=>{v&&e.currentlyPlayingPitches.push(c),l(`noteOn ${c} ${g} ${b.toFixed(0)}`,"note-on")},e.noteOff=(c,g,b=!0)=>{l(`noteOff ${c} ${g.toFixed(0)}`,"note-off"),b&&(e.currentlyPlayingPitches=e.currentlyPlayingPitches.filter(v=>v!==c))},e.allNotesOff=()=>{l("allNotesOff","all-notes-off"),e.currentlyPlayingPitches=[]},s.addEventListener("click",()=>{r.innerHTML=""}),t.addEventListener("click",()=>{n.classList.toggle("hidden")}),e.render=()=>i}function se(e,t){if(!E)throw new Error("No MIDI access");const s=E.outputs.values().find(n=>n.name===t.midi.output);if(!s)throw new Error(`No MIDI output named ${t.midi.output}`);const r=t.midi.channel-1;e.noteOn=(n,i,l,c=!0)=>{c&&e.currentlyPlayingPitches.push(n),s.send([144+r,n,i],l)},e.noteOff=(n,i,l=!0)=>{s.send([128+r,n,0],i),l&&(e.currentlyPlayingPitches=e.currentlyPlayingPitches.filter(c=>c!==n))},e.allNotesOff=()=>{s.send([176+r,123,0]),e.currentlyPlayingPitches=[]}}class re{constructor(t,s){u(this,"currentlyPlayingPitches",[]);switch(s.type){case m.Log:te(this);break;case m.Dom:ee(this);break;case m.Midi:se(this,s);break}}noteOn(t,s,r,n=!0){}noteOff(t,s,r=!0){}allNotesOff(){}pause(){const t=window.performance.now();for(const s of this.currentlyPlayingPitches)this.noteOff(s,t,!1)}resume(){const t=window.performance.now();for(const s of this.currentlyPlayingPitches)this.noteOn(s,31,t,!1)}render(){return null}}class Y{constructor(t,s){y(this,B);u(this,"controller");u(this,"synthesizer");h(this,B,t),this.controller=new Zt(t,s.controller),this.synthesizer=new re(t,s.synthesizer)}render(){const t=a("h2",{},o(this,B).toUpperCase()),s=this.controller.render(),r=this.synthesizer.render();return s||r?a("div",{class:"part"},t,s,r):null}}B=new WeakMap;function ne(e){return{bass:new Y("bass",e.bass),drum:new Y("drum",e.drum),keys:new Y("keys",e.keys),lead:new Y("lead",e.lead)}}const W=100;function oe(){return new Worker(new URL(""+new URL("worker-Dukc8-Vk.js",import.meta.url).href,import.meta.url),{type:"module"})}class ie{constructor(t,s){y(this,H);y(this,G);y(this,S,oe());y(this,M);y(this,L,!1);y(this,_,[]);y(this,j,()=>{});y(this,U,0);y(this,F,0);y(this,z,new Set);h(this,G,t),h(this,M,ne(s)),o(this,S).onmessage=r=>this.schedule()}schedule(){const t=window.performance.now()+W;for(;o(this,L)&&o(this,H,rt)<t;){const s=o(this,H,rt),r=o(this,_).shift();if(r)switch(r.type){case C.Finish:o(this,z).add(r.part),o(this,z).size===4&&o(this,G).stop();break;case C.NoteOn:r.part.synthesizer.noteOn(r.pitch,r.velocity,s);break;case C.NoteOff:r.part.synthesizer.noteOff(r.pitch,s);break;case C.Compute:r.callback(o(this,_));break}}}changeChart(t){h(this,j,()=>{for(const s of Object.values(o(this,M)))s.controller.clear();h(this,_,t.compose(o(this,M)))})()}play(){h(this,L,!0),h(this,U,window.performance.now()+W),h(this,F,0),o(this,S).postMessage(0)}pause(){h(this,L,!1),o(this,S).postMessage(1),h(this,F,window.performance.now()-o(this,U)),setTimeout(()=>{for(const t of Object.values(o(this,M)))t.synthesizer.pause()},W*2)}resume(){h(this,L,!0),h(this,U,window.performance.now()-o(this,F)),o(this,S).postMessage(0);for(const t of Object.values(o(this,M)))t.synthesizer.resume()}stop(){h(this,L,!1),o(this,S).postMessage(1),h(this,F,0),o(this,z).clear(),o(this,j).call(this),setTimeout(()=>{for(const t of Object.values(o(this,M)))t.synthesizer.allNotesOff()},W*2)}render(){const t=Object.values(o(this,M)).map(s=>s.render());return t.some(s=>s!==null)?a("div",{id:"part-container"},...t):null}}G=new WeakMap,S=new WeakMap,M=new WeakMap,L=new WeakMap,_=new WeakMap,j=new WeakMap,U=new WeakMap,F=new WeakMap,z=new WeakMap,H=new WeakSet,rt=function(){return o(this,_).length===0?1/0:o(this,_)[0].time+o(this,U)};class ae{constructor(t){y(this,w,f.Paused);y(this,k,()=>{});y(this,D);console.debug("Playbacker",t),h(this,D,new ie(this,t))}changeChart(t){console.debug("changeChart",t),o(this,D).changeChart(t),o(this,w)!=f.Stopped&&this.stop()}play(){switch(o(this,w)){case f.Playing:console.debug("already playing");break;case f.Paused:console.debug("resume"),o(this,k).call(this,I.Resume),h(this,w,f.Playing);break;case f.Stopped:console.debug("play"),o(this,k).call(this,I.Play),h(this,w,f.Playing);break}}pause(){switch(o(this,w)){case f.Playing:console.debug("pause"),o(this,k).call(this,I.Pause),h(this,w,f.Paused);break;case f.Paused:console.debug("already paused");break;case f.Stopped:console.debug("already stopped");break}}stop(){switch(o(this,w)){case f.Playing:console.debug("stop"),o(this,k).call(this,I.Stop),h(this,w,f.Stopped);break;case f.Paused:console.debug("stop"),o(this,k).call(this,I.Stop),h(this,w,f.Stopped);break;case f.Stopped:console.debug("already stopped");break}}connect(t){h(this,k,s=>{switch(s){case I.Play:o(this,D).play(),t.changePlayback(f.Playing);break;case I.Pause:o(this,D).pause(),t.changePlayback(f.Paused);break;case I.Resume:o(this,D).resume(),t.changePlayback(f.Playing);break;case I.Stop:o(this,D).stop(),t.changePlayback(f.Stopped);break}})}render(){return o(this,D).render()}}w=new WeakMap,k=new WeakMap,D=new WeakMap;function yt(e){e&&document.body.append(e)}function ce(e){const t=new Gt(e.transporter),s=new Wt,r=new ae(e.parts);t.connect(s,r),s.connect(t,r),r.connect(t);const n=t.render(),i=r.render();yt(n),yt(i),s.start()}const le=await zt();ce(le)})();
</script>
  <style rel="stylesheet" crossorigin>:root{--red: #b23535;--green: #38ad5f;--blue: #464ca5;--white: #eeeade;--black: #282828;--text-color: var(--black);--background-color: var(--white)}@media (prefers-color-scheme: dark){:root{--text-color: var(--white);--background-color: var(--black)}}*{color:inherit;background-color:inherit;border-color:inherit;font-family:inherit;box-sizing:inherit}body{min-height:100vh;font-family:Arial,sans-serif;color:var(--text-color);background-color:var(--background-color);border-color:var(--text-color);box-sizing:border-box;padding:0;margin:0}#config-form{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}fieldset{margin-bottom:20px}legend{font-weight:700;margin-bottom:10px}.type-div{margin-bottom:10px}label{-webkit-user-select:none;user-select:none}input[type=radio]:disabled+label{text-decoration:line-through}button{color:var(--text-color);background-color:var(--background-color);border:1px solid var(--text-color);cursor:pointer;transition:background-color .3s ease}button:hover{background-color:var(--text-color);color:var(--background-color)}.transporter-button{width:2em;height:2em;border:1.5px solid;border-radius:50%;font-size:2.5rem;padding:1rem;margin:0 .5rem 2rem;cursor:pointer;color:var(--background-color);background-color:var(--text-color);transition:transform .2s}.transporter-button:hover:enabled{transform:scale(1.1)}.transporter-button:disabled{color:var(--text-color);background-color:var(--background-color);cursor:auto}#transporter{text-align:center;border-bottom:1px solid var(--text-color)}.lcd{padding:.5em 1em;border-radius:5px;width:16ch;min-height:4em;line-height:1.5;text-align:left;font-family:hd44780,monospace;color:var(--background-color);background-color:var(--text-color)}input[type=range]{margin-top:1em;width:100%}.controller-module{padding:1em;display:flex;flex-direction:column;align-items:center;border:1px solid;font-size:1vw}.component-title{margin-top:0;margin-bottom:0;width:100%;height:3rem;line-height:3rem;cursor:pointer;-webkit-user-select:none;user-select:none}.controller-row{border-top:1px solid;justify-content:center;align-items:center;overflow-y:scroll;height:40vw}.controller{padding-top:0;border:1px solid}.note-on{color:var(--green)}.note-off{color:var(--red)}.all-notes-off{color:var(--blue)}.message-row{width:100%;height:10vw;overflow-y:scroll}.synthesizer-row{width:100%}.synthesizer{display:flex;flex-direction:column;align-items:center;width:100%;border:1px solid}.part{text-align:center;border:1px solid;min-width:20%}#part-container{display:flex;flex-wrap:wrap;justify-content:space-around;align-items:start}.hidden{display:none}
</style>
</head>

<body>
</body>

</html>