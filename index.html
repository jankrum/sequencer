<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vite + TS</title>
  <script type="module" crossorigin>var De=Object.defineProperty;var ne=d=>{throw TypeError(d)};var Se=(d,p,u)=>p in d?De(d,p,{enumerable:!0,configurable:!0,writable:!0,value:u}):d[p]=u;var G=(d,p,u)=>Se(d,typeof p!="symbol"?p+"":p,u),oe=(d,p,u)=>p.has(d)||ne("Cannot "+u);var o=(d,p,u)=>(oe(d,p,"read from private field"),u?u.call(d):p.get(d)),m=(d,p,u)=>p.has(d)?ne("Cannot add the same private member more than once"):p instanceof WeakSet?p.add(d):p.set(d,u),a=(d,p,u,h)=>(oe(d,p,"write to private field"),h?h.call(d,u):p.set(d,u),u);(async()=>{var w,D,P,S,M,x,j,F,C,N,L,E,$,I,z,A,R,U,J,b,O,v;(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();var d=(e=>(e[e.Dom=0]="Dom",e[e.Midi=1]="Midi",e))(d||{}),p=(e=>(e[e.Dom=0]="Dom",e[e.Midi=1]="Midi",e))(p||{}),u=(e=>(e[e.Log=0]="Log",e[e.Dom=1]="Dom",e[e.Midi=2]="Midi",e))(u||{}),h=(e=>(e[e.Playing=0]="Playing",e[e.Paused=1]="Paused",e[e.Stopped=2]="Stopped",e))(h||{}),k=(e=>(e[e.Play=0]="Play",e[e.Pause=1]="Pause",e[e.Resume=2]="Resume",e[e.Stop=3]="Stop",e))(k||{}),y=(e=>(e[e.Tempo=0]="Tempo",e[e.Finish=1]="Finish",e[e.NoteOn=2]="NoteOn",e[e.NoteOff=3]="NoteOff",e))(y||{});const re=async()=>({parts:{bass:{controller:{type:p.Dom},synthesizer:{type:u.Midi,midi:{output:"loopMIDI Port",channel:1}}},drum:{controller:{type:p.Dom},synthesizer:{type:u.Dom}},keys:{controller:{type:p.Dom},synthesizer:{type:u.Dom}},lead:{controller:{type:p.Dom},synthesizer:{type:u.Midi,midi:{output:"loopMIDI Port",channel:2}}}},transporter:{type:d.Dom}});function l(e,t={},...s){const n=document.createElement(e);for(const[r,i]of Object.entries(t))n.setAttribute(r,i);for(const r of s)typeof r=="string"?n.appendChild(document.createTextNode(r)):r&&n.appendChild(r);return n}function ie(e){const t=l("h2"),s={previous:l("button",{class:"transporter-button"},"\u23EE"),play:l("button",{class:"transporter-button"},"\u25B6"),pause:l("button",{class:"transporter-button"},"\u23F8"),stop:l("button",{class:"transporter-button"},"\u23F9"),next:l("button",{class:"transporter-button"},"\u23ED")};e.connect=(i,c)=>{s.previous.addEventListener("click",()=>i.goPrevious()),s.next.addEventListener("click",()=>i.goNext()),s.play.addEventListener("click",()=>c.play()),s.pause.addEventListener("click",()=>c.pause()),s.stop.addEventListener("click",()=>c.stop())},e.changeChart=(i,c,f)=>{t.innerText=i,s.previous.disabled=!c,s.next.disabled=!f},e.changePlayback=i=>{s.play.disabled=i===h.Playing,s.pause.disabled=i!==h.Playing,s.stop.disabled=i===h.Stopped};const n=l("div",{},...Object.values(s)),r=l("div",{id:"transporter"},t,n);e.render=()=>r}class ae{constructor(t){switch(t.type){case d.Dom:ie(this);break;default:throw new Error(`Invalid Transporter type: ${t}`)}}connect(t,s){}changeChart(t,s,n){}changePlayback(t){}render(){return null}}function K(e){return{position:-1/0,type:y.Tempo,bpm:e}}function V(...e){return e.map(t=>({position:-1/0,part:t,type:y.Finish}))}const Q=[0,2,4,5,7,9,11,12];function ce(e){return Q.map(t=>t+24).map((t,s)=>[{position:s,part:e,type:y.NoteOn,pitch:t},{position:s+.9,part:e,type:y.NoteOff,pitch:t}]).flat()}const le={title:"Bass Scale",compose:({bass:e,drum:t,keys:s,lead:n})=>[K(120),...V(t,s,n),...ce(e),{position:Q.length,type:y.Finish,part:e}]},X=[0,2,4,5,7,9,11,12];function pe(e){return X.map(t=>t+48).map((t,s)=>[{position:s,part:e,type:y.NoteOn,pitch:t},{position:s+.9,part:e,type:y.NoteOff,pitch:t}]).flat()}const he={title:"Lead Scale",compose:({bass:e,drum:t,keys:s,lead:n})=>[K(120),...V(e,t,s),...pe(n),{position:X.length,type:y.Finish,part:n}]},de={title:"Twinkle Twinkle Little Star",compose:({bass:e,drum:t,keys:s,lead:n})=>{const r=(()=>{const c=[[0,1,0],[0,1,0],[7,1,0],[7,1,0],[9,1,0],[9,1,0],[7,2,0],[5,1,0],[5,1,0],[4,1,0],[4,1,0],[2,1,0],[2,1,0],[0,2,0]],f=[[7,1,0],[7,1,0],[5,1,0],[5,1,0],[4,1,0],[4,1,0],[2,2,0]],g=[...c,...f,...f,...c];let H=0;const q=[];for(const Y of g)q.push([Y[0]+48,Y[1],H]),H+=Y[1];return q})();function i(c,f){return[...f.map(([g,H,q])=>[{position:q,part:c,type:y.NoteOn,pitch:g},{position:q+H-.1,part:c,type:y.NoteOff,pitch:g}]).flat(),{position:(f.at(-1)??[0,0,0])[2]+.1,type:y.Finish,part:c}]}return[K(120),...V(e,t,s),...i(n,r)]}},Z=[le,he,de],_=Z.length;class ue{constructor(){m(this,w,0);m(this,D,()=>{})}goPrevious(){o(this,w)>0&&(a(this,w,o(this,w)-1),o(this,D).call(this))}goNext(){o(this,w)<_-1&&(a(this,w,o(this,w)+1),o(this,D).call(this))}connect(t,s){a(this,D,()=>{const n=Z[o(this,w)],r=n.title,i=o(this,w)>0,c=o(this,w)<_-1;t.changeChart(r,i,c),s.changeChart(n)})}start(){o(this,D).call(this)}}w=new WeakMap,D=new WeakMap;const ee=12,T={min:0,max:127,step:1,default:63};class fe{constructor(){m(this,P);m(this,S);m(this,M,()=>{});m(this,x,()=>0);const t=l("span",{},"EMPTY");a(this,P,{0:l("span",{},"%%"),1:t,2:l("span",{},"%%")}),a(this,S,l("input",{type:"range",min:T.min,max:T.max,step:T.step,value:T.default})).addEventListener("input",()=>{o(this,M).call(this)})}clear(){a(this,x,()=>0),a(this,M,()=>{});const t=Object.values(o(this,P));for(const s of t)s.textContent=""}get value(){return o(this,x).call(this)}makeIntoRangeControl(t,s,n,r=""){const i=o(this,P),c=i[1],f=o(this,S);i[0].textContent=t,i[2].textContent=r;const g=a(this,x,()=>s+(n-s)*Number(f.value)/T.max);a(this,M,()=>{c.textContent=g().toString()})}makeIntoOptionControl(t,s,n=""){const r=o(this,P),i=r[1],c=o(this,S);r[0].textContent=t,r[2].textContent=n;const f=a(this,x,()=>s.length*Number(c.value)/T.max);a(this,M,()=>{i.textContent=s[f()]})}render(){const t=l("label",{class:"lcd"},...Object.values(o(this,P)));return l("div",{class:"controller-module"},t,o(this,S))}}P=new WeakMap,S=new WeakMap,M=new WeakMap,x=new WeakMap;function me(e){const t=Array.from({length:ee},()=>new fe);let s=0;e.clear=()=>{t.forEach(r=>r.clear()),s=0};function n(){if(s>=ee)throw new Error("No more controllers available");const r=t[s];return s+=1,r}e.getRangeControl=(r,i,c,f="")=>{const g=n();return g.makeIntoRangeControl(r,i,c,f),g},e.getOptionControl=(r,i,c="")=>{const f=n();return f.makeIntoOptionControl(r,i,c),f},e.render=()=>{const r=l("h2",{class:"component-title"},"Controller"),i=t.map(f=>f.render()),c=l("div",{class:"controller-row"},...i);return r.addEventListener("click",()=>{c.classList.toggle("hidden")}),l("div",{class:"controller"},r,c)}}class ye{constructor(t,s){switch(s.type){case p.Dom:me(this);break;default:throw new Error(`Invalid Controller type: ${s}`)}}clear(){}getRangeControl(t,s,n,r=""){return{value:0}}getOptionControl(t,s,n=""){return{value:0}}render(){return null}}const te=await navigator.requestMIDIAccess({sysex:!0}).catch(()=>null);function ge(e){e.noteOn=(t,s)=>{console.log("noteOn",t,s)},e.noteOff=(t,s)=>{console.log("noteOff",t,s)},e.allNotesOff=()=>{console.log("allNotesOff")}}function be(e){const t=l("h2",{class:"component-title"},"Synthesizer"),s=l("button",{},"Clear"),n=l("div",{class:"message-row"}),r=l("div",{class:"synthesizer-row"},s,n),i=l("div",{class:"synthesizer"},t,r);e.noteOn=(c,f)=>{const g=l("div",{class:"note-on"},`noteOn ${c} ${f}`);n.appendChild(g)},e.noteOff=(c,f)=>{const g=l("div",{class:"note-off"},`noteOff ${c} ${f}`);n.appendChild(g)},e.allNotesOff=()=>{const c=l("div",{class:"all-notes-off"},"allNotesOff");n.appendChild(c)},s.addEventListener("click",()=>{n.innerHTML=""}),t.addEventListener("click",()=>{r.classList.toggle("hidden")}),e.render=()=>i}function ke(e,t){if(!te)throw new Error("No MIDI access");const s=te.outputs.values().find(r=>r.name===t.midi.output);if(!s)throw new Error(`No MIDI output named ${t.midi.output}`);const n=t.midi.channel-1;e.noteOn=(r,i)=>{s.send([144+n,r,127],i)},e.noteOff=(r,i)=>{s.send([128+n,r,0],i)},e.allNotesOff=()=>{s.send([176+n,123,0])}}class we{constructor(t,s){switch(s.type){case u.Log:ge(this);break;case u.Dom:be(this);break;case u.Midi:ke(this,s);break}}noteOn(t,s){}noteOff(t,s){}allNotesOff(){}render(){return null}}class B{constructor(t,s){m(this,j);G(this,"controller");G(this,"synthesizer");a(this,j,t),this.controller=new ye(t,s.controller),this.synthesizer=new we(t,s.synthesizer)}render(){const t=l("h2",{},o(this,j).toUpperCase()),s=this.controller.render(),n=this.synthesizer.render();return s||n?l("div",{class:"part"},t,s,n):null}}j=new WeakMap;function ve(e){return{bass:new B("bass",e.bass),drum:new B("drum",e.drum),keys:new B("keys",e.keys),lead:new B("lead",e.lead)}}const W=100;function Oe(){return new Worker(new URL(""+new URL("worker-Dukc8-Vk.js",import.meta.url).href,import.meta.url),{type:"module"})}class Pe{constructor(t,s){m(this,U);m(this,F);m(this,C,Oe());m(this,N);m(this,L,!1);m(this,E,[]);m(this,$,()=>{});m(this,I,0);m(this,z,0);m(this,A,6e4/120);m(this,R,new Set);a(this,F,t),a(this,N,ve(s)),o(this,C).onmessage=n=>this.schedule()}schedule(){const t=window.performance.now()+W;for(;o(this,L)&&o(this,U,J)<t;){const s=o(this,U,J),n=o(this,E).shift();if(n)switch(n.type){case y.Tempo:a(this,A,6e4/n.bpm);break;case y.Finish:o(this,R).add(n.part),o(this,R).size===4&&o(this,F).stop();break;case y.NoteOn:n.part.synthesizer.noteOn(n.pitch,s);break;case y.NoteOff:n.part.synthesizer.noteOff(n.pitch,s);break}}}changeChart(t){a(this,$,()=>{for(const s of Object.values(o(this,N)))s.controller.clear();a(this,E,t.compose(o(this,N)))})()}play(){a(this,L,!0),a(this,I,window.performance.now()+W),a(this,z,0),o(this,C).postMessage(0)}pause(){a(this,L,!1),o(this,C).postMessage(1),a(this,z,window.performance.now()-o(this,I))}resume(){a(this,L,!0),a(this,I,window.performance.now()-o(this,z)),o(this,C).postMessage(0)}stop(){a(this,L,!1),o(this,C).postMessage(1),a(this,z,0),o(this,R).clear(),o(this,$).call(this),setTimeout(()=>{for(const t of Object.values(o(this,N)))t.synthesizer.allNotesOff()},W)}render(){const t=Object.values(o(this,N)).map(s=>s.render());return t.some(s=>s!==null)?l("div",{id:"part-container"},...t):null}}F=new WeakMap,C=new WeakMap,N=new WeakMap,L=new WeakMap,E=new WeakMap,$=new WeakMap,I=new WeakMap,z=new WeakMap,A=new WeakMap,R=new WeakMap,U=new WeakSet,J=function(){return o(this,E).length===0?1/0:o(this,E)[0].position*o(this,A)+o(this,I)};class Ce{constructor(t){m(this,b,h.Paused);m(this,O,()=>{});m(this,v);console.debug("Playbacker",t),a(this,v,new Pe(this,t))}changeChart(t){console.debug("changeChart",t),o(this,v).changeChart(t),o(this,b)!=h.Stopped&&this.stop()}play(){switch(o(this,b)){case h.Playing:console.debug("already playing");break;case h.Paused:console.debug("resume"),o(this,O).call(this,k.Resume),a(this,b,h.Playing);break;case h.Stopped:console.debug("play"),o(this,O).call(this,k.Play),a(this,b,h.Playing);break}}pause(){switch(o(this,b)){case h.Playing:console.debug("pause"),o(this,O).call(this,k.Pause),a(this,b,h.Paused);break;case h.Paused:console.debug("already paused");break;case h.Stopped:console.debug("already stopped");break}}stop(){switch(o(this,b)){case h.Playing:console.debug("stop"),o(this,O).call(this,k.Stop),a(this,b,h.Stopped);break;case h.Paused:console.debug("stop"),o(this,O).call(this,k.Stop),a(this,b,h.Stopped);break;case h.Stopped:console.debug("already stopped");break}}connect(t){a(this,O,s=>{switch(s){case k.Play:o(this,v).play(),t.changePlayback(h.Playing);break;case k.Pause:o(this,v).pause(),t.changePlayback(h.Paused);break;case k.Resume:o(this,v).resume(),t.changePlayback(h.Playing);break;case k.Stop:o(this,v).stop(),t.changePlayback(h.Stopped);break}})}render(){return o(this,v).render()}}b=new WeakMap,O=new WeakMap,v=new WeakMap;function se(e){e&&document.body.append(e)}function Ne(e){const t=new ae(e.transporter),s=new ue,n=new Ce(e.parts);t.connect(s,n),s.connect(t,n),n.connect(t);const r=t.render(),i=n.render();se(r),se(i),s.start()}const Le=await re();Ne(Le)})();
</script>
  <style rel="stylesheet" crossorigin>:root{--red: #b23535;--green: #38ad5f;--blue: #464ca5;--white: #eeeade;--black: #282828;--text-color: var(--black);--background-color: var(--white)}@media (prefers-color-scheme: dark){:root{--text-color: var(--white);--background-color: var(--black)}}*{color:inherit;background-color:inherit;border-color:inherit;font-family:inherit;box-sizing:inherit}body{min-height:100vh;font-family:Arial,sans-serif;color:var(--text-color);background-color:var(--background-color);border-color:var(--text-color);box-sizing:border-box;padding:0;margin:0}button{color:var(--text-color);background-color:var(--background-color);border:1px solid var(--text-color);cursor:pointer;transition:background-color .3s ease}button:hover{background-color:var(--text-color);color:var(--background-color)}.transporter-button{width:2em;height:2em;border:1.5px solid;border-radius:50%;font-size:2.5rem;padding:1rem;margin:0 .5rem 2rem;cursor:pointer;color:var(--background-color);background-color:var(--text-color);transition:transform .2s}.transporter-button:hover:enabled{transform:scale(1.1)}.transporter-button:disabled{color:var(--text-color);background-color:var(--background-color);cursor:auto}#transporter{text-align:center;border-bottom:1px solid var(--text-color)}.lcd{padding:.5em 1em;border-radius:5px;width:16ch;min-height:4em;line-height:1.5;text-align:left;font-family:hd44780,monospace;color:var(--background-color);background-color:var(--text-color)}input[type=range]{margin-top:1em;width:100%}.controller-module{padding:1em;display:flex;flex-direction:column;align-items:center;border:1px solid;font-size:1vw}.component-title{margin-top:0;margin-bottom:0;width:100%;height:3rem;line-height:3rem;cursor:pointer;-webkit-user-select:none;user-select:none}.controller-row{border-top:1px solid;justify-content:center;align-items:center;overflow-y:scroll;height:40vw}.controller{padding-top:0;border:1px solid}.note-on{color:var(--green)}.note-off{color:var(--red)}.all-notes-off{color:var(--blue)}.message-row{width:100%;height:10vw;overflow-y:scroll}.synthesizer-row{width:100%}.synthesizer{display:flex;flex-direction:column;align-items:center;width:100%;border:1px solid}.part{text-align:center;border:1px solid;min-width:20%}#part-container{display:flex;flex-wrap:wrap;justify-content:space-around;align-items:start}.hidden{display:none}
</style>
</head>

<body>
</body>

</html>