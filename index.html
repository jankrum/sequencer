<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sequencer</title>
  <script type="module" crossorigin>var ve=Object.defineProperty;var bt=p=>{throw TypeError(p)};var we=(p,h,m)=>h in p?ve(p,h,{enumerable:!0,configurable:!0,writable:!0,value:m}):p[h]=m;var u=(p,h,m)=>we(p,typeof h!="symbol"?h+"":h,m),vt=(p,h,m)=>h.has(p)||bt("Cannot "+m);var a=(p,h,m)=>(vt(p,h,"read from private field"),m?m.call(p):h.get(p)),g=(p,h,m)=>h.has(p)?bt("Cannot add the same private member more than once"):h instanceof WeakSet?h.add(p):h.set(p,m),d=(p,h,m,f)=>(vt(p,h,"write to private field"),f?f.call(p,m):h.set(p,m),m);(async()=>{var P,L,N,F,_,$,V,K,A,O,S,q,Y,j,G,B,X,at,w,x,M;(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))e(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&e(r)}).observe(document,{childList:!0,subtree:!0});function t(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function e(o){if(o.ep)return;o.ep=!0;const i=t(o);fetch(o.href,i)}})();var p=(n=>(n[n.Dom=0]="Dom",n[n.Midi=1]="Midi",n))(p||{}),h=(n=>(n[n.Dom=0]="Dom",n[n.Midi=1]="Midi",n))(h||{}),m=(n=>(n[n.Log=0]="Log",n[n.Dom=1]="Dom",n[n.Midi=2]="Midi",n))(m||{}),f=(n=>(n[n.Playing=0]="Playing",n[n.Paused=1]="Paused",n[n.Stopped=2]="Stopped",n))(f||{}),E=(n=>(n[n.Play=0]="Play",n[n.Pause=1]="Pause",n[n.Resume=2]="Resume",n[n.Stop=3]="Stop",n))(E||{}),v=(n=>(n[n.Finish=0]="Finish",n[n.NoteOn=1]="NoteOn",n[n.NoteOff=2]="NoteOff",n[n.Compute=3]="Compute",n))(v||{});function c(n,t={},...e){const o=document.createElement(n);for(const[i,r]of Object.entries(t))o.setAttribute(i,r);for(const i of e)typeof i=="string"?o.appendChild(document.createTextNode(i)):i&&o.appendChild(i);return o}const I=await navigator.requestMIDIAccess({sysex:!0}).catch(()=>null);function et(n,t,e){const o=[];if(!I)return o.push(`The ${n} cannot be type MIDI without MIDI access`),o;const i=I[e].values(),r=Array.from(i);if(!r)return o.push(`No MIDI ${e}`),o;const s=r.find(({name:l})=>l===t);return console.log("port",s),s||o.push(`No MIDI ${e} named ${t} for ${n}`),o}function ct(n,t){const e=[],{input:o,output:i}=t;return o?e.push(...et(n,o,"inputs")):e.push(`No MIDI input for ${n}`),i?e.push(...et(n,i,"outputs")):e.push(`No MIDI output for ${n}`),e.length||o===i&&e.push(`Input and output are the same for ${n}`),e}function wt(n,t){const e=[],{output:o,channel:i}=t;return o?e.push(...et(n,o,"outputs")):e.push(`No MIDI output for ${n}`),i?(i<1||i>16)&&e.push(`Invalid MIDI channel for ${n}: ${i}`):e.push(`No MIDI channel for ${n}`),e}function Et(n){const t=[];if(n.type===void 0)return t.push("No transporter type"),t;if(!(n.type in p))return t.push(`Invalid transporter type: ${n.type}`),t;if(n.type===p.Midi){if(!I)return t.push("No MIDI access"),t;const{midi:e}=n;if(!e)return t.push("No MIDI config"),t;t.push(...ct("Transporter",e))}return t}function It(n,t){const e=[];if(t.type===void 0)return e.push(`No controller type for ${n} part`),e;if(!(t.type in h))return e.push(`Invalid controller type for ${n} part: ${t.type}`),e;if(t.type===h.Midi){if(!I)return e.push("No MIDI access"),e;const{midi:o}=t;if(!o)return e.push("No MIDI config"),e;e.push(...ct(`${n} controller`,o))}return e}function Dt(n,t){const e=[];if(t.type===void 0)return e.push(`No synthesizer type for ${n} part`),e;if(t.type in m||e.push(`Invalid synthesizer type for ${n} part: ${t.type}`),t.type===m.Midi){if(!I)return e.push("No MIDI access"),e;const{midi:o}=t;if(!o)return e.push("No MIDI config"),e;e.push(...wt(`${n} synthesizer`,o))}return e}function Pt(n,t){const e=[],{controller:o,synthesizer:i}=t;return o?e.push(...It(n,o)):e.push(`No controller for ${n} part`),i?e.push(...Dt(n,i)):e.push(`No synthesizer for ${n} part`),e}function Ot(n){const t=[],e=["bass","drum","keys","lead"];for(const o of e){const i=n[o];if(!i){t.push(`No ${o} part`);continue}t.push(...Pt(o,i))}return t}function Mt(n){const t=[],{transporter:e,parts:o}=n;return e?t.push(...Et(e)):t.push("No transporter"),o?t.push(...Ot(o)):t.push("No parts"),t}const kt=[["DOM",p.Dom],["MIDI",p.Midi]],xt=[["DOM",h.Dom],["MIDI",h.Midi]],Nt=[["DOM",m.Dom],["MIDI",m.Midi]],D={CONFIG_FORM_ID:"config-form",TRANSPORTER_CONFIG_ID:"transporter-config",PART_CONFIG_CLASS:"part-config",TYPE_DIV_CLASS:"type-div",MIDI_DIV_CLASS:"midi-div",MIDI_INPUT_SELECT_CLASS:"midi-input-select",MIDI_OUTPUT_SELECT_CLASS:"midi-output-select",REMEMBER_CHECKBOX_ID:"remember-config"};function nt(n,t){if(!n.div)throw new Error("setUpRadioButtons called before render");const e=Array.from(n.div.querySelectorAll('input[type="radio"]'));for(const o of e)for(const[i,r]of t)o.addEventListener("change",()=>{if(!r.div)throw new Error("setUpRadioButtons called before render");r.div.classList[Number(o.value)===i?"remove":"add"]("hidden")})}class ot{constructor(t,e,o){u(this,"name");u(this,"title");u(this,"typeNamesAndEnums");u(this,"inputs");u(this,"div");this.name=t,this.title=e,this.typeNamesAndEnums=o,this.inputs={},this.div=null}render(){const t=this.typeNamesAndEnums.map(([e,o])=>{const i=`${this.name}-${e}`,r=c("input",{id:i,type:"radio",name:this.name,value:o}),s=c("label",{for:i},e);return this.inputs[o]=r,[r,s]}).flat();return this.div=c("div",{class:D.TYPE_DIV_CLASS},this.title,...t)}getConfig(){if(!this.div)throw new Error("getConfig called before render");return Number(this.div.querySelector('input[type="radio"]:checked').value)}}class lt{constructor(){u(this,"inputSelect",null);u(this,"outputSelect",null);u(this,"div",null)}render(){const t=this.inputSelect=c("select",{class:D.MIDI_INPUT_SELECT_CLASS}),e=this.outputSelect=c("select",{class:D.MIDI_OUTPUT_SELECT_CLASS});return this.div=c("div",{},t," \u2192 Here \u2192 ",e)}getConfig(){if(!this.inputSelect||!this.outputSelect)throw new Error("getConfig called before render");return{input:this.inputSelect.value,output:this.outputSelect.value}}}class At{constructor(){u(this,"select",null);u(this,"input",null);u(this,"div",null)}render(){const t=this.select=c("select",{class:D.MIDI_OUTPUT_SELECT_CLASS}),e=this.input=c("input",{type:"number",name:"channel",min:1,max:16,value:1});return this.div=c("div",{},t," on channel ",e)}getConfig(){if(!this.select||!this.input)throw new Error("getConfig called before render");return{output:this.select.value,channel:this.input.value}}}class St{constructor(){u(this,"typeConfig",new ot("transporter-type","Type: ",kt));u(this,"midiConfig",new lt)}render(){const t=c("legend",{},"TRANSPORTER"),e=this.typeConfig.render(),o=this.midiConfig.render();return c("fieldset",{id:D.TRANSPORTER_CONFIG_ID},t,e,o)}setUp(){nt(this.typeConfig,[[p.Midi,this.midiConfig]])}getConfig(){const t={};return(t.type=this.typeConfig.getConfig())===p.Midi&&(t.midi=this.midiConfig.getConfig()),t}}class qt{constructor(t){u(this,"typeConfig");u(this,"midiConfig",new lt);u(this,"div",null);this.typeConfig=new ot(`${t}-controller-type`,"Controller: ",xt)}render(){const t=this.typeConfig.render(),e=this.midiConfig.render();return this.div=c("div",{},t,e)}setUp(){nt(this.typeConfig,[[h.Midi,this.midiConfig]])}getConfig(){const t={};return(t.type=this.typeConfig.getConfig())===h.Midi&&(t.midi=this.midiConfig.getConfig()),t}}class Lt{constructor(t){u(this,"typeConfig");u(this,"midiConfig",new At);this.typeConfig=new ot(`${t}-synthesizer-type`,"Synthesizer: ",Nt)}render(){const t=this.typeConfig.render(),e=this.midiConfig.render();return c("div",{},t,e)}setUp(){nt(this.typeConfig,[[m.Midi,this.midiConfig]])}getConfig(){const t={};return(t.type=this.typeConfig.getConfig())===m.Midi&&(t.midi=this.midiConfig.getConfig()),t}}class W{constructor(t){u(this,"name");u(this,"controllerConfig");u(this,"synthesizerConfig");this.name=t,this.controllerConfig=new qt(t),this.synthesizerConfig=new Lt(t)}render(){const t=c("legend",{},this.name.toUpperCase()),e=this.controllerConfig.render(),o=c("hr"),i=this.synthesizerConfig.render();return c("fieldset",{},t,e,o,i)}setUp(){this.controllerConfig.setUp(),this.synthesizerConfig.setUp()}getConfig(){return{controller:this.controllerConfig.getConfig(),synthesizer:this.synthesizerConfig.getConfig()}}}class Ft{constructor(){u(this,"div",null)}render(){return this.div=c("div",{class:"problem-div"})}addProblems(t){if(!this.div)throw new Error("addProblems called before render");const e=this.div;e.innerHTML="";for(const o of t){const i=c("p",{},o);e.appendChild(i)}}}class _t{constructor(){u(this,"refreshButton",null);u(this,"rememberCheckbox",null);u(this,"problemDiv",new Ft)}render(){const t=this.refreshButton=c("button",{type:"button"},"Refresh MIDI Ports"),e=this.rememberCheckbox=c("input",{type:"checkbox",id:D.REMEMBER_CHECKBOX_ID}),o=c("label",{for:D.REMEMBER_CHECKBOX_ID},"Remember"),i=c("button",{type:"submit"},"Submit"),r=this.problemDiv.render();return c("div",{},t,e,o,i,r)}setUp(){}}class $t{constructor(){u(this,"transporterConfig",new St);u(this,"partConfigs",{bass:new W("bass"),drum:new W("drum"),keys:new W("keys"),lead:new W("lead")});u(this,"miscellaneousDiv",new _t);u(this,"form",null)}render(){const t=this.transporterConfig.render(),e=Object.values(this.partConfigs).map(i=>i.render()),o=this.miscellaneousDiv.render();return this.form=c("form",{id:D.CONFIG_FORM_ID},t,...e,o)}setUp(){if(!this.form)throw new Error("setUp called before render");this.transporterConfig.setUp();for(const t of Object.values(this.partConfigs))t.setUp();if(!this.miscellaneousDiv.refreshButton)throw new Error("setUp called before render");this.miscellaneousDiv.refreshButton.addEventListener("mousedown",this.refreshMidi.bind(this)),this.refreshMidi(),this.clickAllFirstRadioButtons(),this.form.classList.remove("hidden")}getConfig(){return{transporter:this.transporterConfig.getConfig(),parts:{bass:this.partConfigs.bass.getConfig(),drum:this.partConfigs.drum.getConfig(),keys:this.partConfigs.keys.getConfig(),lead:this.partConfigs.lead.getConfig()}}}refreshMidi(){if(!this.form)throw new Error("refreshMidi called before render");const t=Array.from(this.form.querySelectorAll('input[type="radio"][value="midi"]'));for(const o of t)o.disabled=!I;if(!I)return;function e(o,i){const r=document.getElementsByClassName(o),s=Array.from(I[i].values()).map(l=>l.name);for(const l of r){const y=l.value||s[0];l.innerHTML="";for(const C of s){const b=c("option",{value:C},C);l.appendChild(b)}s.includes(y)&&(l.value=y)}}e(D.MIDI_INPUT_SELECT_CLASS,"inputs"),e(D.MIDI_OUTPUT_SELECT_CLASS,"outputs")}clickAllFirstRadioButtons(){if(!this.form)throw new Error("clickAllFirstRadioButtons called before render");const t=Array.from(this.form.querySelectorAll('input[type="radio"]:enabled:first-of-type'));for(const e of t)e.click()}getPromise(){return new Promise(t=>{if(!this.form)throw new Error("getPromise called before render");this.form.addEventListener("submit",e=>{if(!this.form)throw new Error("submit event listener called after form was removed");e.preventDefault();const o=this.getConfig(),i=Mt(o);this.miscellaneousDiv.problemDiv.addProblems(i),!i.length&&(this.form.remove(),t(o))})})}}async function jt(){const n=new $t;return document.body.append(n.render()),n.setUp(),await n.getPromise()}const Gt=async()=>await jt();function Tt(n){const t=c("h2"),e={previous:c("button",{class:"transporter-button"},"\u23EE"),play:c("button",{class:"transporter-button"},"\u25B6"),pause:c("button",{class:"transporter-button"},"\u23F8"),stop:c("button",{class:"transporter-button"},"\u23F9"),next:c("button",{class:"transporter-button"},"\u23ED")};n.connect=(r,s)=>{e.previous.addEventListener("click",()=>r.goPrevious()),e.next.addEventListener("click",()=>r.goNext()),e.play.addEventListener("click",()=>s.play()),e.pause.addEventListener("click",()=>s.pause()),e.stop.addEventListener("click",()=>s.stop())},n.changeChart=(r,s,l)=>{t.innerText=r,e.previous.disabled=!s,e.next.disabled=!l},n.changePlayback=r=>{e.play.disabled=r===f.Playing,e.pause.disabled=r!==f.Playing,e.stop.disabled=r===f.Stopped};const o=c("div",{},...Object.values(e)),i=c("div",{id:"transporter"},t,o);n.render=()=>i}class Bt{constructor(t){switch(t.type){case p.Dom:Tt(this);break;default:throw new Error(`Invalid Transporter type: ${t}`)}}connect(t,e){}changeChart(t,e,o){}changePlayback(t){}render(){return null}}function ut(n,...t){return[...n,...t].sort((e,o)=>e.time-o.time)}const Rt=/[CDEFGAB]/,Ut=/♮|b{1,2}|#{1,2}/,zt=/-?[0-8]/,Ht=/[CDEFGAB](♮|b{1,2}|#{1,2})?/;function it(n){var C,b,R,U;const t=(C=n.match(Ht))==null?void 0:C[0];if(t===void 0)throw new Error(`Invalid pitch class: ${n}`);const e=(b=t.match(Rt))==null?void 0:b[0];if(e===void 0)throw new Error(`Invalid pitch letter: ${t}`);const o={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[e];if(o===void 0)throw new Error(`Invalid pitch letter: ${t}`);const i=((R=t.match(Ut))==null?void 0:R[0])||"\u266E",r={"\u266E":0,b:-1,bb:-2,"#":1,"##":2}[i];if(r===void 0)throw new Error(`Invalid accidental: ${t}`);const s=Number((U=n.match(zt))==null?void 0:U[0]);if(isNaN(s))throw new Error(`Invalid octave: ${t}`);const l=(s+1)*12,y=o+r+l;if(y<0||y>127)throw new Error(`Out of MIDI range: ${t}`);return y}function rt(n){return 6e4/n}function z(...n){const t={millisecondsPerBeat:rt(120),position:-1/0,bufferEvents:[]};return n.reduce((e,o)=>o(e),t).bufferEvents}function J(n){return t=>Object.assign({},t,{millisecondsPerBeat:rt(n)})}function dt(n){return Math.max(n-.1,n*.9)}function H(n,t,e,o,i){if(typeof t=="function")return r=>{const{millisecondsPerBeat:s}=r,l=C=>{const b=t(),R={time:e*s,type:v.NoteOn,part:n,pitch:b,velocity:i},U={time:(e+dt(o))*s,type:v.NoteOff,part:n,pitch:b};C.unshift(R,U)},y={time:e*s-100,type:v.Compute,callback:l};return Object.assign({},r,{position:e+o,bufferEvents:ut(r.bufferEvents,y)})};{const r=typeof t=="number"?t:it(t);return s=>{const{millisecondsPerBeat:l}=s,y={time:e*l,type:v.NoteOn,part:n,pitch:r,velocity:i},C={time:(e+dt(o))*l,type:v.NoteOff,part:n,pitch:r};return Object.assign({},s,{position:e+o,bufferEvents:ut(s.bufferEvents,y,C)})}}}function k(...n){return t=>{const{position:e,millisecondsPerBeat:o,bufferEvents:i}=t,r=n.map(s=>({time:e*o,type:v.Finish,part:s}));return Object.assign({},t,{bufferEvents:[...i,...r]})}}const Vt={title:"Hello World",compose:({bass:n,drum:t,keys:e,lead:o})=>z(k(n,t,e),J(60),H(o,"C4",0,4,127),k(o))},Kt=["C2","D2","E2","F2","G2","A2","B2","C3"],Yt={title:"Bass Scale",compose:({bass:n,drum:t,keys:e,lead:o})=>z(k(t,e,o),J(120),...Kt.map((i,r)=>H(n,i,r,.9,127)),k(n))},Xt=[["C4",0,.9],["C4",1,.9],["G4",2,.9],["G4",3,.9],["A4",4,.9],["A4",5,.9],["G4",6,1.9],["F4",8,.9],["F4",9,.9],["E4",10,.9],["E4",11,.9],["D4",12,.9],["D4",13,.9],["C4",14,1.9],["G4",16,.9],["G4",17,.9],["F4",18,.9],["F4",19,.9],["E4",20,.9],["E4",21,.9],["D4",22,1.9],["G4",24,.9],["G4",25,.9],["F4",26,.9],["F4",27,.9],["E4",28,.9],["E4",29,.9],["D4",30,1.9],["C4",32,.9],["C4",33,.9],["G4",34,.9],["G4",35,.9],["A4",36,.9],["A4",37,.9],["G4",38,1.9],["F4",40,.9],["F4",41,.9],["E4",42,.9],["E4",43,.9],["D4",44,.9],["D4",45,.9],["C4",46,2]];function Wt(n){const t=n.controller.getRangeControl("8va chance: ",0,100,"%");return Xt.map(([e,o,i])=>{const r=Math.random()*100,s=it(e);return H(n,()=>t.value>r?s+12:s,o,i,127)})}const Jt={title:"Twinkle Twinkle Little Star",compose:({bass:n,drum:t,keys:e,lead:o})=>z(k(n,t,e),J(120),...Wt(o),k(o))},pt=["E3","G3","A3","G3","D4","C4","D4","E4"],ht=2,ft=ht/pt.length,Q=rt(165);function Qt(n){const t=pt.map(it);return e=>{const o=n.controller.getOptionControl("Repeat again: ",["No","Yes"],"!"),i=r=>({time:r*Q-100,type:v.Compute,callback:s=>{if(o.value){const l=t.map((y,C)=>{const b=r+C*ft;return[{time:b*Q,type:v.NoteOn,part:n,pitch:y,velocity:127},{time:(b+ft-.05)*Q,type:v.NoteOff,part:n,pitch:y}]}).flat();s.push(...l,i(r+ht))}else s.push({time:r*Q,type:v.Finish,part:n})}});return Object.assign({},e,{bufferEvents:[...e.bufferEvents,i(0)]})}}const Zt={title:"On the Run",compose:({bass:n,drum:t,keys:e,lead:o})=>z(k(n,t,e),Qt(o))};function te(n,t){const e=[],o=[];let i=0;for(const r of t){const s=n[r],l=s.length,y=s.melody,C=s.chords;for(const[b,R,U]of y)e.push([b,R+i,U]);for(const b of C)o.push({...b,position:b.position+i});i+=l}return{length:i,melody:e,chords:o}}const ee={"1-16":{length:64,melody:[["C5",0,1],["B4",1,1],["A4",2,.5],["G4",2.5,1.5],["F4",4,1.5],["G4",5.5,.5],["A4",6,1],["C5",7,1],["B4",8,1],["A4",9,1],["G4",10,.5],["F4",10.5,1.5],["E4",12,4],["A4",16,1],["G4",17,1],["F4",18,.5],["E4",18.5,1.5],["D4",20,1.5],["E4",21.5,.5],["F4",22,1],["A4",23,1],["G#4",24,1],["F4",25,1],["E4",26,.5],["D4",26.5,1.5],["C4",28,3],["C#4",31,1],["D4",32,.5],["A4",32.5,1],["A4",33.5,3.5],["C5",37,2],["B4",39,1],["G4",40,7],["B3",47,1],["C4",48,.5],["F4",48.5,1],["F4",49.5,3.5],["A4",53,2],["G4",55,1],["F4",56,2],["E4",58,7]],chords:[{root:"A",quality:"minor",extension:"7",position:0,duration:4},{root:"D",quality:"minor",extension:"7",position:4,duration:4},{root:"G",quality:"major",extension:"7",position:8,duration:4},{root:"C",quality:"major",extension:"maj7",position:12,duration:2},{root:"C",quality:"major",extension:"7",position:14,duration:2},{root:"F",quality:"major",extension:"7",position:16,duration:4},{root:"B",quality:"minor",extension:"7(b5)",position:20,duration:4},{root:"E",quality:"minor",extension:"7",position:24,duration:4},{root:"A",quality:"minor",extension:"7",position:28,duration:2},{root:"A",quality:"major",extension:"7",position:30,duration:2},{root:"D",quality:"minor",extension:"7",position:32,duration:4},{root:"G",quality:"major",extension:"7",position:36,duration:4},{root:"C",quality:"major",extension:"maj7",position:40,duration:4},{root:"E",quality:"minor",extension:"7",position:44,duration:2},{root:"A",quality:"minor",extension:"7",position:46,duration:2},{root:"D",quality:"minor",extension:"7",position:48,duration:4},{root:"G",quality:"major",extension:"7",position:52,duration:4},{root:"F",quality:"major",extension:"6",position:56,duration:2},{root:"C",quality:"major",extension:"maj7",position:58,duration:2},{root:"B",quality:"minor",extension:"7(b5)",position:60,duration:2},{root:"E",quality:"minor",extension:"7",position:62,duration:2}]},"17-26":{length:40,melody:[["C5",0,1],["B4",1,1],["A4",2,.5],["G4",2.5,1.5],["F4",4,1.5],["G4",5.5,.5],["A4",6,1],["C5",7,1],["B4",8,1],["A4",9,1],["G4",10,.5],["F4",10.5,1.5],["E4",12,4],["A4",16,1],["G4",17,1],["F4",18,.5],["E4",18.5,1.5],["D4",20,1],["E4",21,1],["F4",22,1],["A4",23,1],["G#4",24,1],["F4",25,1],["E4",26,.5],["D4",26.5,1.5],["C4",28,3],["C#4",31,1],["D4",32,.5],["A4",32.5,1],["A4",33.5,3.5],["C5",37,2],["B4",39,1]],chords:[{root:"A",quality:"minor",extension:"7",position:0,duration:4},{root:"D",quality:"minor",extension:"7",position:4,duration:4},{root:"G",quality:"major",extension:"7",position:8,duration:4},{root:"C",quality:"major",extension:"maj7",position:12,duration:2},{root:"C",quality:"major",extension:"7",position:14,duration:2},{root:"F",quality:"major",extension:"maj7",position:16,duration:4},{root:"B",quality:"minor",extension:"7(b5)",position:20,duration:4},{root:"E",quality:"minor",extension:"7",position:24,duration:4},{root:"A",quality:"minor",extension:"7",position:28,duration:2},{root:"A",quality:"major",extension:"7",position:30,duration:2},{root:"D",quality:"minor",extension:"7",position:32,duration:4},{root:"G",quality:"major",extension:"7",position:36,duration:4}]},"27-32":{length:24,melody:[["G4",0,7],["G#4",7,1],["A4",8,.5],["C4",8.5,1],["C4",9.5,3.5],["C4",13,2],["B4",15,1],["C4",16,4]],chords:[{root:"E",quality:"minor",extension:"7",position:0,duration:4},{root:"A",quality:"minor",extension:"7",position:4,duration:4},{root:"D",quality:"minor",extension:"7",position:8,duration:4},{root:"G",quality:"major",extension:"7",position:12,duration:4},{root:"C",quality:"major",extension:"6",position:16,duration:4},{root:"B",quality:"minor",extension:"7(b5)",position:20,duration:2},{root:"E",quality:"minor",extension:"7",position:22,duration:2}]},"33-38":{length:24,melody:[["E5",0,7],["C5",7,1],["D5",8,.5],["A4",8.5,1],["A4",9.5,3.5],["B4",13,2],["D5",15,1],["C5",16,7]],chords:[{root:"E",quality:"minor",extension:"7",position:0,duration:4},{root:"A",quality:"minor",extension:"7",position:4,duration:4},{root:"D",quality:"minor",extension:"7",position:8,duration:4},{root:"G",quality:"major",extension:"7",position:12,duration:4},{root:"C",quality:"major",extension:"6",position:16,duration:8}]}};function ne(n,t){const e=[];for(const{root:o,position:i,duration:r}of t.chords)for(let s=0;s<r;s+=1)e.push(H(n,`${o}1`,i+s,.7,127));return e}function oe(n,t){const e=[];for(const[o,i,r]of t.melody)e.push(H(n,o,i,r,127));return e}const ie=["1-16","17-26","27-32","1-16","17-26","33-38"],st=te(ee,ie);console.debug("song",st);const re={title:"Fly Me to the Moon",compose:({bass:n,drum:t,keys:e,lead:o})=>z(k(t,e),J(118),...ne(n,st),...oe(o,st),k(n))},mt=[Vt,Yt,Jt,Zt,re],yt=mt.length;class se{constructor(){g(this,P,0);g(this,L,()=>{})}goPrevious(){a(this,P)>0&&(d(this,P,a(this,P)-1),a(this,L).call(this))}goNext(){a(this,P)<yt-1&&(d(this,P,a(this,P)+1),a(this,L).call(this))}connect(t,e){d(this,L,()=>{const o=mt[a(this,P)],i=o.title,r=a(this,P)>0,s=a(this,P)<yt-1;t.changeChart(i,r,s),e.changeChart(o)})}start(){a(this,L).call(this)}}P=new WeakMap,L=new WeakMap;const gt=12,T={min:0,max:127,step:1,default:63};class ae{constructor(){g(this,N);g(this,F);g(this,_,()=>{});g(this,$,()=>0);const t=c("span",{},"EMPTY");d(this,N,{0:c("span",{},"%%"),1:t,2:c("span",{},"%%")}),d(this,F,c("input",{type:"range",min:T.min,max:T.max,step:T.step,value:T.default})).addEventListener("input",()=>{a(this,_).call(this)})}clear(){d(this,$,()=>0),d(this,_,()=>{});const t=Object.values(a(this,N));for(const e of t)e.textContent=""}get value(){return a(this,$).call(this)}makeIntoRangeControl(t,e,o,i=""){const r=a(this,N),s=r[1],l=a(this,F);r[0].textContent=t,r[2].textContent=i;const y=d(this,$,()=>e+Math.round((o-e)*Number(l.value)/T.max));d(this,_,()=>{s.textContent=y().toString()})()}makeIntoOptionControl(t,e,o=""){const i=a(this,N),r=i[1],s=a(this,F);i[0].textContent=t,i[2].textContent=o;const l=d(this,$,()=>Math.round((e.length-1)*Number(s.value)/T.max));d(this,_,()=>{r.textContent=e[l()]})()}render(){const t=c("label",{class:"lcd"},...Object.values(a(this,N)));return c("div",{class:"controller-module"},t,a(this,F))}}N=new WeakMap,F=new WeakMap,_=new WeakMap,$=new WeakMap;function ce(n){const t=Array.from({length:gt},()=>new ae);let e=0;n.clear=()=>{t.forEach(i=>i.clear()),e=0};function o(){if(e>=gt)throw new Error("No more controllers available");const i=t[e];return e+=1,i}n.getRangeControl=(i,r,s,l="")=>{const y=o();return y.makeIntoRangeControl(i,r,s,l),y},n.getOptionControl=(i,r,s="")=>{const l=o();return l.makeIntoOptionControl(i,r,s),l},n.render=()=>{const i=c("h2",{class:"component-title"},"Controller"),r=t.map(l=>l.render()),s=c("div",{class:"controller-row"},...r);return i.addEventListener("click",()=>{s.classList.toggle("hidden")}),c("div",{class:"controller"},i,s)}}class le{constructor(t,e){switch(e.type){case h.Dom:ce(this);break;default:throw new Error(`Invalid Controller type: ${e}`)}}clear(){}getRangeControl(t,e,o,i=""){return{value:0}}getOptionControl(t,e,o=""){return{value:0}}render(){return null}}function ue(n){n.noteOn=(t,e,o)=>{console.log("noteOn",t,o,e)},n.noteOff=(t,e)=>{console.log("noteOff",t,e)},n.allNotesOff=()=>{console.log("allNotesOff")}}function de(n){const t=c("h2",{class:"component-title"},"Synthesizer"),e=c("button",{},"Clear"),o=c("div",{class:"message-row"}),i=c("div",{class:"synthesizer-row"},e,o),r=c("div",{class:"synthesizer"},t,i);function s(l,y){const C=c("div",{class:y},l);o.appendChild(C),o.scrollTop=o.scrollHeight}n.noteOn=(l,y,C,b=!0)=>{b&&n.currentlyPlayingPitches.push(l),s(`noteOn ${l} ${y} ${C.toFixed(0)}`,"note-on")},n.noteOff=(l,y,C=!0)=>{s(`noteOff ${l} ${y.toFixed(0)}`,"note-off"),C&&(n.currentlyPlayingPitches=n.currentlyPlayingPitches.filter(b=>b!==l))},n.allNotesOff=()=>{s("allNotesOff","all-notes-off"),n.currentlyPlayingPitches=[]},e.addEventListener("click",()=>{o.innerHTML=""}),t.addEventListener("click",()=>{i.classList.toggle("hidden")}),n.render=()=>r}function pe(n,t){if(!I)throw new Error("No MIDI access");const e=I.outputs.values().find(i=>i.name===t.midi.output);if(!e)throw new Error(`No MIDI output named ${t.midi.output}`);const o=t.midi.channel-1;n.noteOn=(i,r,s,l=!0)=>{l&&n.currentlyPlayingPitches.push(i),e.send([144+o,i,r],s)},n.noteOff=(i,r,s=!0)=>{e.send([128+o,i,0],r),s&&(n.currentlyPlayingPitches=n.currentlyPlayingPitches.filter(l=>l!==i))},n.allNotesOff=()=>{e.send([176+o,123,0]),n.currentlyPlayingPitches=[]}}class he{constructor(t,e){u(this,"currentlyPlayingPitches",[]);switch(e.type){case m.Log:ue(this);break;case m.Dom:de(this);break;case m.Midi:pe(this,e);break}}noteOn(t,e,o,i=!0){}noteOff(t,e,o=!0){}allNotesOff(){}pause(){const t=window.performance.now();for(const e of this.currentlyPlayingPitches)this.noteOff(e,t,!1)}resume(){const t=window.performance.now();for(const e of this.currentlyPlayingPitches)this.noteOn(e,31,t,!1)}render(){return null}}class Z{constructor(t,e){g(this,V);u(this,"controller");u(this,"synthesizer");d(this,V,t),this.controller=new le(t,e.controller),this.synthesizer=new he(t,e.synthesizer)}render(){const t=c("h2",{},a(this,V).toUpperCase()),e=this.controller.render(),o=this.synthesizer.render();return e||o?c("div",{class:"part"},t,e,o):null}}V=new WeakMap;function fe(n){return{bass:new Z("bass",n.bass),drum:new Z("drum",n.drum),keys:new Z("keys",n.keys),lead:new Z("lead",n.lead)}}const tt=100;function me(){return new Worker(new URL(""+new URL("worker-Dukc8-Vk.js",import.meta.url).href,import.meta.url),{type:"module"})}class ye{constructor(t,e){g(this,X);g(this,K);g(this,A,me());g(this,O);g(this,S,!1);g(this,q,[]);g(this,Y,()=>{});g(this,j,0);g(this,G,0);g(this,B,new Set);d(this,K,t),d(this,O,fe(e)),a(this,A).onmessage=o=>this.schedule()}schedule(){const t=window.performance.now()+tt;for(;a(this,S)&&a(this,X,at)<t;){const e=a(this,X,at),o=a(this,q).shift();if(o)switch(o.type){case v.Finish:a(this,B).add(o.part),a(this,B).size===4&&a(this,K).stop();break;case v.NoteOn:o.part.synthesizer.noteOn(o.pitch,o.velocity,e);break;case v.NoteOff:o.part.synthesizer.noteOff(o.pitch,e);break;case v.Compute:o.callback(a(this,q));break}}}changeChart(t){d(this,Y,()=>{for(const e of Object.values(a(this,O)))e.controller.clear();console.debug("buffer",d(this,q,t.compose(a(this,O))))})()}play(){d(this,S,!0),d(this,j,window.performance.now()+tt),d(this,G,0),a(this,A).postMessage(0)}pause(){d(this,S,!1),a(this,A).postMessage(1),d(this,G,window.performance.now()-a(this,j)),setTimeout(()=>{for(const t of Object.values(a(this,O)))t.synthesizer.pause()},tt*2)}resume(){d(this,S,!0),d(this,j,window.performance.now()-a(this,G)),a(this,A).postMessage(0);for(const t of Object.values(a(this,O)))t.synthesizer.resume()}stop(){d(this,S,!1),a(this,A).postMessage(1),d(this,G,0),a(this,B).clear(),a(this,Y).call(this),setTimeout(()=>{for(const t of Object.values(a(this,O)))t.synthesizer.allNotesOff()},tt*2)}render(){const t=Object.values(a(this,O)).map(e=>e.render());return t.some(e=>e!==null)?c("div",{id:"part-container"},...t):null}}K=new WeakMap,A=new WeakMap,O=new WeakMap,S=new WeakMap,q=new WeakMap,Y=new WeakMap,j=new WeakMap,G=new WeakMap,B=new WeakMap,X=new WeakSet,at=function(){return a(this,q).length===0?1/0:a(this,q)[0].time+a(this,j)};class ge{constructor(t){g(this,w,f.Paused);g(this,x,()=>{});g(this,M);d(this,M,new ye(this,t))}changeChart(t){a(this,M).changeChart(t),a(this,w)!=f.Stopped&&this.stop()}play(){switch(a(this,w)){case f.Playing:break;case f.Paused:a(this,x).call(this,E.Resume),d(this,w,f.Playing);break;case f.Stopped:a(this,x).call(this,E.Play),d(this,w,f.Playing);break}}pause(){switch(a(this,w)){case f.Playing:a(this,x).call(this,E.Pause),d(this,w,f.Paused);break;case f.Paused:break;case f.Stopped:break}}stop(){switch(a(this,w)){case f.Playing:a(this,x).call(this,E.Stop),d(this,w,f.Stopped);break;case f.Paused:a(this,x).call(this,E.Stop),d(this,w,f.Stopped);break;case f.Stopped:break}}connect(t){d(this,x,e=>{switch(e){case E.Play:a(this,M).play(),t.changePlayback(f.Playing);break;case E.Pause:a(this,M).pause(),t.changePlayback(f.Paused);break;case E.Resume:a(this,M).resume(),t.changePlayback(f.Playing);break;case E.Stop:a(this,M).stop(),t.changePlayback(f.Stopped);break}})}render(){return a(this,M).render()}}w=new WeakMap,x=new WeakMap,M=new WeakMap;function Ct(n){n&&document.body.append(n)}function Ce(n){const t=new Bt(n.transporter),e=new se,o=new ge(n.parts);t.connect(e,o),e.connect(t,o),o.connect(t);const i=t.render(),r=o.render();Ct(i),Ct(r),e.start()}const be=await Gt();Ce(be)})();
</script>
  <style rel="stylesheet" crossorigin>:root{--red: #b23535;--green: #38ad5f;--blue: #464ca5;--white: #eeeade;--black: #282828;--text-color: var(--black);--background-color: var(--white)}@media (prefers-color-scheme: dark){:root{--text-color: var(--white);--background-color: var(--black)}}*{color:inherit;background-color:inherit;border-color:inherit;font-family:inherit;box-sizing:inherit}body{min-height:100vh;font-family:Arial,sans-serif;color:var(--text-color);background-color:var(--background-color);border-color:var(--text-color);box-sizing:border-box;padding:0;margin:0}#config-form{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}fieldset{margin-bottom:20px}legend{font-weight:700;margin-bottom:10px}.type-div{margin-bottom:10px}label{-webkit-user-select:none;user-select:none}input[type=radio]:disabled+label{text-decoration:line-through}button{color:var(--text-color);background-color:var(--background-color);border:1px solid var(--text-color);cursor:pointer;transition:background-color .3s ease}button:hover{background-color:var(--text-color);color:var(--background-color)}.transporter-button{width:2em;height:2em;border:1.5px solid;border-radius:50%;font-size:2.5rem;padding:1rem;margin:0 .5rem 2rem;cursor:pointer;color:var(--background-color);background-color:var(--text-color);transition:transform .2s}.transporter-button:hover:enabled{transform:scale(1.1)}.transporter-button:disabled{color:var(--text-color);background-color:var(--background-color);cursor:auto}#transporter{text-align:center;border-bottom:1px solid var(--text-color)}.lcd{padding:.5em 1em;border-radius:5px;width:16ch;min-height:4em;line-height:1.5;text-align:left;font-family:hd44780,monospace;color:var(--background-color);background-color:var(--text-color)}input[type=range]{margin-top:1em;width:100%}.controller-module{padding:1em;display:flex;flex-direction:column;align-items:center;border:1px solid;font-size:1vw}.component-title{margin-top:0;margin-bottom:0;width:100%;height:3rem;line-height:3rem;cursor:pointer;-webkit-user-select:none;user-select:none}.controller-row{border-top:1px solid;justify-content:center;align-items:center;overflow-y:scroll;height:40vw}.controller{padding-top:0;border:1px solid}.note-on{color:var(--green)}.note-off{color:var(--red)}.all-notes-off{color:var(--blue)}.message-row{width:100%;height:10vw;overflow-y:scroll}.synthesizer-row{width:100%}.synthesizer{display:flex;flex-direction:column;align-items:center;width:100%;border:1px solid}.part{text-align:center;border:1px solid;min-width:20%}#part-container{display:flex;flex-wrap:wrap;justify-content:space-around;align-items:start}.hidden{display:none}
</style>
</head>

<body>
</body>

</html>