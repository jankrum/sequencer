<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vite + TS</title>
  <script type="module" crossorigin>var te=Object.defineProperty;var G=e=>{throw TypeError(e)};var se=(e,t,s)=>t in e?te(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var J=(e,t,s)=>se(e,typeof t!="symbol"?t+"":t,s),Q=(e,t,s)=>t.has(e)||G("Cannot "+s);var o=(e,t,s)=>(Q(e,t,"read from private field"),s?s.call(e):t.get(e)),c=(e,t,s)=>t.has(e)?G("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,s),r=(e,t,s,n)=>(Q(e,t,"write to private field"),n?n.call(e,s):t.set(e,s),s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const h of i)if(h.type==="childList")for(const S of h.addedNodes)S.tagName==="LINK"&&S.rel==="modulepreload"&&n(S)}).observe(document,{childList:!0,subtree:!0});function s(i){const h={};return i.integrity&&(h.integrity=i.integrity),i.referrerPolicy&&(h.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?h.credentials="include":i.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function n(i){if(i.ep)return;i.ep=!0;const h=s(i);fetch(i.href,h)}})();var F=(e=>(e[e.Dom=0]="Dom",e[e.Midi=1]="Midi",e))(F||{}),x=(e=>(e[e.Dom=0]="Dom",e[e.Midi=1]="Midi",e))(x||{}),Y=(e=>(e[e.Dom=0]="Dom",e[e.Midi=1]="Midi",e))(Y||{}),a=(e=>(e[e.Playing=0]="Playing",e[e.Paused=1]="Paused",e[e.Stopped=2]="Stopped",e))(a||{}),d=(e=>(e[e.Play=0]="Play",e[e.Pause=1]="Pause",e[e.Resume=2]="Resume",e[e.Stop=3]="Stop",e))(d||{}),l=(e=>(e[e.Tempo=0]="Tempo",e[e.Finish=1]="Finish",e[e.NoteOn=2]="NoteOn",e[e.NoteOff=3]="NoteOff",e))(l||{});const oe=async()=>({parts:{bass:{controller:{type:F.Dom},synthesizer:{type:x.Dom}},drum:{controller:{type:F.Dom},synthesizer:{type:x.Dom}},keys:{controller:{type:F.Dom},synthesizer:{type:x.Dom}},lead:{controller:{type:F.Dom},synthesizer:{type:x.Dom}}},transporter:{type:Y.Dom}});function H(e,t={},...s){const n=document.createElement(e);for(const[i,h]of Object.entries(t))n.setAttribute(i,h);for(const i of s)typeof i=="string"?n.appendChild(document.createTextNode(i)):n.appendChild(i);return n}const V="#transporter",ne=[["previous","⏮"],["play","▶"],["pause","⏸"],["stop","⏹"],["next","⏭"]],ie=([e,t])=>[e,H("button",{},t)],re=()=>Object.fromEntries(ne.map(ie)),ae={[a.Playing]:{play:!0,pause:!1,stop:!1},[a.Paused]:{play:!1,pause:!0,stop:!1},[a.Stopped]:{play:!1,pause:!0,stop:!0}};var z,p;class ce{constructor(t){c(this,z,H("h2"));c(this,p,re());console.debug("Transporter",t);const s=document.querySelector(V);if(!s)throw new Error(`Transporter not found: ${V}`);const n=H("div",{},...Object.values(o(this,p)));s==null||s.append(o(this,z),n)}changeChart(t,s,n){o(this,z).innerText=t,o(this,p).previous.disabled=!s,o(this,p).next.disabled=!n}changePlayback(t){for(const[s,n]of Object.entries(ae[t]))o(this,p)[s].disabled=n}connect(t,s){o(this,p).previous.addEventListener("click",()=>t.goPrevious()),o(this,p).next.addEventListener("click",()=>t.goNext()),o(this,p).play.addEventListener("click",()=>s.play()),o(this,p).pause.addEventListener("click",()=>s.pause()),o(this,p).stop.addEventListener("click",()=>s.stop())}}z=new WeakMap,p=new WeakMap;function K(e){return{position:-1/0,type:l.Tempo,bpm:e}}function A(...e){return e.map(t=>({position:-1/0,part:t,type:l.Finish}))}const Z=[0,2,4,5,7,9,11,12];function he(e){return Z.map(t=>t+24).map((t,s)=>[{position:s,part:e,type:l.NoteOn,pitch:t},{position:s+.9,part:e,type:l.NoteOff,pitch:t}]).flat()}const le={title:"Bass Scale",compose:({bass:e,drum:t,keys:s,lead:n})=>[K(120),...A(t,s,n),...he(e),{position:Z.length,type:l.Finish,part:e}]},B=[0,2,4,5,7,9,11,12];function pe(e){return B.map(t=>t+48).map((t,s)=>[{position:s,part:e,type:l.NoteOn,pitch:t},{position:s+.9,part:e,type:l.NoteOff,pitch:t}]).flat()}const ue={title:"Lead Scale",compose:({bass:e,drum:t,keys:s,lead:n})=>[K(120),...A(e,t,s),...pe(n),{position:B.length,type:l.Finish,part:n}]},de={title:"Twinkle Twinkle Little Star",compose:({bass:e,drum:t,keys:s,lead:n})=>{const i=(()=>{const v=[[0,1,0],[0,1,0],[7,1,0],[7,1,0],[9,1,0],[9,1,0],[7,2,0],[5,1,0],[5,1,0],[4,1,0],[4,1,0],[2,1,0],[2,1,0],[0,2,0]],M=[[7,1,0],[7,1,0],[5,1,0],[5,1,0],[4,1,0],[4,1,0],[2,2,0]],W=[...v,...M,...M,...v];let $=0;const j=[];for(const T of W)j.push([T[0],T[1],$]),$+=T[1];return j})();function h(v,M){return[...M.map(([W,$,j])=>[{position:j,part:v,type:l.NoteOn,pitch:W},{position:j+$-.1,part:v,type:l.NoteOff,pitch:W}]).flat(),{position:(M.at(-1)??[0,0,0])[2]+.1,type:l.Finish,part:v}]}return[K(120),...A(e,t,s),...h(n,i)]}},ee=[le,ue,de],X=ee.length;var f,w;class fe{constructor(){c(this,f,0);c(this,w,()=>{})}goPrevious(){o(this,f)>0&&(r(this,f,o(this,f)-1),o(this,w).call(this))}goNext(){o(this,f)<X-1&&(r(this,f,o(this,f)+1),o(this,w).call(this))}connect(t,s){r(this,w,()=>{const n=ee[o(this,f)],i=n.title,h=o(this,f)>0,S=o(this,f)<X-1;t.changeChart(i,h,S),s.changeChart(n)})}start(){o(this,w).call(this)}}f=new WeakMap,w=new WeakMap;var O;class me{constructor(t){c(this,O);r(this,O,t)}noteOn(t,s){console.log("noteOn",o(this,O),t,s)}noteOff(t,s){console.log("noteOff",o(this,O),t,s)}allNotesOff(){console.log("allNotesOff",o(this,O))}}O=new WeakMap;class q{constructor(t){J(this,"synthesizer");this.synthesizer=new me(t)}}function ge(){return{bass:new q("bass"),drum:new q("drum"),keys:new q("keys"),lead:new q("lead")}}const U=100;function ye(){return new Worker(new URL(""+new URL("worker-DxAA_dw-.js",import.meta.url).href,import.meta.url),{type:"module"})}var C,g,I,y,k,R,P,N,E,D,L,_;class be{constructor(t){c(this,L);c(this,C);c(this,g,ye());c(this,I,ge());c(this,y,!1);c(this,k,[]);c(this,R,()=>{});c(this,P,0);c(this,N,0);c(this,E,6e4/120);c(this,D,new Set);r(this,C,t),o(this,g).onmessage=s=>this.schedule()}schedule(){const t=window.performance.now()-o(this,P)+U;for(;o(this,y)&&o(this,L,_)<t;){const s=o(this,k).shift();if(s)switch(s.type){case l.Tempo:r(this,E,6e4/s.bpm);break;case l.Finish:o(this,D).add(s.part),o(this,D).size===4&&o(this,C).stop();break;case l.NoteOn:s.part.synthesizer.noteOn(s.pitch,o(this,L,_));break;case l.NoteOff:s.part.synthesizer.noteOff(s.pitch,o(this,L,_));break}}}changeChart(t){r(this,R,()=>r(this,k,t.compose(o(this,I))))()}play(){r(this,y,!0),r(this,P,window.performance.now()+U),r(this,N,0),o(this,g).postMessage(0)}pause(){r(this,y,!1),o(this,g).postMessage(1),r(this,N,window.performance.now()-o(this,P))}resume(){r(this,y,!0),r(this,P,window.performance.now()-o(this,N)),o(this,g).postMessage(0)}stop(){r(this,y,!1),o(this,g).postMessage(1),r(this,N,0),o(this,D).clear(),o(this,R).call(this),setTimeout(()=>{for(const s of Object.values(o(this,I)))s.synthesizer.allNotesOff()},U)}}C=new WeakMap,g=new WeakMap,I=new WeakMap,y=new WeakMap,k=new WeakMap,R=new WeakMap,P=new WeakMap,N=new WeakMap,E=new WeakMap,D=new WeakMap,L=new WeakSet,_=function(){return o(this,k).length===0?1/0:o(this,k)[0].position*o(this,E)};var u,m,b;class we{constructor(t){c(this,u,a.Paused);c(this,m,()=>{});c(this,b,new be(this));console.debug("Playbacker",t)}changeChart(t){console.debug("changeChart",t),o(this,b).changeChart(t),o(this,u)!=a.Stopped&&this.stop()}play(){switch(o(this,u)){case a.Playing:console.debug("already playing");break;case a.Paused:console.debug("resume"),o(this,m).call(this,d.Resume),r(this,u,a.Playing);break;case a.Stopped:console.debug("play"),o(this,m).call(this,d.Play),r(this,u,a.Playing);break}}pause(){switch(o(this,u)){case a.Playing:console.debug("pause"),o(this,m).call(this,d.Pause),r(this,u,a.Paused);break;case a.Paused:console.debug("already paused");break;case a.Stopped:console.debug("already stopped");break}}stop(){switch(o(this,u)){case a.Playing:console.debug("stop"),o(this,m).call(this,d.Stop),r(this,u,a.Stopped);break;case a.Paused:console.debug("stop"),o(this,m).call(this,d.Stop),r(this,u,a.Stopped);break;case a.Stopped:console.debug("already stopped");break}}connect(t){r(this,m,s=>{switch(s){case d.Play:o(this,b).play(),t.changePlayback(a.Playing);break;case d.Pause:o(this,b).pause(),t.changePlayback(a.Paused);break;case d.Resume:o(this,b).resume(),t.changePlayback(a.Playing);break;case d.Stop:o(this,b).stop(),t.changePlayback(a.Stopped);break}})}}u=new WeakMap,m=new WeakMap,b=new WeakMap;function Oe(e){const t=new ce(e.transporter),s=new fe,n=new we(e.parts);t.connect(s,n),s.connect(t,n),n.connect(t),s.start()}oe().then(e=>Oe(e));
</script>
  <style rel="stylesheet" crossorigin>:root{--red: #b23535;--green: #38ad5f;--blue: #464ca5;--white: #eeeade;--black: #282828;--text-color: var(--black);--background-color: var(--white)}@media (prefers-color-scheme: dark){:root{--text-color: var(--white);--background-color: var(--black)}}*{color:inherit;background-color:inherit;font-family:inherit}body{min-height:100vh;font-family:Arial,sans-serif;color:var(--text-color);background-color:var(--background-color);border-color:var(--text-color)}
</style>
</head>

<body>
  <div id="transporter"></div>
</body>

</html>