<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sequencer</title>
  <script type="module" crossorigin>var Uo=Object.defineProperty;var Ot=p=>{throw TypeError(p)};var Ho=(p,f,h)=>f in p?Uo(p,f,{enumerable:!0,configurable:!0,writable:!0,value:h}):p[f]=h;var y=(p,f,h)=>Ho(p,typeof f!="symbol"?f+"":f,h),ut=(p,f,h)=>f.has(p)||Ot("Cannot "+h);var s=(p,f,h)=>(ut(p,f,"read from private field"),h?h.call(p):f.get(p)),C=(p,f,h)=>f.has(p)?Ot("Cannot add the same private member more than once"):f instanceof WeakSet?f.add(p):f.set(p,h),u=(p,f,h,m)=>(ut(p,f,"write to private field"),m?m.call(p,h):f.set(p,h),h),st=(p,f,h)=>(ut(p,f,"access private method"),h);(async()=>{var P,F,q,G,L,$,Q,_,z,N,U,Z,H,T,j,Y,V,at,E,I,x;(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))e(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&e(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function e(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();var p=(o=>(o[o.Dom=0]="Dom",o[o.Midi=1]="Midi",o))(p||{}),f=(o=>(o[o.Dom=0]="Dom",o[o.Midi=1]="Midi",o))(f||{}),h=(o=>(o[o.Log=0]="Log",o[o.Dom=1]="Dom",o[o.Midi=2]="Midi",o))(h||{}),m=(o=>(o[o.Playing=0]="Playing",o[o.Paused=1]="Paused",o[o.Stopped=2]="Stopped",o))(m||{}),D=(o=>(o[o.Play=0]="Play",o[o.Pause=1]="Pause",o[o.Resume=2]="Resume",o[o.Stop=3]="Stop",o))(D||{}),g=(o=>(o[o.Compute=0]="Compute",o[o.NoteOn=1]="NoteOn",o[o.NoteOff=2]="NoteOff",o))(g||{});function l(o,t={},...e){const n=document.createElement(o);for(const[i,r]of Object.entries(t))n.setAttribute(i,r);for(const i of e)typeof i=="string"?n.appendChild(document.createTextNode(i)):i&&n.appendChild(i);return n}const A=await navigator.requestMIDIAccess({sysex:!0}).catch(()=>null);function Dt(o,t,e){const n=[];if(!A)return n.push(`The ${o} cannot be type MIDI without MIDI access`),n;const i=A[e].values(),r=Array.from(i);return r?(r.find(({name:a})=>a===t)||n.push(`No MIDI ${e} named ${t} for ${o}`),n):(n.push(`No MIDI ${e}`),n)}function Pt(o,t){const e=[],{output:n,channel:i}=t;return n?e.push(...Dt(o,n,"outputs")):e.push(`No MIDI output for ${o}`),i?(i<1||i>16)&&e.push(`Invalid MIDI channel for ${o}: ${i}`):e.push(`No MIDI channel for ${o}`),e}function xt(o){const t=[];return o.type===void 0?(t.push("No transporter type"),t):(o.type in p||t.push(`Invalid transporter type: ${o.type}`),t)}function Nt(o,t){const e=[];return t.type===void 0?(e.push(`No controller type for ${o} part`),e):(t.type in f||e.push(`Invalid controller type for ${o} part: ${t.type}`),e)}function It(o,t){const e=[];if(t.type===void 0)return e.push(`No synthesizer type for ${o} part`),e;if(t.type in h||e.push(`Invalid synthesizer type for ${o} part: ${t.type}`),t.type===h.Midi){if(!A)return e.push("No MIDI access"),e;const{midi:n}=t;if(!n)return e.push("No MIDI config"),e;e.push(...Pt(`${o} synthesizer`,n))}return e}function At(o,t){const e=[],{controller:n,synthesizer:i}=t;return n?e.push(...Nt(o,n)):e.push(`No controller for ${o} part`),i?e.push(...It(o,i)):e.push(`No synthesizer for ${o} part`),e}function kt(o){const t=[],e=["bass","drum","keys","lead"];for(const n of e){const i=o[n];if(!i){t.push(`No ${n} part`);continue}t.push(...At(n,i))}return t}function Mt(o){const t=[],{transporter:e,parts:n}=o;return e?t.push(...xt(e)):t.push("No transporter"),n?t.push(...kt(n)):t.push("No parts"),t}const qt=[["DOM",p.Dom]],St=[["DOM",f.Dom]],Ft=[["DOM",h.Dom],["MIDI",h.Midi]],W={CONFIG_FORM_ID:"config-form",TRANSPORTER_CONFIG_ID:"transporter-config",PART_CONFIG_CLASS:"part-config",TYPE_DIV_CLASS:"type-div",MIDI_DIV_CLASS:"midi-div",MIDI_OUTPUT_SELECT_CLASS:"midi-output-select",REMEMBER_CHECKBOX_ID:"remember-config"};function Gt(o,t){if(!o.div)throw new Error("setUpRadioButtons called before render");const e=Array.from(o.div.querySelectorAll('input[type="radio"]'));for(const n of e)for(const[i,r]of t)n.addEventListener("change",()=>{if(!r.div)throw new Error("setUpRadioButtons called before render");r.div.classList[Number(n.value)===i?"remove":"add"]("hidden")})}class lt{constructor(t,e,n){y(this,"name");y(this,"title");y(this,"typeNamesAndEnums");y(this,"inputs");y(this,"div");this.name=t,this.title=e,this.typeNamesAndEnums=n,this.inputs={},this.div=null}render(){const t=this.typeNamesAndEnums.map(([e,n])=>{const i=`${this.name}-${e}`,r=l("input",{id:i,type:"radio",name:this.name,value:n}),a=l("label",{for:i},e);return this.inputs[n]=r,[r,a]}).flat();return this.div=l("div",{class:W.TYPE_DIV_CLASS},this.title,...t)}getConfig(){if(!this.div)throw new Error("getConfig called before render");return Number(this.div.querySelector('input[type="radio"]:checked').value)}}class Lt{constructor(){y(this,"select",null);y(this,"input",null);y(this,"div",null)}render(){const t=this.select=l("select",{class:W.MIDI_OUTPUT_SELECT_CLASS}),e=this.input=l("input",{type:"number",name:"channel",min:1,max:16,value:1});return this.div=l("div",{},t," on channel ",e)}getConfig(){if(!this.select||!this.input)throw new Error("getConfig called before render");return{output:this.select.value,channel:this.input.value}}}class $t{constructor(){y(this,"typeConfig",new lt("transporter-type","Type: ",qt))}render(){const t=l("legend",{},"TRANSPORTER"),e=this.typeConfig.render();return l("fieldset",{id:W.TRANSPORTER_CONFIG_ID},t,e)}setUp(){}getConfig(){const t={};return t.type=this.typeConfig.getConfig(),t}}class Tt{constructor(t){y(this,"typeConfig");y(this,"div",null);this.typeConfig=new lt(`${t}-controller-type`,"Controller: ",St)}render(){const t=this.typeConfig.render();return this.div=l("div",{},t)}setUp(){}getConfig(){const t={};return t.type=this.typeConfig.getConfig(),t}}class jt{constructor(t){y(this,"typeConfig");y(this,"midiConfig",new Lt);this.typeConfig=new lt(`${t}-synthesizer-type`,"Synthesizer: ",Ft)}render(){const t=this.typeConfig.render(),e=this.midiConfig.render();return l("div",{},t,e)}setUp(){Gt(this.typeConfig,[[h.Midi,this.midiConfig]])}getConfig(){const t={};return(t.type=this.typeConfig.getConfig())===h.Midi&&(t.midi=this.midiConfig.getConfig()),t}}class ot{constructor(t){y(this,"name");y(this,"controllerConfig");y(this,"synthesizerConfig");this.name=t,this.controllerConfig=new Tt(t),this.synthesizerConfig=new jt(t)}render(){const t=l("legend",{},this.name.toUpperCase()),e=this.controllerConfig.render(),n=l("hr"),i=this.synthesizerConfig.render();return l("fieldset",{},t,e,n,i)}setUp(){this.controllerConfig.setUp(),this.synthesizerConfig.setUp()}getConfig(){return{controller:this.controllerConfig.getConfig(),synthesizer:this.synthesizerConfig.getConfig()}}}class Rt{constructor(){y(this,"div",null)}render(){return this.div=l("div",{class:"problem-div"})}addProblems(t){if(!this.div)throw new Error("addProblems called before render");const e=this.div;e.innerHTML="";for(const n of t){const i=l("p",{},n);e.appendChild(i)}}}class Bt{constructor(){y(this,"refreshButton",null);y(this,"problemDiv",new Rt)}render(){const t=this.refreshButton=l("button",{type:"button"},"Refresh MIDI Ports"),e=l("button",{type:"submit"},"Submit"),n=this.problemDiv.render();return l("div",{},t,e,n)}setUp(){}}class _t{constructor(){y(this,"transporterConfig",new $t);y(this,"partConfigs",{bass:new ot("bass"),drum:new ot("drum"),keys:new ot("keys"),lead:new ot("lead")});y(this,"miscellaneousDiv",new Bt);y(this,"form",null)}render(){const t=this.transporterConfig.render(),e=Object.values(this.partConfigs).map(i=>i.render()),n=this.miscellaneousDiv.render();return this.form=l("form",{id:W.CONFIG_FORM_ID},t,...e,n)}setUp(){if(!this.form)throw new Error("setUp called before render");this.transporterConfig.setUp();for(const t of Object.values(this.partConfigs))t.setUp();if(!this.miscellaneousDiv.refreshButton)throw new Error("setUp called before render");this.miscellaneousDiv.refreshButton.addEventListener("mousedown",this.refreshMidi.bind(this)),this.refreshMidi(),this.clickAllFirstRadioButtons(),this.form.classList.remove("hidden")}getConfig(){return{transporter:this.transporterConfig.getConfig(),parts:{bass:this.partConfigs.bass.getConfig(),drum:this.partConfigs.drum.getConfig(),keys:this.partConfigs.keys.getConfig(),lead:this.partConfigs.lead.getConfig()}}}refreshMidi(){if(!this.form)throw new Error("refreshMidi called before render");const t=Array.from(this.form.querySelectorAll('input[type="radio"][value="midi"]'));for(const n of t)n.disabled=!A;if(!A)return;function e(n,i){const r=document.getElementsByClassName(n),a=Array.from(A[i].values()).map(c=>c.name);for(const c of r){const d=c.value||a[0];c.innerHTML="";for(const v of a){const w=l("option",{value:v},v);c.appendChild(w)}a.includes(d)&&(c.value=d)}}e(W.MIDI_OUTPUT_SELECT_CLASS,"outputs")}clickAllFirstRadioButtons(){if(!this.form)throw new Error("clickAllFirstRadioButtons called before render");const t=Array.from(this.form.querySelectorAll('input[type="radio"]:enabled:first-of-type'));for(const e of t)e.click()}getPromise(){return new Promise(t=>{if(!this.form)throw new Error("getPromise called before render");this.form.addEventListener("submit",e=>{if(!this.form)throw new Error("submit event listener called after form was removed");e.preventDefault();const n=this.getConfig(),i=Mt(n);this.miscellaneousDiv.problemDiv.addProblems(i),!i.length&&(this.form.remove(),t(n))})})}}async function zt(){const o=new _t;return document.body.append(o.render()),o.setUp(),await o.getPromise()}const Ut=async()=>await zt();function Ht(o){const t=l("h2"),e={previous:l("button",{class:"transporter-button"},"\u23EE"),play:l("button",{class:"transporter-button"},"\u25B6"),pause:l("button",{class:"transporter-button"},"\u23F8"),stop:l("button",{class:"transporter-button"},"\u23F9"),next:l("button",{class:"transporter-button"},"\u23ED")};o.connect=(r,a)=>{e.previous.addEventListener("click",()=>r.goPrevious()),e.next.addEventListener("click",()=>r.goNext()),e.play.addEventListener("click",()=>a.play()),e.pause.addEventListener("click",()=>a.pause()),e.stop.addEventListener("click",()=>a.stop())},o.changeChart=(r,a,c)=>{t.innerText=r,e.previous.disabled=!a,e.next.disabled=!c},o.changePlayback=r=>{e.play.disabled=r===m.Playing,e.pause.disabled=r!==m.Playing,e.stop.disabled=r===m.Stopped};const n=l("div",{},...Object.values(e)),i=l("div",{id:"transporter"},t,n);o.render=()=>i}class Yt{constructor(t){switch(t.type){case p.Dom:Ht(this);break;default:throw new Error(`Invalid Transporter type: ${t}`)}}connect(t,e){}changeChart(t,e,n){}changePlayback(t){}render(){return null}}function*Vt(...o){const t=o.map(e=>({generator:e,result:e.next()})).filter(({result:e})=>!e.done).map(({generator:e,result:n})=>({generator:e,value:n.value}));for(t.sort((e,n)=>e.value.time-n.value.time);t.length>0;){const e=t.shift();if(e===void 0)return;yield e.value;const{value:n,done:i}=e.generator.next();if(!i){const r=t.findIndex(a=>a.value.time>n.time);r===-1?t.push({generator:e.generator,value:n}):t.splice(r,0,{generator:e.generator,value:n})}}}function X(o){return 6e4/o}function k(o,t,e,n){if(o===-1/0||o===1/0)return o;const i=o%n,r=n*Math.floor(o/n),a=i<n/2?(e+1)*i:(1-e)*i+e*n;return(r+a)*t}function J(o){return Math.max(o-.1,o*.9)}const Kt=/[CDEFGAB]/,Wt=/♮|b{1,2}|#{1,2}/,Xt=/-?[0-8]/,Jt=/[CDEFGAB](♮|b{1,2}|#{1,2})?/;function R(o){var v,w,b,K;const t=(v=o.match(Jt))==null?void 0:v[0];if(t===void 0)throw new Error(`Invalid pitch class: ${o}`);const e=(w=t.match(Kt))==null?void 0:w[0];if(e===void 0)throw new Error(`Invalid pitch letter: ${t}`);const n={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[e];if(n===void 0)throw new Error(`Invalid pitch letter: ${t}`);const i=((b=t.match(Wt))==null?void 0:b[0])||"\u266E",r={"\u266E":0,b:-1,bb:-2,"#":1,"##":2}[i];if(r===void 0)throw new Error(`Invalid accidental: ${t}`);const a=Number((K=o.match(Xt))==null?void 0:K[0]);if(isNaN(a))throw new Error(`Invalid octave: ${t}`);const c=(a+1)*12,d=n+r+c;if(d<0||d>127)throw new Error(`Out of MIDI range: ${t}`);return d}var S=(o=>(o[o.pp=21]="pp",o[o.p=41]="p",o[o.mp=61]="mp",o[o.mf=81]="mf",o[o.f=101]="f",o[o.ff=121]="ff",o[o.fff=127]="fff",o))(S||{});const Qt=100,Zt=5,to=120,dt=["C2","D2","E2","F2","G2","A2","B2","C3"],oo=S.mf,eo=2,pt=X(to),no=dt.map(R),io={title:"Bass Scale",compose:function*({bass:o}){for(const[t,e]of no.entries()){const n=t*pt,i=t===dt.length-1?eo:1,r=(t+J(i))*pt;yield{time:n,type:g.NoteOn,part:o,pitch:e,velocity:oo},yield{time:r,type:g.NoteOff,part:o,pitch:e}}}},ro=118,ht=(()=>{const o={"1-16":{length:64,melody:[["C5",0,1],["B4",1,1],["A4",2,.5],["G4",2.5,1.5],["F4",4,1.5],["G4",5.5,.5],["A4",6,1],["C5",7,1],["B4",8,1],["A4",9,1],["G4",10,.5],["F4",10.5,1.5],["E4",12,4],["A4",16,1],["G4",17,1],["F4",18,.5],["E4",18.5,1.5],["D4",20,1.5],["E4",21.5,.5],["F4",22,1],["A4",23,1],["G#4",24,1],["F4",25,1],["E4",26,.5],["D4",26.5,1.5],["C4",28,3],["C#4",31,1],["D4",32,.5],["A4",32.5,1],["A4",33.5,3.5],["C5",37,2],["B4",39,1],["G4",40,7],["B3",47,1],["C4",48,.5],["F4",48.5,1],["F4",49.5,3.5],["A4",53,2],["G4",55,1],["F4",56,2],["E4",58,7]],chords:[{root:"A",quality:"minor",extension:"7",position:0,duration:4},{root:"D",quality:"minor",extension:"7",position:4,duration:4},{root:"G",quality:"major",extension:"7",position:8,duration:4},{root:"C",quality:"major",extension:"maj7",position:12,duration:2},{root:"C",quality:"major",extension:"7",position:14,duration:2},{root:"F",quality:"major",extension:"7",position:16,duration:4},{root:"B",quality:"minor",extension:"7(b5)",position:20,duration:4},{root:"E",quality:"minor",extension:"7",position:24,duration:4},{root:"A",quality:"minor",extension:"7",position:28,duration:2},{root:"A",quality:"major",extension:"7",position:30,duration:2},{root:"D",quality:"minor",extension:"7",position:32,duration:4},{root:"G",quality:"major",extension:"7",position:36,duration:4},{root:"C",quality:"major",extension:"maj7",position:40,duration:4},{root:"E",quality:"minor",extension:"7",position:44,duration:2},{root:"A",quality:"minor",extension:"7",position:46,duration:2},{root:"D",quality:"minor",extension:"7",position:48,duration:4},{root:"G",quality:"major",extension:"7",position:52,duration:4},{root:"F",quality:"major",extension:"6",position:56,duration:2},{root:"C",quality:"major",extension:"maj7",position:58,duration:2},{root:"B",quality:"minor",extension:"7(b5)",position:60,duration:2},{root:"E",quality:"minor",extension:"7",position:62,duration:2}]},"17-26":{length:40,melody:[["C5",0,1],["B4",1,1],["A4",2,.5],["G4",2.5,1.5],["F4",4,1.5],["G4",5.5,.5],["A4",6,1],["C5",7,1],["B4",8,1],["A4",9,1],["G4",10,.5],["F4",10.5,1.5],["E4",12,4],["A4",16,1],["G4",17,1],["F4",18,.5],["E4",18.5,1.5],["D4",20,1],["E4",21,1],["F4",22,1],["A4",23,1],["G#4",24,1],["F4",25,1],["E4",26,.5],["D4",26.5,1.5],["C4",28,3],["C#4",31,1],["D4",32,.5],["A4",32.5,1],["A4",33.5,3.5],["C5",37,2],["B4",39,1]],chords:[{root:"A",quality:"minor",extension:"7",position:0,duration:4},{root:"D",quality:"minor",extension:"7",position:4,duration:4},{root:"G",quality:"major",extension:"7",position:8,duration:4},{root:"C",quality:"major",extension:"maj7",position:12,duration:2},{root:"C",quality:"major",extension:"7",position:14,duration:2},{root:"F",quality:"major",extension:"maj7",position:16,duration:4},{root:"B",quality:"minor",extension:"7(b5)",position:20,duration:4},{root:"E",quality:"minor",extension:"7",position:24,duration:4},{root:"A",quality:"minor",extension:"7",position:28,duration:2},{root:"A",quality:"major",extension:"7",position:30,duration:2},{root:"D",quality:"minor",extension:"7",position:32,duration:4},{root:"G",quality:"major",extension:"7",position:36,duration:4}]},"27-32":{length:24,melody:[["G4",0,7],["G#4",7,1],["A4",8,.5],["C4",8.5,1],["C4",9.5,3.5],["C4",13,2],["D4",15,1],["C4",16,4]],chords:[{root:"E",quality:"minor",extension:"7",position:0,duration:4},{root:"A",quality:"minor",extension:"7",position:4,duration:4},{root:"D",quality:"minor",extension:"7",position:8,duration:4},{root:"G",quality:"major",extension:"7",position:12,duration:4},{root:"C",quality:"major",extension:"6",position:16,duration:4},{root:"B",quality:"minor",extension:"7(b5)",position:20,duration:2},{root:"E",quality:"minor",extension:"7",position:22,duration:2}]},"33-38":{length:24,melody:[["E5",0,7],["C5",7,1],["D5",8,.5],["A4",8.5,1],["A4",9.5,3.5],["B4",13,2],["D5",15,1],["C5",16,7]],chords:[{root:"E",quality:"minor",extension:"7",position:0,duration:4},{root:"A",quality:"minor",extension:"7",position:4,duration:4},{root:"D",quality:"minor",extension:"7",position:8,duration:4},{root:"G",quality:"major",extension:"7",position:12,duration:4},{root:"C",quality:"major",extension:"6",position:16,duration:8}]}},t=["1-16","17-26","27-32","1-16","17-26","33-38"],e=[],n=[];let i=0;for(const r of t){const a=o[r],c=a.length,d=a.melody,v=a.chords;for(const[w,b,K]of d)e.push([w,b+i,K]);for(const w of v)n.push({...w,position:w.position+i});i+=c}return{length:i,melody:e,chords:n}})(),et=S.mf,M=X(ro);function*so(o){const t=R("E1"),e=.2,n=1;function i(r){return r>=t?r:i(r+12)}for(const{root:r,quality:a,extension:c,position:d,duration:v}of ht.chords){const w=R(`${r}1`),b=i(w),K=a==="major"?b+4:b+3,rt=c==="7(b5)"?b+6:b+7,zo=c==="6"?b+9:c==="7"?b+10:c==="maj7"?b+11:c==="7(b5)"?b+10:b+12,ct=J(1);if(v===4){console.log("chord",r,a,c,d,v);for(const[O,tt]of[b,K,rt,zo].entries())yield{type:g.NoteOn,time:k(d+O,M,e,n),part:o,pitch:tt,velocity:et},yield{type:g.NoteOff,time:k(d+O+ct,M,e,n),part:o,pitch:tt}}else if(v===2){console.log("chord",r,a,c,d,v);for(const[O,tt]of[b,rt].entries())yield{type:g.NoteOn,time:k(d+O,M,e,n),part:o,pitch:tt,velocity:et},yield{type:g.NoteOff,time:k(d+O+ct,M,e,n),part:o,pitch:tt}}else{console.log("chord",r,a,c,d,v);for(let O=0;O<v;O+=1)yield{type:g.NoteOn,time:k(d+O,M,e,n),part:o,pitch:O%2===0?b:rt,velocity:et},yield{type:g.NoteOff,time:k(d+O+ct,M,e,n),part:o,pitch:O%2===0?b:rt}}}}function*ao(o){for(const[t,e,n]of ht.melody){const i=R(t),r=k(e,M,.25,1),a=k(e+J(n),M,.25,1);yield{type:g.NoteOn,time:r,part:o,pitch:i,velocity:et},yield{type:g.NoteOff,time:a,part:o,pitch:i}}}const lo={title:"Fly Me to the Moon",compose:function*({bass:o,lead:t}){for(const e of Vt(so(o),ao(t)))yield e}},ft=60,co=S.mf,uo=4e3,po={title:"Hello World",compose:function*({lead:o}){yield{time:0,type:g.NoteOn,part:o,pitch:ft,velocity:co},yield{time:uo,type:g.NoteOff,part:o,pitch:ft}}},ho=60,fo=240,mo=33,yo=32,go=S.f,Co={title:"Metronome",compose:function*({drum:o}){const t=o.controller.getRangeControl("Tempo: ",ho,fo," BPM");let e=0,n=0;for(;;){const i=n===0?mo:yo;yield{time:e,type:g.NoteOn,part:o,pitch:i,velocity:go},yield{time:e+Zt,type:g.NoteOff,part:o,pitch:i},e+=X(t.value),n=(n+1)%4}}},vo=165,mt=["E3","G3","A3","G3","D4","C4","D4","E4"],bo=2,wo=S.mf,Eo=X(vo),yt=bo*Eo,gt=yt/mt.length,Oo=mt.map((o,t)=>{const e=R(o),n=t*gt,i=n+J(gt);return[e,n,i]}),Do={title:"On the Run",compose:function*({lead:o}){const t=o.controller.getOptionControl("Repeat again: ",["No","Yes"],"!");yield{time:-1/0,type:g.Compute};let e=0;for(;t.value;){for(const[n,i,r]of Oo)yield{time:e+i,type:g.NoteOn,part:o,pitch:n,velocity:wo},yield{time:e+r,type:g.NoteOff,part:o,pitch:n};e+=yt}}},Po=120,xo=[["C4",0,.9],["C4",1,.9],["G4",2,.9],["G4",3,.9],["A4",4,.9],["A4",5,.9],["G4",6,1.9],["F4",8,.9],["F4",9,.9],["E4",10,.9],["E4",11,.9],["D4",12,.9],["D4",13,.9],["C4",14,1.9],["G4",16,.9],["G4",17,.9],["F4",18,.9],["F4",19,.9],["E4",20,.9],["E4",21,.9],["D4",22,1.9],["G4",24,.9],["G4",25,.9],["F4",26,.9],["F4",27,.9],["E4",28,.9],["E4",29,.9],["D4",30,1.9],["C4",32,.9],["C4",33,.9],["G4",34,.9],["G4",35,.9],["A4",36,.9],["A4",37,.9],["G4",38,1.9],["F4",40,.9],["F4",41,.9],["E4",42,.9],["E4",43,.9],["D4",44,.9],["D4",45,.9],["C4",46,2]],No=S.mf,Ct=X(Po),Io=xo.map(([o,t,e])=>{const n=R(o),i=t*Ct,r=(t+J(e))*Ct;return[n,i,r]}),Ao={title:"Twinkle Twinkle Little Star",compose:function*({lead:o}){const t=o.controller.getRangeControl("8va chance: ",0,100,"%");for(const[e,n,i]of Io){yield{time:n-Qt,type:g.Compute};const r=t.value>Math.random()*100?e+12:e;yield{time:n,type:g.NoteOn,part:o,pitch:r,velocity:No},yield{time:i,type:g.NoteOff,part:o,pitch:r}}}},vt=[po,io,Co,Ao,Do,lo],bt=vt.length;class ko{constructor(){C(this,P,0);C(this,F,()=>{})}goPrevious(){s(this,P)>0&&(u(this,P,s(this,P)-1),s(this,F).call(this))}goNext(){s(this,P)<bt-1&&(u(this,P,s(this,P)+1),s(this,F).call(this))}connect(t,e){u(this,F,()=>{const n=vt[s(this,P)],i=n.title,r=s(this,P)>0,a=s(this,P)<bt-1;t.changeChart(i,r,a),e.changeChart(n)})}start(){s(this,F).call(this)}}P=new WeakMap,F=new WeakMap;const wt=12,B={min:0,max:127,step:1,default:63};class Mo{constructor(){C(this,q);C(this,G);C(this,L,()=>{});C(this,$,()=>0);const t=l("span",{},"EMPTY");u(this,q,{0:l("span",{},"%%"),1:t,2:l("span",{},"%%")}),u(this,G,l("input",{type:"range",min:B.min,max:B.max,step:B.step,value:B.default})).addEventListener("input",()=>{s(this,L).call(this)})}clear(){u(this,$,()=>0),u(this,L,()=>{});const t=Object.values(s(this,q));for(const e of t)e.textContent=""}get value(){return s(this,$).call(this)}makeIntoRangeControl(t,e,n,i=""){const r=s(this,q),a=r[1],c=s(this,G);r[0].textContent=t,r[2].textContent=i;const d=u(this,$,()=>e+Math.round((n-e)*Number(c.value)/B.max));u(this,L,()=>{a.textContent=d().toString()})()}makeIntoOptionControl(t,e,n=""){const i=s(this,q),r=i[1],a=s(this,G);i[0].textContent=t,i[2].textContent=n;const c=u(this,$,()=>Math.round((e.length-1)*Number(a.value)/B.max));u(this,L,()=>{r.textContent=e[c()]})()}render(){const t=l("label",{class:"lcd"},...Object.values(s(this,q)));return l("div",{class:"controller-module"},t,s(this,G))}}q=new WeakMap,G=new WeakMap,L=new WeakMap,$=new WeakMap;function qo(o){const t=Array.from({length:wt},()=>new Mo);let e=0;o.clear=()=>{t.forEach(i=>i.clear()),e=0};function n(){if(e>=wt)throw new Error("No more controllers available");const i=t[e];return e+=1,i}o.getRangeControl=(i,r,a,c="")=>{const d=n();return d.makeIntoRangeControl(i,r,a,c),d},o.getOptionControl=(i,r,a="")=>{const c=n();return c.makeIntoOptionControl(i,r,a),c},o.render=()=>{const i=l("h2",{class:"component-title"},"Controller"),r=t.map(c=>c.render()),a=l("div",{class:"controller-row"},...r);return i.addEventListener("click",()=>{a.classList.toggle("hidden")}),a.classList.add("hidden"),l("div",{class:"controller"},i,a)}}class So{constructor(t,e){switch(e.type){case f.Dom:qo(this);break;default:throw new Error(`Invalid Controller type: ${e}`)}}clear(){}getRangeControl(t,e,n,i=""){return{value:0}}getOptionControl(t,e,n=""){return{value:0}}render(){return null}}function Fo(o){o.noteOn=(t,e,n)=>{console.log("noteOn",t,n,e)},o.noteOff=(t,e)=>{console.log("noteOff",t,e)},o.allNotesOff=()=>{console.log("allNotesOff")}}function Go(o){const t=l("h2",{class:"component-title"},"Synthesizer"),e=l("button",{},"Clear"),n=l("div",{class:"message-row"}),i=l("div",{class:"synthesizer-row"},e,n),r=l("div",{class:"synthesizer"},t,i);function a(c,d){const v=l("div",{class:d},c);n.appendChild(v),n.scrollTop=n.scrollHeight}o.noteOn=(c,d,v,w=!0)=>{w&&o.currentlyPlayingPitches.push(c),a(`noteOn ${c} ${d} ${v.toFixed(0)}, scheduled at: ${window.performance.now().toFixed(0)}`,"note-on")},o.noteOff=(c,d,v=!0)=>{a(`noteOff ${c} ${d.toFixed(0)}, scheduled at: ${window.performance.now().toFixed(0)}`,"note-off"),v&&(o.currentlyPlayingPitches=o.currentlyPlayingPitches.filter(w=>w!==c))},o.allNotesOff=()=>{a("allNotesOff","all-notes-off"),o.currentlyPlayingPitches=[]},e.addEventListener("click",()=>{n.innerHTML=""}),t.addEventListener("click",()=>{i.classList.toggle("hidden")}),i.classList.add("hidden"),o.render=()=>r}function Lo(o,t){if(!A)throw new Error("No MIDI access");const e=A.outputs.values().find(i=>i.name===t.midi.output);if(!e)throw new Error(`No MIDI output named ${t.midi.output}`);const n=t.midi.channel-1;o.noteOn=(i,r,a,c=!0)=>{c&&o.currentlyPlayingPitches.push(i),e.send([144+n,i,r],a)},o.noteOff=(i,r,a=!0)=>{e.send([128+n,i,0],r),a&&(o.currentlyPlayingPitches=o.currentlyPlayingPitches.filter(c=>c!==i))},o.allNotesOff=()=>{setTimeout(()=>{e.send([176+n,123,0]),o.currentlyPlayingPitches=[]},it)}}class $o{constructor(t,e){y(this,"currentlyPlayingPitches",[]);switch(e.type){case h.Log:Fo(this);break;case h.Dom:Go(this);break;case h.Midi:Lo(this,e);break}}noteOn(t,e,n,i=!0){}noteOff(t,e,n=!0){}allNotesOff(){}pause(){const t=window.performance.now();for(const e of this.currentlyPlayingPitches)this.noteOff(e,t+it,!1)}resume(){const t=window.performance.now();for(const e of this.currentlyPlayingPitches)this.noteOn(e,31,t,!1)}render(){return null}}class nt{constructor(t,e){C(this,Q);y(this,"controller");y(this,"synthesizer");u(this,Q,t),this.controller=new So(t,e.controller),this.synthesizer=new $o(t,e.synthesizer)}render(){const t=this.controller.render(),e=this.synthesizer.render();if(!t&&!e)return null;const n=l("h2",{},s(this,Q).toUpperCase()),i=l("div",{class:"part"},n,t,e);return n.addEventListener("click",()=>{console.log("click"),console.log(t),t&&t.classList.toggle("hidden"),e&&e.classList.toggle("hidden")}),i}}Q=new WeakMap;function To(o){return{bass:new nt("bass",o.bass),drum:new nt("drum",o.drum),keys:new nt("keys",o.keys),lead:new nt("lead",o.lead)}}const it=100;class jo{constructor(t,e){C(this,V);C(this,_);C(this,z);C(this,N);C(this,U,0);C(this,Z,()=>{});C(this,H,function*(){}());C(this,T,0);C(this,j,0);C(this,Y,null);u(this,_,t),u(this,z,To(e)),u(this,N,Object.values(s(this,z)))}changeChart(t){u(this,Z,()=>{for(const e of s(this,N))e.controller.clear();u(this,H,t.compose(s(this,z))),u(this,Y,s(this,H).next().value)})()}play(){u(this,T,window.performance.now()+it),u(this,j,0),st(this,V,at).call(this)}pause(){clearTimeout(s(this,U)),u(this,j,window.performance.now()-s(this,T));for(const t of s(this,N))t.synthesizer.pause()}resume(){u(this,T,window.performance.now()-s(this,j));for(const t of s(this,N))t.synthesizer.resume();st(this,V,at).call(this)}stop(){clearTimeout(s(this,U)),u(this,j,0),s(this,Z).call(this);for(const t of s(this,N))t.synthesizer.allNotesOff()}render(){const t=s(this,N).map(e=>e.render());return t.some(e=>e!==null)?l("div",{id:"part-container"},...t):null}}_=new WeakMap,z=new WeakMap,N=new WeakMap,U=new WeakMap,Z=new WeakMap,H=new WeakMap,T=new WeakMap,j=new WeakMap,Y=new WeakMap,V=new WeakSet,at=function(){const t=s(this,Y);if(t===null){console.error("nextEvent is null"),s(this,_).stop();return}const e=t.time+s(this,T),n=e-window.performance.now()-it;u(this,U,setTimeout(()=>{switch(t.type){case g.Compute:break;case g.NoteOn:t.part.synthesizer.noteOn(t.pitch,t.velocity,e);break;case g.NoteOff:t.part.synthesizer.noteOff(t.pitch,e);break}const i=s(this,H).next();if(i.done){s(this,_).stop();return}u(this,Y,i.value),st(this,V,at).call(this)},n))};class Ro{constructor(t){C(this,E,m.Paused);C(this,I,()=>{});C(this,x);u(this,x,new jo(this,t))}changeChart(t){s(this,x).changeChart(t),s(this,E)!=m.Stopped&&this.stop()}play(){switch(s(this,E)){case m.Playing:break;case m.Paused:s(this,I).call(this,D.Resume),u(this,E,m.Playing);break;case m.Stopped:s(this,I).call(this,D.Play),u(this,E,m.Playing);break}}pause(){switch(s(this,E)){case m.Playing:s(this,I).call(this,D.Pause),u(this,E,m.Paused);break;case m.Paused:break;case m.Stopped:break}}stop(){switch(s(this,E)){case m.Playing:s(this,I).call(this,D.Stop),u(this,E,m.Stopped);break;case m.Paused:s(this,I).call(this,D.Stop),u(this,E,m.Stopped);break;case m.Stopped:break}}connect(t){u(this,I,e=>{switch(e){case D.Play:s(this,x).play(),t.changePlayback(m.Playing);break;case D.Pause:s(this,x).pause(),t.changePlayback(m.Paused);break;case D.Resume:s(this,x).resume(),t.changePlayback(m.Playing);break;case D.Stop:s(this,x).stop(),t.changePlayback(m.Stopped);break}})}render(){return s(this,x).render()}}E=new WeakMap,I=new WeakMap,x=new WeakMap;function Et(o){o&&document.body.append(o)}function Bo(o){const t=new Yt(o.transporter),e=new ko,n=new Ro(o.parts);t.connect(e,n),e.connect(t,n),n.connect(t);const i=t.render(),r=n.render();Et(i),Et(r),e.start()}const _o=await Ut();Bo(_o)})();
</script>
  <style rel="stylesheet" crossorigin>:root{--red: #b23535;--green: #38ad5f;--blue: #464ca5;--white: #eeeade;--black: #282828;--text-color: var(--black);--background-color: var(--white)}@media (prefers-color-scheme: dark){:root{--text-color: var(--white);--background-color: var(--black)}}*{color:inherit;background-color:inherit;border-color:inherit;font-family:inherit;box-sizing:inherit}body{min-height:100vh;font-family:Arial,sans-serif;color:var(--text-color);background-color:var(--background-color);border-color:var(--text-color);box-sizing:border-box;padding:0;margin:0}#config-form{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}fieldset{margin-bottom:20px}legend{font-weight:700;margin-bottom:10px}.type-div{margin-bottom:10px}label{-webkit-user-select:none;user-select:none}input[type=radio]:disabled+label{text-decoration:line-through}button{color:var(--text-color);background-color:var(--background-color);border:1px solid var(--text-color);cursor:pointer;transition:background-color .3s ease}button:hover{background-color:var(--text-color);color:var(--background-color)}.transporter-button{width:2em;height:2em;border:1.5px solid;border-radius:50%;font-size:2.5rem;padding:1rem;margin:0 .5rem 2rem;cursor:pointer;color:var(--background-color);background-color:var(--text-color);transition:transform .2s}.transporter-button:hover:enabled{transform:scale(1.1)}.transporter-button:disabled{color:var(--text-color);background-color:var(--background-color);cursor:auto}#transporter{text-align:center;border-bottom:1px solid var(--text-color)}.lcd{padding:.5em 1em;border-radius:5px;width:16ch;min-height:4em;line-height:1.5;text-align:left;font-family:hd44780,monospace;color:var(--background-color);background-color:var(--text-color)}input[type=range]{margin-top:1em;width:100%}.controller-module{padding:1em;display:flex;flex-direction:column;align-items:center;border:1px solid;font-size:1vw}.component-title{margin-top:0;margin-bottom:0;width:100%;height:3rem;line-height:3rem;cursor:pointer;-webkit-user-select:none;user-select:none}.controller-row{border-top:1px solid;justify-content:center;align-items:center;overflow-y:scroll;height:40vw}.controller{padding-top:0;border:1px solid}.note-on{color:var(--green)}.note-off{color:var(--red)}.all-notes-off{color:var(--blue)}.message-row{width:100%;height:10vw;overflow-y:scroll}.synthesizer-row{width:100%}.synthesizer{display:flex;flex-direction:column;align-items:center;width:100%;border:1px solid}.part{text-align:center;border:1px solid;min-width:20%}#part-container{display:flex;flex-wrap:wrap;justify-content:space-around;align-items:start}.hidden{display:none}
</style>
</head>

<body>
</body>

</html>