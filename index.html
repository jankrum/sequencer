<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sequencer</title>
  <script type="module" crossorigin>var qe=Object.defineProperty;var It=d=>{throw TypeError(d)};var Fe=(d,f,y)=>f in d?qe(d,f,{enumerable:!0,configurable:!0,writable:!0,value:y}):d[f]=y;var p=(d,f,y)=>Fe(d,typeof f!="symbol"?f+"":f,y),Pt=(d,f,y)=>f.has(d)||It("Cannot "+y);var a=(d,f,y)=>(Pt(d,f,"read from private field"),y?y.call(d):f.get(d)),w=(d,f,y)=>f.has(d)?It("Cannot add the same private member more than once"):f instanceof WeakSet?f.add(d):f.set(d,y),h=(d,f,y,m)=>(Pt(d,f,"write to private field"),m?m.call(d,y):f.set(d,y),y);(async()=>{var M,T,S,_,$,G,W,J,q,k,F,L,Q,R,B,z,Z,pt,E,N,A;(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();var d=(e=>(e[e.Dom=0]="Dom",e[e.Midi=1]="Midi",e))(d||{}),f=(e=>(e[e.Dom=0]="Dom",e[e.Midi=1]="Midi",e))(f||{}),y=(e=>(e[e.Log=0]="Log",e[e.Dom=1]="Dom",e[e.Midi=2]="Midi",e))(y||{}),m=(e=>(e[e.Playing=0]="Playing",e[e.Paused=1]="Paused",e[e.Stopped=2]="Stopped",e))(m||{}),I=(e=>(e[e.Play=0]="Play",e[e.Pause=1]="Pause",e[e.Resume=2]="Resume",e[e.Stop=3]="Stop",e))(I||{}),b=(e=>(e[e.Finish=0]="Finish",e[e.NoteOn=1]="NoteOn",e[e.NoteOff=2]="NoteOff",e[e.Compute=3]="Compute",e))(b||{});function l(e,t={},...n){const i=document.createElement(e);for(const[o,s]of Object.entries(t))i.setAttribute(o,s);for(const o of n)typeof o=="string"?i.appendChild(document.createTextNode(o)):o&&i.appendChild(o);return i}const P=await navigator.requestMIDIAccess({sysex:!0}).catch(()=>null);function rt(e,t,n){const i=[];if(!P)return i.push(`The ${e} cannot be type MIDI without MIDI access`),i;const o=P[n].values(),s=Array.from(o);if(!s)return i.push(`No MIDI ${n}`),i;const r=s.find(({name:c})=>c===t);return console.log("port",r),r||i.push(`No MIDI ${n} named ${t} for ${e}`),i}function ht(e,t){const n=[],{input:i,output:o}=t;return i?n.push(...rt(e,i,"inputs")):n.push(`No MIDI input for ${e}`),o?n.push(...rt(e,o,"outputs")):n.push(`No MIDI output for ${e}`),n.length||i===o&&n.push(`Input and output are the same for ${e}`),n}function Ot(e,t){const n=[],{output:i,channel:o}=t;return i?n.push(...rt(e,i,"outputs")):n.push(`No MIDI output for ${e}`),o?(o<1||o>16)&&n.push(`Invalid MIDI channel for ${e}: ${o}`):n.push(`No MIDI channel for ${e}`),n}function Mt(e){const t=[];if(e.type===void 0)return t.push("No transporter type"),t;if(!(e.type in d))return t.push(`Invalid transporter type: ${e.type}`),t;if(e.type===d.Midi){if(!P)return t.push("No MIDI access"),t;const{midi:n}=e;if(!n)return t.push("No MIDI config"),t;t.push(...ht("Transporter",n))}return t}function kt(e,t){const n=[];if(t.type===void 0)return n.push(`No controller type for ${e} part`),n;if(!(t.type in f))return n.push(`Invalid controller type for ${e} part: ${t.type}`),n;if(t.type===f.Midi){if(!P)return n.push("No MIDI access"),n;const{midi:i}=t;if(!i)return n.push("No MIDI config"),n;n.push(...ht(`${e} controller`,i))}return n}function At(e,t){const n=[];if(t.type===void 0)return n.push(`No synthesizer type for ${e} part`),n;if(t.type in y||n.push(`Invalid synthesizer type for ${e} part: ${t.type}`),t.type===y.Midi){if(!P)return n.push("No MIDI access"),n;const{midi:i}=t;if(!i)return n.push("No MIDI config"),n;n.push(...Ot(`${e} synthesizer`,i))}return n}function xt(e,t){const n=[],{controller:i,synthesizer:o}=t;return i?n.push(...kt(e,i)):n.push(`No controller for ${e} part`),o?n.push(...At(e,o)):n.push(`No synthesizer for ${e} part`),n}function Nt(e){const t=[],n=["bass","drum","keys","lead"];for(const i of n){const o=e[i];if(!o){t.push(`No ${i} part`);continue}t.push(...xt(i,o))}return t}function St(e){const t=[],{transporter:n,parts:i}=e;return n?t.push(...Mt(n)):t.push("No transporter"),i?t.push(...Nt(i)):t.push("No parts"),t}const qt=[["DOM",d.Dom],["MIDI",d.Midi]],Ft=[["DOM",f.Dom],["MIDI",f.Midi]],Lt=[["DOM",y.Dom],["MIDI",y.Midi]],O={CONFIG_FORM_ID:"config-form",TRANSPORTER_CONFIG_ID:"transporter-config",PART_CONFIG_CLASS:"part-config",TYPE_DIV_CLASS:"type-div",MIDI_DIV_CLASS:"midi-div",MIDI_INPUT_SELECT_CLASS:"midi-input-select",MIDI_OUTPUT_SELECT_CLASS:"midi-output-select",REMEMBER_CHECKBOX_ID:"remember-config"};function at(e,t){if(!e.div)throw new Error("setUpRadioButtons called before render");const n=Array.from(e.div.querySelectorAll('input[type="radio"]'));for(const i of n)for(const[o,s]of t)i.addEventListener("change",()=>{if(!s.div)throw new Error("setUpRadioButtons called before render");s.div.classList[Number(i.value)===o?"remove":"add"]("hidden")})}class ct{constructor(t,n,i){p(this,"name");p(this,"title");p(this,"typeNamesAndEnums");p(this,"inputs");p(this,"div");this.name=t,this.title=n,this.typeNamesAndEnums=i,this.inputs={},this.div=null}render(){const t=this.typeNamesAndEnums.map(([n,i])=>{const o=`${this.name}-${n}`,s=l("input",{id:o,type:"radio",name:this.name,value:i}),r=l("label",{for:o},n);return this.inputs[i]=s,[s,r]}).flat();return this.div=l("div",{class:O.TYPE_DIV_CLASS},this.title,...t)}getConfig(){if(!this.div)throw new Error("getConfig called before render");return Number(this.div.querySelector('input[type="radio"]:checked').value)}}class dt{constructor(){p(this,"inputSelect",null);p(this,"outputSelect",null);p(this,"div",null)}render(){const t=this.inputSelect=l("select",{class:O.MIDI_INPUT_SELECT_CLASS}),n=this.outputSelect=l("select",{class:O.MIDI_OUTPUT_SELECT_CLASS});return this.div=l("div",{},t," \u2192 Here \u2192 ",n)}getConfig(){if(!this.inputSelect||!this.outputSelect)throw new Error("getConfig called before render");return{input:this.inputSelect.value,output:this.outputSelect.value}}}class jt{constructor(){p(this,"select",null);p(this,"input",null);p(this,"div",null)}render(){const t=this.select=l("select",{class:O.MIDI_OUTPUT_SELECT_CLASS}),n=this.input=l("input",{type:"number",name:"channel",min:1,max:16,value:1});return this.div=l("div",{},t," on channel ",n)}getConfig(){if(!this.select||!this.input)throw new Error("getConfig called before render");return{output:this.select.value,channel:this.input.value}}}class Tt{constructor(){p(this,"typeConfig",new ct("transporter-type","Type: ",qt));p(this,"midiConfig",new dt)}render(){const t=l("legend",{},"TRANSPORTER"),n=this.typeConfig.render(),i=this.midiConfig.render();return l("fieldset",{id:O.TRANSPORTER_CONFIG_ID},t,n,i)}setUp(){at(this.typeConfig,[[d.Midi,this.midiConfig]])}getConfig(){const t={};return(t.type=this.typeConfig.getConfig())===d.Midi&&(t.midi=this.midiConfig.getConfig()),t}}class _t{constructor(t){p(this,"typeConfig");p(this,"midiConfig",new dt);p(this,"div",null);this.typeConfig=new ct(`${t}-controller-type`,"Controller: ",Ft)}render(){const t=this.typeConfig.render(),n=this.midiConfig.render();return this.div=l("div",{},t,n)}setUp(){at(this.typeConfig,[[f.Midi,this.midiConfig]])}getConfig(){const t={};return(t.type=this.typeConfig.getConfig())===f.Midi&&(t.midi=this.midiConfig.getConfig()),t}}class $t{constructor(t){p(this,"typeConfig");p(this,"midiConfig",new jt);this.typeConfig=new ct(`${t}-synthesizer-type`,"Synthesizer: ",Lt)}render(){const t=this.typeConfig.render(),n=this.midiConfig.render();return l("div",{},t,n)}setUp(){at(this.typeConfig,[[y.Midi,this.midiConfig]])}getConfig(){const t={};return(t.type=this.typeConfig.getConfig())===y.Midi&&(t.midi=this.midiConfig.getConfig()),t}}class tt{constructor(t){p(this,"name");p(this,"controllerConfig");p(this,"synthesizerConfig");this.name=t,this.controllerConfig=new _t(t),this.synthesizerConfig=new $t(t)}render(){const t=l("legend",{},this.name.toUpperCase()),n=this.controllerConfig.render(),i=l("hr"),o=this.synthesizerConfig.render();return l("fieldset",{},t,n,i,o)}setUp(){this.controllerConfig.setUp(),this.synthesizerConfig.setUp()}getConfig(){return{controller:this.controllerConfig.getConfig(),synthesizer:this.synthesizerConfig.getConfig()}}}class Gt{constructor(){p(this,"div",null)}render(){return this.div=l("div",{class:"problem-div"})}addProblems(t){if(!this.div)throw new Error("addProblems called before render");const n=this.div;n.innerHTML="";for(const i of t){const o=l("p",{},i);n.appendChild(o)}}}class Rt{constructor(){p(this,"refreshButton",null);p(this,"rememberCheckbox",null);p(this,"problemDiv",new Gt)}render(){const t=this.refreshButton=l("button",{type:"button"},"Refresh MIDI Ports"),n=this.rememberCheckbox=l("input",{type:"checkbox",id:O.REMEMBER_CHECKBOX_ID}),i=l("label",{for:O.REMEMBER_CHECKBOX_ID},"Remember"),o=l("button",{type:"submit"},"Submit"),s=this.problemDiv.render();return l("div",{},t,n,i,o,s)}setUp(){}}class Bt{constructor(){p(this,"transporterConfig",new Tt);p(this,"partConfigs",{bass:new tt("bass"),drum:new tt("drum"),keys:new tt("keys"),lead:new tt("lead")});p(this,"miscellaneousDiv",new Rt);p(this,"form",null)}render(){const t=this.transporterConfig.render(),n=Object.values(this.partConfigs).map(o=>o.render()),i=this.miscellaneousDiv.render();return this.form=l("form",{id:O.CONFIG_FORM_ID},t,...n,i)}setUp(){if(!this.form)throw new Error("setUp called before render");this.transporterConfig.setUp();for(const t of Object.values(this.partConfigs))t.setUp();if(!this.miscellaneousDiv.refreshButton)throw new Error("setUp called before render");this.miscellaneousDiv.refreshButton.addEventListener("mousedown",this.refreshMidi.bind(this)),this.refreshMidi(),this.clickAllFirstRadioButtons(),this.form.classList.remove("hidden")}getConfig(){return{transporter:this.transporterConfig.getConfig(),parts:{bass:this.partConfigs.bass.getConfig(),drum:this.partConfigs.drum.getConfig(),keys:this.partConfigs.keys.getConfig(),lead:this.partConfigs.lead.getConfig()}}}refreshMidi(){if(!this.form)throw new Error("refreshMidi called before render");const t=Array.from(this.form.querySelectorAll('input[type="radio"][value="midi"]'));for(const i of t)i.disabled=!P;if(!P)return;function n(i,o){const s=document.getElementsByClassName(i),r=Array.from(P[o].values()).map(c=>c.name);for(const c of s){const u=c.value||r[0];c.innerHTML="";for(const g of r){const C=l("option",{value:g},g);c.appendChild(C)}r.includes(u)&&(c.value=u)}}n(O.MIDI_INPUT_SELECT_CLASS,"inputs"),n(O.MIDI_OUTPUT_SELECT_CLASS,"outputs")}clickAllFirstRadioButtons(){if(!this.form)throw new Error("clickAllFirstRadioButtons called before render");const t=Array.from(this.form.querySelectorAll('input[type="radio"]:enabled:first-of-type'));for(const n of t)n.click()}getPromise(){return new Promise(t=>{if(!this.form)throw new Error("getPromise called before render");this.form.addEventListener("submit",n=>{if(!this.form)throw new Error("submit event listener called after form was removed");n.preventDefault();const i=this.getConfig(),o=St(i);this.miscellaneousDiv.problemDiv.addProblems(o),!o.length&&(this.form.remove(),t(i))})})}}async function Ut(){const e=new Bt;return document.body.append(e.render()),e.setUp(),await e.getPromise()}const zt=async()=>await Ut();function Ht(e){const t=l("h2"),n={previous:l("button",{class:"transporter-button"},"\u23EE"),play:l("button",{class:"transporter-button"},"\u25B6"),pause:l("button",{class:"transporter-button"},"\u23F8"),stop:l("button",{class:"transporter-button"},"\u23F9"),next:l("button",{class:"transporter-button"},"\u23ED")};e.connect=(s,r)=>{n.previous.addEventListener("click",()=>s.goPrevious()),n.next.addEventListener("click",()=>s.goNext()),n.play.addEventListener("click",()=>r.play()),n.pause.addEventListener("click",()=>r.pause()),n.stop.addEventListener("click",()=>r.stop())},e.changeChart=(s,r,c)=>{t.innerText=s,n.previous.disabled=!r,n.next.disabled=!c},e.changePlayback=s=>{n.play.disabled=s===m.Playing,n.pause.disabled=s!==m.Playing,n.stop.disabled=s===m.Stopped};const i=l("div",{},...Object.values(n)),o=l("div",{id:"transporter"},t,i);e.render=()=>o}class Kt{constructor(t){switch(t.type){case d.Dom:Ht(this);break;default:throw new Error(`Invalid Transporter type: ${t}`)}}connect(t,n){}changeChart(t,n,i){}changePlayback(t){}render(){return null}}function ft(e,...t){return[...e,...t].sort((n,i)=>n.time-i.time)}const Vt=/[CDEFGAB]/,Yt=/♮|b{1,2}|#{1,2}/,Xt=/-?[0-8]/,Wt=/[CDEFGAB](♮|b{1,2}|#{1,2})?/;function V(e){var g,C,v,j;const t=(g=e.match(Wt))==null?void 0:g[0];if(t===void 0)throw new Error(`Invalid pitch class: ${e}`);const n=(C=t.match(Vt))==null?void 0:C[0];if(n===void 0)throw new Error(`Invalid pitch letter: ${t}`);const i={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[n];if(i===void 0)throw new Error(`Invalid pitch letter: ${t}`);const o=((v=t.match(Yt))==null?void 0:v[0])||"\u266E",s={"\u266E":0,b:-1,bb:-2,"#":1,"##":2}[o];if(s===void 0)throw new Error(`Invalid accidental: ${t}`);const r=Number((j=e.match(Xt))==null?void 0:j[0]);if(isNaN(r))throw new Error(`Invalid octave: ${t}`);const c=(r+1)*12,u=i+s+c;if(u<0||u>127)throw new Error(`Out of MIDI range: ${t}`);return u}function et(e){return 6e4/e}function Y(...e){const t={millisecondsPerBeat:et(120),swingAmount:0,swingDivision:1,position:-1/0,bufferEvents:[]};return e.reduce((n,i)=>i(n),t).bufferEvents}function nt(e){return t=>Object.assign({},t,{millisecondsPerBeat:et(e)})}function Jt(e,t){return n=>Object.assign({},n,{swingAmount:e,swingDivision:t})}function X(e,t,n,i){if(e===-1/0||e===1/0)return e;const o=e%i,s=i*Math.floor(e/i),r=o<i/2?(n+1)*o:(1-n)*o+n*i;return(s+r)*t}function mt(e){return Math.max(e-.1,e*.9)}function D(e,t,n,i,o){if(typeof t=="function")return s=>{const{millisecondsPerBeat:r,swingAmount:c,swingDivision:u}=s,g=X(n,r,c,u),C=j=>{const H=t(),ut={time:g,type:b.NoteOn,part:e,pitch:H,velocity:o},K={time:X(n+mt(i),r,c,u),type:b.NoteOff,part:e,pitch:H};j.unshift(ut,K)},v={time:g-100,type:b.Compute,callback:C};return Object.assign({},s,{position:n+i,bufferEvents:ft(s.bufferEvents,v)})};{const s=typeof t=="number"?t:V(t);return r=>{const{millisecondsPerBeat:c,swingAmount:u,swingDivision:g}=r,C={time:X(n,c,u,g),type:b.NoteOn,part:e,pitch:s,velocity:o},v={time:X(n+mt(i),c,u,g),type:b.NoteOff,part:e,pitch:s};return Object.assign({},r,{position:n+i,bufferEvents:ft(r.bufferEvents,C,v)})}}}function x(...e){return t=>{const{position:n,millisecondsPerBeat:i,bufferEvents:o,swingAmount:s,swingDivision:r}=t,c=e.map(u=>({time:X(n,i,s,r),type:b.Finish,part:u}));return Object.assign({},t,{bufferEvents:[...o,...c]})}}const Qt={title:"Hello World",compose:({bass:e,drum:t,keys:n,lead:i})=>Y(x(e,t,n),nt(60),D(i,"C4",0,4,127),x(i))},Zt=["C2","D2","E2","F2","G2","A2","B2","C3"],te={title:"Bass Scale",compose:({bass:e,drum:t,keys:n,lead:i})=>Y(x(t,n,i),nt(120),...Zt.map((o,s)=>D(e,o,s,.9,127)),x(e))},ee=60,ne=240,yt=32,ie=5,oe=100,se=127;function re(e){const t=e.controller.getRangeControl("Tempo: ",ee,ne," pm"),n=i=>[{time:i-oe,type:b.Compute,callback:o=>{const s=t.value,r=i+et(s);o.push(...n(r))}},{time:i,type:b.NoteOn,part:e,pitch:yt,velocity:se},{time:i+ie,type:b.NoteOff,part:e,pitch:yt}];return n(0)}const ae={title:"Metronome",compose:({bass:e,drum:t,keys:n,lead:i})=>[{time:-1/0,type:b.Finish,part:e},{time:-1/0,type:b.Finish,part:n},{time:-1/0,type:b.Finish,part:i},...re(t)]},ce=[["C4",0,.9],["C4",1,.9],["G4",2,.9],["G4",3,.9],["A4",4,.9],["A4",5,.9],["G4",6,1.9],["F4",8,.9],["F4",9,.9],["E4",10,.9],["E4",11,.9],["D4",12,.9],["D4",13,.9],["C4",14,1.9],["G4",16,.9],["G4",17,.9],["F4",18,.9],["F4",19,.9],["E4",20,.9],["E4",21,.9],["D4",22,1.9],["G4",24,.9],["G4",25,.9],["F4",26,.9],["F4",27,.9],["E4",28,.9],["E4",29,.9],["D4",30,1.9],["C4",32,.9],["C4",33,.9],["G4",34,.9],["G4",35,.9],["A4",36,.9],["A4",37,.9],["G4",38,1.9],["F4",40,.9],["F4",41,.9],["E4",42,.9],["E4",43,.9],["D4",44,.9],["D4",45,.9],["C4",46,2]];function le(e){const t=e.controller.getRangeControl("8va chance: ",0,100,"%");return ce.map(([n,i,o])=>{const s=Math.random()*100,r=V(n);return D(e,()=>t.value>s?r+12:r,i,o,127)})}const ue={title:"Twinkle Twinkle Little Star",compose:({bass:e,drum:t,keys:n,lead:i})=>Y(x(e,t,n),nt(120),...le(i),x(i))},gt=["E3","G3","A3","G3","D4","C4","D4","E4"],Ct=2,bt=Ct/gt.length,it=et(165);function pe(e){const t=gt.map(V);return n=>{const i=e.controller.getOptionControl("Repeat again: ",["No","Yes"],"!"),o=s=>({time:s*it-100,type:b.Compute,callback:r=>{if(i.value){const c=t.map((u,g)=>{const C=s+g*bt;return[{time:C*it,type:b.NoteOn,part:e,pitch:u,velocity:127},{time:(C+bt-.05)*it,type:b.NoteOff,part:e,pitch:u}]}).flat();r.push(...c,o(s+Ct))}else r.push({time:s*it,type:b.Finish,part:e})}});return Object.assign({},n,{bufferEvents:[...n.bufferEvents,o(0)]})}}const he={title:"On the Run",compose:({bass:e,drum:t,keys:n,lead:i})=>Y(x(e,t,n),pe(i))};function de(e,t){const n=[],i=[];let o=0;for(const s of t){const r=e[s],c=r.length,u=r.melody,g=r.chords;for(const[C,v,j]of u)n.push([C,v+o,j]);for(const C of g)i.push({...C,position:C.position+o});o+=c}return{length:o,melody:n,chords:i}}const fe={"1-16":{length:64,melody:[["C5",0,1],["B4",1,1],["A4",2,.5],["G4",2.5,1.5],["F4",4,1.5],["G4",5.5,.5],["A4",6,1],["C5",7,1],["B4",8,1],["A4",9,1],["G4",10,.5],["F4",10.5,1.5],["E4",12,4],["A4",16,1],["G4",17,1],["F4",18,.5],["E4",18.5,1.5],["D4",20,1.5],["E4",21.5,.5],["F4",22,1],["A4",23,1],["G#4",24,1],["F4",25,1],["E4",26,.5],["D4",26.5,1.5],["C4",28,3],["C#4",31,1],["D4",32,.5],["A4",32.5,1],["A4",33.5,3.5],["C5",37,2],["B4",39,1],["G4",40,7],["B3",47,1],["C4",48,.5],["F4",48.5,1],["F4",49.5,3.5],["A4",53,2],["G4",55,1],["F4",56,2],["E4",58,7]],chords:[{root:"A",quality:"minor",extension:"7",position:0,duration:4},{root:"D",quality:"minor",extension:"7",position:4,duration:4},{root:"G",quality:"major",extension:"7",position:8,duration:4},{root:"C",quality:"major",extension:"maj7",position:12,duration:2},{root:"C",quality:"major",extension:"7",position:14,duration:2},{root:"F",quality:"major",extension:"7",position:16,duration:4},{root:"B",quality:"minor",extension:"7(b5)",position:20,duration:4},{root:"E",quality:"minor",extension:"7",position:24,duration:4},{root:"A",quality:"minor",extension:"7",position:28,duration:2},{root:"A",quality:"major",extension:"7",position:30,duration:2},{root:"D",quality:"minor",extension:"7",position:32,duration:4},{root:"G",quality:"major",extension:"7",position:36,duration:4},{root:"C",quality:"major",extension:"maj7",position:40,duration:4},{root:"E",quality:"minor",extension:"7",position:44,duration:2},{root:"A",quality:"minor",extension:"7",position:46,duration:2},{root:"D",quality:"minor",extension:"7",position:48,duration:4},{root:"G",quality:"major",extension:"7",position:52,duration:4},{root:"F",quality:"major",extension:"6",position:56,duration:2},{root:"C",quality:"major",extension:"maj7",position:58,duration:2},{root:"B",quality:"minor",extension:"7(b5)",position:60,duration:2},{root:"E",quality:"minor",extension:"7",position:62,duration:2}]},"17-26":{length:40,melody:[["C5",0,1],["B4",1,1],["A4",2,.5],["G4",2.5,1.5],["F4",4,1.5],["G4",5.5,.5],["A4",6,1],["C5",7,1],["B4",8,1],["A4",9,1],["G4",10,.5],["F4",10.5,1.5],["E4",12,4],["A4",16,1],["G4",17,1],["F4",18,.5],["E4",18.5,1.5],["D4",20,1],["E4",21,1],["F4",22,1],["A4",23,1],["G#4",24,1],["F4",25,1],["E4",26,.5],["D4",26.5,1.5],["C4",28,3],["C#4",31,1],["D4",32,.5],["A4",32.5,1],["A4",33.5,3.5],["C5",37,2],["B4",39,1]],chords:[{root:"A",quality:"minor",extension:"7",position:0,duration:4},{root:"D",quality:"minor",extension:"7",position:4,duration:4},{root:"G",quality:"major",extension:"7",position:8,duration:4},{root:"C",quality:"major",extension:"maj7",position:12,duration:2},{root:"C",quality:"major",extension:"7",position:14,duration:2},{root:"F",quality:"major",extension:"maj7",position:16,duration:4},{root:"B",quality:"minor",extension:"7(b5)",position:20,duration:4},{root:"E",quality:"minor",extension:"7",position:24,duration:4},{root:"A",quality:"minor",extension:"7",position:28,duration:2},{root:"A",quality:"major",extension:"7",position:30,duration:2},{root:"D",quality:"minor",extension:"7",position:32,duration:4},{root:"G",quality:"major",extension:"7",position:36,duration:4}]},"27-32":{length:24,melody:[["G4",0,7],["G#4",7,1],["A4",8,.5],["C4",8.5,1],["C4",9.5,3.5],["C4",13,2],["D4",15,1],["C4",16,4]],chords:[{root:"E",quality:"minor",extension:"7",position:0,duration:4},{root:"A",quality:"minor",extension:"7",position:4,duration:4},{root:"D",quality:"minor",extension:"7",position:8,duration:4},{root:"G",quality:"major",extension:"7",position:12,duration:4},{root:"C",quality:"major",extension:"6",position:16,duration:4},{root:"B",quality:"minor",extension:"7(b5)",position:20,duration:2},{root:"E",quality:"minor",extension:"7",position:22,duration:2}]},"33-38":{length:24,melody:[["E5",0,7],["C5",7,1],["D5",8,.5],["A4",8.5,1],["A4",9.5,3.5],["B4",13,2],["D5",15,1],["C5",16,7]],chords:[{root:"E",quality:"minor",extension:"7",position:0,duration:4},{root:"A",quality:"minor",extension:"7",position:4,duration:4},{root:"D",quality:"minor",extension:"7",position:8,duration:4},{root:"G",quality:"major",extension:"7",position:12,duration:4},{root:"C",quality:"major",extension:"6",position:16,duration:8}]}},me=["1-16","17-26","27-32","1-16","17-26","33-38"];function ye(e,t){const n=[],i=V("E1");function o(s){return s>=i?s:o(s+12)}for(const{root:s,quality:r,extension:c,position:u,duration:g}of t.chords){const C=V(`${s}1`),v=o(C),j=r==="major"?v+4:v+3,H=c==="7(b5)"?v+6:v+7,ut=c==="6"?v+9:c==="7"?v+10:c==="maj7"?v+11:c==="7(b5)"?v+10:v+12;if(g===4)n.push(D(e,v,u,1,127)),n.push(D(e,j,u+1,1,127)),n.push(D(e,H,u+2,1,127)),n.push(D(e,ut,u+3,1,127));else if(g===2)n.push(D(e,v,u,1,127)),n.push(D(e,H,u+1,1,127));else for(let K=0;K<g;K++)n.push(D(e,K%2===0?v:H,u+K,1,127))}return n}function ge(e,t){const n=[];for(const[i,o,s]of t.melody)n.push(D(e,i,o,s,127));return n}const lt=de(fe,me);console.debug("song",lt);const Ce={title:"Fly Me to the Moon",compose:({bass:e,drum:t,keys:n,lead:i})=>Y(x(t,n),nt(118),Jt(.25,1),...ye(e,lt).slice(0,-1),...ge(i,lt),x(e,i))},vt=[Qt,te,ae,ue,he,Ce],wt=vt.length;class be{constructor(){w(this,M,0);w(this,T,()=>{})}goPrevious(){a(this,M)>0&&(h(this,M,a(this,M)-1),a(this,T).call(this))}goNext(){a(this,M)<wt-1&&(h(this,M,a(this,M)+1),a(this,T).call(this))}connect(t,n){h(this,T,()=>{const i=vt[a(this,M)],o=i.title,s=a(this,M)>0,r=a(this,M)<wt-1;t.changeChart(o,s,r),n.changeChart(i)})}start(){a(this,T).call(this)}}M=new WeakMap,T=new WeakMap;const Et=12,U={min:0,max:127,step:1,default:63};class ve{constructor(){w(this,S);w(this,_);w(this,$,()=>{});w(this,G,()=>0);const t=l("span",{},"EMPTY");h(this,S,{0:l("span",{},"%%"),1:t,2:l("span",{},"%%")}),h(this,_,l("input",{type:"range",min:U.min,max:U.max,step:U.step,value:U.default})).addEventListener("input",()=>{a(this,$).call(this)})}clear(){h(this,G,()=>0),h(this,$,()=>{});const t=Object.values(a(this,S));for(const n of t)n.textContent=""}get value(){return a(this,G).call(this)}makeIntoRangeControl(t,n,i,o=""){const s=a(this,S),r=s[1],c=a(this,_);s[0].textContent=t,s[2].textContent=o;const u=h(this,G,()=>n+Math.round((i-n)*Number(c.value)/U.max));h(this,$,()=>{r.textContent=u().toString()})()}makeIntoOptionControl(t,n,i=""){const o=a(this,S),s=o[1],r=a(this,_);o[0].textContent=t,o[2].textContent=i;const c=h(this,G,()=>Math.round((n.length-1)*Number(r.value)/U.max));h(this,$,()=>{s.textContent=n[c()]})()}render(){const t=l("label",{class:"lcd"},...Object.values(a(this,S)));return l("div",{class:"controller-module"},t,a(this,_))}}S=new WeakMap,_=new WeakMap,$=new WeakMap,G=new WeakMap;function we(e){const t=Array.from({length:Et},()=>new ve);let n=0;e.clear=()=>{t.forEach(o=>o.clear()),n=0};function i(){if(n>=Et)throw new Error("No more controllers available");const o=t[n];return n+=1,o}e.getRangeControl=(o,s,r,c="")=>{const u=i();return u.makeIntoRangeControl(o,s,r,c),u},e.getOptionControl=(o,s,r="")=>{const c=i();return c.makeIntoOptionControl(o,s,r),c},e.render=()=>{const o=l("h2",{class:"component-title"},"Controller"),s=t.map(c=>c.render()),r=l("div",{class:"controller-row"},...s);return o.addEventListener("click",()=>{r.classList.toggle("hidden")}),r.classList.add("hidden"),l("div",{class:"controller"},o,r)}}class Ee{constructor(t,n){switch(n.type){case f.Dom:we(this);break;default:throw new Error(`Invalid Controller type: ${n}`)}}clear(){}getRangeControl(t,n,i,o=""){return{value:0}}getOptionControl(t,n,i=""){return{value:0}}render(){return null}}function De(e){e.noteOn=(t,n,i)=>{console.log("noteOn",t,i,n)},e.noteOff=(t,n)=>{console.log("noteOff",t,n)},e.allNotesOff=()=>{console.log("allNotesOff")}}function Ie(e){const t=l("h2",{class:"component-title"},"Synthesizer"),n=l("button",{},"Clear"),i=l("div",{class:"message-row"}),o=l("div",{class:"synthesizer-row"},n,i),s=l("div",{class:"synthesizer"},t,o);function r(c,u){const g=l("div",{class:u},c);i.appendChild(g),i.scrollTop=i.scrollHeight}e.noteOn=(c,u,g,C=!0)=>{C&&e.currentlyPlayingPitches.push(c),r(`noteOn ${c} ${u} ${g.toFixed(0)}`,"note-on")},e.noteOff=(c,u,g=!0)=>{r(`noteOff ${c} ${u.toFixed(0)}`,"note-off"),g&&(e.currentlyPlayingPitches=e.currentlyPlayingPitches.filter(C=>C!==c))},e.allNotesOff=()=>{r("allNotesOff","all-notes-off"),e.currentlyPlayingPitches=[]},n.addEventListener("click",()=>{i.innerHTML=""}),t.addEventListener("click",()=>{o.classList.toggle("hidden")}),o.classList.add("hidden"),e.render=()=>s}function Pe(e,t){if(!P)throw new Error("No MIDI access");const n=P.outputs.values().find(o=>o.name===t.midi.output);if(!n)throw new Error(`No MIDI output named ${t.midi.output}`);const i=t.midi.channel-1;e.noteOn=(o,s,r,c=!0)=>{c&&e.currentlyPlayingPitches.push(o),n.send([144+i,o,s],r)},e.noteOff=(o,s,r=!0)=>{n.send([128+i,o,0],s),r&&(e.currentlyPlayingPitches=e.currentlyPlayingPitches.filter(c=>c!==o))},e.allNotesOff=()=>{n.send([176+i,123,0]),e.currentlyPlayingPitches=[]}}class Oe{constructor(t,n){p(this,"currentlyPlayingPitches",[]);switch(n.type){case y.Log:De(this);break;case y.Dom:Ie(this);break;case y.Midi:Pe(this,n);break}}noteOn(t,n,i,o=!0){}noteOff(t,n,i=!0){}allNotesOff(){}pause(){const t=window.performance.now();for(const n of this.currentlyPlayingPitches)this.noteOff(n,t,!1)}resume(){const t=window.performance.now();for(const n of this.currentlyPlayingPitches)this.noteOn(n,31,t,!1)}render(){return null}}class ot{constructor(t,n){w(this,W);p(this,"controller");p(this,"synthesizer");h(this,W,t),this.controller=new Ee(t,n.controller),this.synthesizer=new Oe(t,n.synthesizer)}render(){const t=l("h2",{},a(this,W).toUpperCase()),n=this.controller.render(),i=this.synthesizer.render();return n||i?l("div",{class:"part"},t,n,i):null}}W=new WeakMap;function Me(e){return{bass:new ot("bass",e.bass),drum:new ot("drum",e.drum),keys:new ot("keys",e.keys),lead:new ot("lead",e.lead)}}const st=100;function ke(){return new Worker(new URL(""+new URL("worker-Dukc8-Vk.js",import.meta.url).href,import.meta.url),{type:"module"})}class Ae{constructor(t,n){w(this,Z);w(this,J);w(this,q,ke());w(this,k);w(this,F,!1);w(this,L,[]);w(this,Q,()=>{});w(this,R,0);w(this,B,0);w(this,z,new Set);h(this,J,t),h(this,k,Me(n)),a(this,q).onmessage=i=>this.schedule()}schedule(){const t=window.performance.now()+st;for(;a(this,F)&&a(this,Z,pt)<t;){const n=a(this,Z,pt),i=a(this,L).shift();if(i)switch(i.type){case b.Finish:a(this,z).add(i.part),a(this,z).size===4&&a(this,J).stop();break;case b.NoteOn:i.part.synthesizer.noteOn(i.pitch,i.velocity,n);break;case b.NoteOff:i.part.synthesizer.noteOff(i.pitch,n);break;case b.Compute:i.callback(a(this,L));break}}}changeChart(t){h(this,Q,()=>{for(const n of Object.values(a(this,k)))n.controller.clear();console.debug("buffer",h(this,L,t.compose(a(this,k))))})()}play(){h(this,F,!0),h(this,R,window.performance.now()+st),h(this,B,0),a(this,q).postMessage(0)}pause(){h(this,F,!1),a(this,q).postMessage(1),h(this,B,window.performance.now()-a(this,R)),setTimeout(()=>{for(const t of Object.values(a(this,k)))t.synthesizer.pause()},st*2)}resume(){h(this,F,!0),h(this,R,window.performance.now()-a(this,B)),a(this,q).postMessage(0);for(const t of Object.values(a(this,k)))t.synthesizer.resume()}stop(){h(this,F,!1),a(this,q).postMessage(1),h(this,B,0),a(this,z).clear(),a(this,Q).call(this),setTimeout(()=>{for(const t of Object.values(a(this,k)))t.synthesizer.allNotesOff()},st*2)}render(){const t=Object.values(a(this,k)).map(n=>n.render());return t.some(n=>n!==null)?l("div",{id:"part-container"},...t):null}}J=new WeakMap,q=new WeakMap,k=new WeakMap,F=new WeakMap,L=new WeakMap,Q=new WeakMap,R=new WeakMap,B=new WeakMap,z=new WeakMap,Z=new WeakSet,pt=function(){return a(this,L).length===0?1/0:a(this,L)[0].time+a(this,R)};class xe{constructor(t){w(this,E,m.Paused);w(this,N,()=>{});w(this,A);h(this,A,new Ae(this,t))}changeChart(t){a(this,A).changeChart(t),a(this,E)!=m.Stopped&&this.stop()}play(){switch(a(this,E)){case m.Playing:break;case m.Paused:a(this,N).call(this,I.Resume),h(this,E,m.Playing);break;case m.Stopped:a(this,N).call(this,I.Play),h(this,E,m.Playing);break}}pause(){switch(a(this,E)){case m.Playing:a(this,N).call(this,I.Pause),h(this,E,m.Paused);break;case m.Paused:break;case m.Stopped:break}}stop(){switch(a(this,E)){case m.Playing:a(this,N).call(this,I.Stop),h(this,E,m.Stopped);break;case m.Paused:a(this,N).call(this,I.Stop),h(this,E,m.Stopped);break;case m.Stopped:break}}connect(t){h(this,N,n=>{switch(n){case I.Play:a(this,A).play(),t.changePlayback(m.Playing);break;case I.Pause:a(this,A).pause(),t.changePlayback(m.Paused);break;case I.Resume:a(this,A).resume(),t.changePlayback(m.Playing);break;case I.Stop:a(this,A).stop(),t.changePlayback(m.Stopped);break}})}render(){return a(this,A).render()}}E=new WeakMap,N=new WeakMap,A=new WeakMap;function Dt(e){e&&document.body.append(e)}function Ne(e){const t=new Kt(e.transporter),n=new be,i=new xe(e.parts);t.connect(n,i),n.connect(t,i),i.connect(t);const o=t.render(),s=i.render();Dt(o),Dt(s),n.start()}const Se=await zt();Ne(Se)})();
</script>
  <style rel="stylesheet" crossorigin>:root{--red: #b23535;--green: #38ad5f;--blue: #464ca5;--white: #eeeade;--black: #282828;--text-color: var(--black);--background-color: var(--white)}@media (prefers-color-scheme: dark){:root{--text-color: var(--white);--background-color: var(--black)}}*{color:inherit;background-color:inherit;border-color:inherit;font-family:inherit;box-sizing:inherit}body{min-height:100vh;font-family:Arial,sans-serif;color:var(--text-color);background-color:var(--background-color);border-color:var(--text-color);box-sizing:border-box;padding:0;margin:0}#config-form{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}fieldset{margin-bottom:20px}legend{font-weight:700;margin-bottom:10px}.type-div{margin-bottom:10px}label{-webkit-user-select:none;user-select:none}input[type=radio]:disabled+label{text-decoration:line-through}button{color:var(--text-color);background-color:var(--background-color);border:1px solid var(--text-color);cursor:pointer;transition:background-color .3s ease}button:hover{background-color:var(--text-color);color:var(--background-color)}.transporter-button{width:2em;height:2em;border:1.5px solid;border-radius:50%;font-size:2.5rem;padding:1rem;margin:0 .5rem 2rem;cursor:pointer;color:var(--background-color);background-color:var(--text-color);transition:transform .2s}.transporter-button:hover:enabled{transform:scale(1.1)}.transporter-button:disabled{color:var(--text-color);background-color:var(--background-color);cursor:auto}#transporter{text-align:center;border-bottom:1px solid var(--text-color)}.lcd{padding:.5em 1em;border-radius:5px;width:16ch;min-height:4em;line-height:1.5;text-align:left;font-family:hd44780,monospace;color:var(--background-color);background-color:var(--text-color)}input[type=range]{margin-top:1em;width:100%}.controller-module{padding:1em;display:flex;flex-direction:column;align-items:center;border:1px solid;font-size:1vw}.component-title{margin-top:0;margin-bottom:0;width:100%;height:3rem;line-height:3rem;cursor:pointer;-webkit-user-select:none;user-select:none}.controller-row{border-top:1px solid;justify-content:center;align-items:center;overflow-y:scroll;height:40vw}.controller{padding-top:0;border:1px solid}.note-on{color:var(--green)}.note-off{color:var(--red)}.all-notes-off{color:var(--blue)}.message-row{width:100%;height:10vw;overflow-y:scroll}.synthesizer-row{width:100%}.synthesizer{display:flex;flex-direction:column;align-items:center;width:100%;border:1px solid}.part{text-align:center;border:1px solid;min-width:20%}#part-container{display:flex;flex-wrap:wrap;justify-content:space-around;align-items:start}.hidden{display:none}
</style>
</head>

<body>
</body>

</html>