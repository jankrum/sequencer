<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vite + TS</title>
  <script type="module" crossorigin>var ze=Object.defineProperty;var ne=u=>{throw TypeError(u)};var Ie=(u,h,d)=>h in u?ze(u,h,{enumerable:!0,configurable:!0,writable:!0,value:d}):u[h]=d;var B=(u,h,d)=>Ie(u,typeof h!="symbol"?h+"":h,d),oe=(u,h,d)=>h.has(u)||ne("Cannot "+d);var o=(u,h,d)=>(oe(u,h,"read from private field"),d?d.call(u):h.get(u)),y=(u,h,d)=>h.has(u)?ne("Cannot add the same private member more than once"):h instanceof WeakSet?h.add(u):h.set(u,d),a=(u,h,d,p)=>(oe(u,h,"write to private field"),p?p.call(u,d):h.set(u,d),d);(async()=>{var w,M,C,x,S,E,F,$,N,k,D,L,A,z,I,U,j,q,G,g,v,O;(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();var u=(e=>(e[e.Dom=0]="Dom",e[e.Midi=1]="Midi",e))(u||{}),h=(e=>(e[e.Dom=0]="Dom",e[e.Midi=1]="Midi",e))(h||{}),d=(e=>(e[e.Log=0]="Log",e[e.Dom=1]="Dom",e[e.Midi=2]="Midi",e))(d||{}),p=(e=>(e[e.Playing=0]="Playing",e[e.Paused=1]="Paused",e[e.Stopped=2]="Stopped",e))(p||{}),P=(e=>(e[e.Play=0]="Play",e[e.Pause=1]="Pause",e[e.Resume=2]="Resume",e[e.Stop=3]="Stop",e))(P||{}),m=(e=>(e[e.Tempo=0]="Tempo",e[e.Finish=1]="Finish",e[e.NoteOn=2]="NoteOn",e[e.NoteOff=3]="NoteOff",e[e.Compute=4]="Compute",e))(m||{});const re=async()=>({parts:{bass:{controller:{type:h.Dom},synthesizer:{type:d.Midi,midi:{output:"loopMIDI Port",channel:1}}},drum:{controller:{type:h.Dom},synthesizer:{type:d.Dom}},keys:{controller:{type:h.Dom},synthesizer:{type:d.Dom}},lead:{controller:{type:h.Dom},synthesizer:{type:d.Midi,midi:{output:"loopMIDI Port",channel:2}}}},transporter:{type:u.Dom}});function l(e,t={},...s){const n=document.createElement(e);for(const[r,i]of Object.entries(t))n.setAttribute(r,i);for(const r of s)typeof r=="string"?n.appendChild(document.createTextNode(r)):r&&n.appendChild(r);return n}function ie(e){const t=l("h2"),s={previous:l("button",{class:"transporter-button"},"\u23EE"),play:l("button",{class:"transporter-button"},"\u25B6"),pause:l("button",{class:"transporter-button"},"\u23F8"),stop:l("button",{class:"transporter-button"},"\u23F9"),next:l("button",{class:"transporter-button"},"\u23ED")};e.connect=(i,c)=>{s.previous.addEventListener("click",()=>i.goPrevious()),s.next.addEventListener("click",()=>i.goNext()),s.play.addEventListener("click",()=>c.play()),s.pause.addEventListener("click",()=>c.pause()),s.stop.addEventListener("click",()=>c.stop())},e.changeChart=(i,c,f)=>{t.innerText=i,s.previous.disabled=!c,s.next.disabled=!f},e.changePlayback=i=>{s.play.disabled=i===p.Playing,s.pause.disabled=i!==p.Playing,s.stop.disabled=i===p.Stopped};const n=l("div",{},...Object.values(s)),r=l("div",{id:"transporter"},t,n);e.render=()=>r}class ae{constructor(t){switch(t.type){case u.Dom:ie(this);break;default:throw new Error(`Invalid Transporter type: ${t}`)}}connect(t,s){}changeChart(t,s,n){}changePlayback(t){}render(){return null}}function K(e){return{position:-1/0,type:m.Tempo,bpm:e}}function V(...e){return e.map(t=>({position:-1/0,part:t,type:m.Finish}))}const ce={title:"Hello World",compose:({bass:e,drum:t,keys:s,lead:n})=>[K(60),...V(e,t,s),{position:0,type:m.NoteOn,part:n,pitch:60},{position:4,type:m.NoteOff,part:n,pitch:60},{position:4,type:m.Finish,part:n}]},J=[0,2,4,5,7,9,11,12];function le(e){return J.map(t=>t+24).map((t,s)=>[{position:s,part:e,type:m.NoteOn,pitch:t},{position:s+.9,part:e,type:m.NoteOff,pitch:t}]).flat()}const he={title:"Bass Scale",compose:({bass:e,drum:t,keys:s,lead:n})=>[K(120),...V(t,s,n),...le(e),{position:J.length,type:m.Finish,part:e}]},Q=[[60,0,1],[60,1,1],[67,2,1],[67,3,1],[69,4,1],[69,5,1],[67,6,2],[65,8,1],[65,9,1],[64,10,1],[64,11,1],[62,12,1],[62,13,1],[60,14,2]];function pe(e){const t=e.controller.getRangeControl("8va chance: ",0,100,"%");function s([b,T,Y]){const Le=Math.random()*100;return{position:T-.1,type:m.Compute,callback:Me=>{const xe=t.value,se=Le<xe?b+12:b,Se={position:T,type:m.NoteOn,part:e,pitch:se},Ee={position:T+Y-.1,type:m.NoteOff,part:e,pitch:se};Me.unshift(Se,Ee)}}}const n=Q.map(s),[r,i,c]=Q.at(-1)??[0,0,0],f={position:c+i+.1,type:m.Finish,part:e};return[...n,f]}const ue={title:"Twinkle Twinkle Little Star",compose:({bass:e,drum:t,keys:s,lead:n})=>[K(120),...V(e,t,s),...pe(n)]},X=[ce,he,ue],Z=X.length;class de{constructor(){y(this,w,0);y(this,M,()=>{})}goPrevious(){o(this,w)>0&&(a(this,w,o(this,w)-1),o(this,M).call(this))}goNext(){o(this,w)<Z-1&&(a(this,w,o(this,w)+1),o(this,M).call(this))}connect(t,s){a(this,M,()=>{const n=X[o(this,w)],r=n.title,i=o(this,w)>0,c=o(this,w)<Z-1;t.changeChart(r,i,c),s.changeChart(n)})}start(){o(this,M).call(this)}}w=new WeakMap,M=new WeakMap;const _=12,R={min:0,max:127,step:1,default:63};class ye{constructor(){y(this,C);y(this,x);y(this,S,()=>{});y(this,E,()=>0);const t=l("span",{},"EMPTY");a(this,C,{0:l("span",{},"%%"),1:t,2:l("span",{},"%%")}),a(this,x,l("input",{type:"range",min:R.min,max:R.max,step:R.step,value:R.default})).addEventListener("input",()=>{o(this,S).call(this)})}clear(){a(this,E,()=>0),a(this,S,()=>{});const t=Object.values(o(this,C));for(const s of t)s.textContent=""}get value(){return o(this,E).call(this)}makeIntoRangeControl(t,s,n,r=""){const i=o(this,C),c=i[1],f=o(this,x);i[0].textContent=t,i[2].textContent=r;const b=a(this,E,()=>s+(n-s)*Number(f.value)/R.max);a(this,S,()=>{c.textContent=b().toFixed(0).toString()})()}makeIntoOptionControl(t,s,n=""){const r=o(this,C),i=r[1],c=o(this,x);r[0].textContent=t,r[2].textContent=n;const f=a(this,E,()=>s.length*Number(c.value)/R.max);a(this,S,()=>{i.textContent=s[f()]})()}render(){const t=l("label",{class:"lcd"},...Object.values(o(this,C)));return l("div",{class:"controller-module"},t,o(this,x))}}C=new WeakMap,x=new WeakMap,S=new WeakMap,E=new WeakMap;function fe(e){const t=Array.from({length:_},()=>new ye);let s=0;e.clear=()=>{t.forEach(r=>r.clear()),s=0};function n(){if(s>=_)throw new Error("No more controllers available");const r=t[s];return s+=1,r}e.getRangeControl=(r,i,c,f="")=>{const b=n();return b.makeIntoRangeControl(r,i,c,f),b},e.getOptionControl=(r,i,c="")=>{const f=n();return f.makeIntoOptionControl(r,i,c),f},e.render=()=>{const r=l("h2",{class:"component-title"},"Controller"),i=t.map(f=>f.render()),c=l("div",{class:"controller-row"},...i);return r.addEventListener("click",()=>{c.classList.toggle("hidden")}),l("div",{class:"controller"},r,c)}}class me{constructor(t,s){switch(s.type){case h.Dom:fe(this);break;default:throw new Error(`Invalid Controller type: ${s}`)}}clear(){}getRangeControl(t,s,n,r=""){return{value:0}}getOptionControl(t,s,n=""){return{value:0}}render(){return null}}const ee=await navigator.requestMIDIAccess({sysex:!0}).catch(()=>null);function ge(e){e.noteOn=(t,s)=>{console.log("noteOn",t,s)},e.noteOff=(t,s)=>{console.log("noteOff",t,s)},e.allNotesOff=()=>{console.log("allNotesOff")}}function be(e){const t=l("h2",{class:"component-title"},"Synthesizer"),s=l("button",{},"Clear"),n=l("div",{class:"message-row"}),r=l("div",{class:"synthesizer-row"},s,n),i=l("div",{class:"synthesizer"},t,r);e.noteOn=(c,f,b=!0)=>{b&&e.currentlyPlayingPitches.push(c);const T=l("div",{class:"note-on"},`noteOn ${c} ${f}`);n.appendChild(T)},e.noteOff=(c,f,b=!0)=>{const T=l("div",{class:"note-off"},`noteOff ${c} ${f}`);n.appendChild(T),b&&(e.currentlyPlayingPitches=e.currentlyPlayingPitches.filter(Y=>Y!==c))},e.allNotesOff=()=>{const c=l("div",{class:"all-notes-off"},"allNotesOff");n.appendChild(c),e.currentlyPlayingPitches=[]},s.addEventListener("click",()=>{n.innerHTML=""}),t.addEventListener("click",()=>{r.classList.toggle("hidden")}),e.render=()=>i}function Pe(e,t){if(!ee)throw new Error("No MIDI access");const s=ee.outputs.values().find(r=>r.name===t.midi.output);if(!s)throw new Error(`No MIDI output named ${t.midi.output}`);const n=t.midi.channel-1;e.noteOn=(r,i,c=!0)=>{c&&e.currentlyPlayingPitches.push(r),s.send([144+n,r,127],i)},e.noteOff=(r,i,c=!0)=>{s.send([128+n,r,0],i),c&&(e.currentlyPlayingPitches=e.currentlyPlayingPitches.filter(f=>f!==r))},e.allNotesOff=()=>{s.send([176+n,123,0]),e.currentlyPlayingPitches=[]}}class we{constructor(t,s){B(this,"currentlyPlayingPitches",[]);switch(s.type){case d.Log:ge(this);break;case d.Dom:be(this);break;case d.Midi:Pe(this,s);break}}noteOn(t,s,n=!0){}noteOff(t,s,n=!0){}allNotesOff(){}pause(){const t=window.performance.now();for(const s of this.currentlyPlayingPitches)this.noteOff(s,t,!1)}resume(){const t=window.performance.now();for(const s of this.currentlyPlayingPitches)this.noteOn(s,t,!1)}render(){return null}}class H{constructor(t,s){y(this,F);B(this,"controller");B(this,"synthesizer");a(this,F,t),this.controller=new me(t,s.controller),this.synthesizer=new we(t,s.synthesizer)}render(){const t=l("h2",{},o(this,F).toUpperCase()),s=this.controller.render(),n=this.synthesizer.render();return s||n?l("div",{class:"part"},t,s,n):null}}F=new WeakMap;function ke(e){return{bass:new H("bass",e.bass),drum:new H("drum",e.drum),keys:new H("keys",e.keys),lead:new H("lead",e.lead)}}const W=100;function Oe(){return new Worker(new URL(""+new URL("worker-Dukc8-Vk.js",import.meta.url).href,import.meta.url),{type:"module"})}class ve{constructor(t,s){y(this,q);y(this,$);y(this,N,Oe());y(this,k);y(this,D,!1);y(this,L,[]);y(this,A,()=>{});y(this,z,0);y(this,I,0);y(this,U,6e4/120);y(this,j,new Set);a(this,$,t),a(this,k,ke(s)),o(this,N).onmessage=n=>this.schedule()}schedule(){const t=window.performance.now()+W;for(;o(this,D)&&o(this,q,G)<t;){const s=o(this,q,G),n=o(this,L).shift();if(n)switch(n.type){case m.Tempo:a(this,U,6e4/n.bpm);break;case m.Finish:o(this,j).add(n.part),o(this,j).size===4&&o(this,$).stop();break;case m.NoteOn:n.part.synthesizer.noteOn(n.pitch,s);break;case m.NoteOff:n.part.synthesizer.noteOff(n.pitch,s);break;case m.Compute:n.callback(o(this,L));break}}}changeChart(t){a(this,A,()=>{for(const s of Object.values(o(this,k)))s.controller.clear();a(this,L,t.compose(o(this,k)))})()}play(){a(this,D,!0),a(this,z,window.performance.now()+W),a(this,I,0),o(this,N).postMessage(0)}pause(){a(this,D,!1),o(this,N).postMessage(1),a(this,I,window.performance.now()-o(this,z)),setTimeout(()=>{for(const t of Object.values(o(this,k)))t.synthesizer.pause()},W*2)}resume(){a(this,D,!0),a(this,z,window.performance.now()-o(this,I)),o(this,N).postMessage(0);for(const t of Object.values(o(this,k)))t.synthesizer.resume()}stop(){a(this,D,!1),o(this,N).postMessage(1),a(this,I,0),o(this,j).clear(),o(this,A).call(this),setTimeout(()=>{for(const t of Object.values(o(this,k)))t.synthesizer.allNotesOff()},W*2)}render(){const t=Object.values(o(this,k)).map(s=>s.render());return t.some(s=>s!==null)?l("div",{id:"part-container"},...t):null}}$=new WeakMap,N=new WeakMap,k=new WeakMap,D=new WeakMap,L=new WeakMap,A=new WeakMap,z=new WeakMap,I=new WeakMap,U=new WeakMap,j=new WeakMap,q=new WeakSet,G=function(){return o(this,L).length===0?1/0:o(this,L)[0].position*o(this,U)+o(this,z)};class Ce{constructor(t){y(this,g,p.Paused);y(this,v,()=>{});y(this,O);console.debug("Playbacker",t),a(this,O,new ve(this,t))}changeChart(t){console.debug("changeChart",t),o(this,O).changeChart(t),o(this,g)!=p.Stopped&&this.stop()}play(){switch(o(this,g)){case p.Playing:console.debug("already playing");break;case p.Paused:console.debug("resume"),o(this,v).call(this,P.Resume),a(this,g,p.Playing);break;case p.Stopped:console.debug("play"),o(this,v).call(this,P.Play),a(this,g,p.Playing);break}}pause(){switch(o(this,g)){case p.Playing:console.debug("pause"),o(this,v).call(this,P.Pause),a(this,g,p.Paused);break;case p.Paused:console.debug("already paused");break;case p.Stopped:console.debug("already stopped");break}}stop(){switch(o(this,g)){case p.Playing:console.debug("stop"),o(this,v).call(this,P.Stop),a(this,g,p.Stopped);break;case p.Paused:console.debug("stop"),o(this,v).call(this,P.Stop),a(this,g,p.Stopped);break;case p.Stopped:console.debug("already stopped");break}}connect(t){a(this,v,s=>{switch(s){case P.Play:o(this,O).play(),t.changePlayback(p.Playing);break;case P.Pause:o(this,O).pause(),t.changePlayback(p.Paused);break;case P.Resume:o(this,O).resume(),t.changePlayback(p.Playing);break;case P.Stop:o(this,O).stop(),t.changePlayback(p.Stopped);break}})}render(){return o(this,O).render()}}g=new WeakMap,v=new WeakMap,O=new WeakMap;function te(e){e&&document.body.append(e)}function Ne(e){const t=new ae(e.transporter),s=new de,n=new Ce(e.parts);t.connect(s,n),s.connect(t,n),n.connect(t);const r=t.render(),i=n.render();te(r),te(i),s.start()}const De=await re();Ne(De)})();
</script>
  <style rel="stylesheet" crossorigin>:root{--red: #b23535;--green: #38ad5f;--blue: #464ca5;--white: #eeeade;--black: #282828;--text-color: var(--black);--background-color: var(--white)}@media (prefers-color-scheme: dark){:root{--text-color: var(--white);--background-color: var(--black)}}*{color:inherit;background-color:inherit;border-color:inherit;font-family:inherit;box-sizing:inherit}body{min-height:100vh;font-family:Arial,sans-serif;color:var(--text-color);background-color:var(--background-color);border-color:var(--text-color);box-sizing:border-box;padding:0;margin:0}button{color:var(--text-color);background-color:var(--background-color);border:1px solid var(--text-color);cursor:pointer;transition:background-color .3s ease}button:hover{background-color:var(--text-color);color:var(--background-color)}.transporter-button{width:2em;height:2em;border:1.5px solid;border-radius:50%;font-size:2.5rem;padding:1rem;margin:0 .5rem 2rem;cursor:pointer;color:var(--background-color);background-color:var(--text-color);transition:transform .2s}.transporter-button:hover:enabled{transform:scale(1.1)}.transporter-button:disabled{color:var(--text-color);background-color:var(--background-color);cursor:auto}#transporter{text-align:center;border-bottom:1px solid var(--text-color)}.lcd{padding:.5em 1em;border-radius:5px;width:16ch;min-height:4em;line-height:1.5;text-align:left;font-family:hd44780,monospace;color:var(--background-color);background-color:var(--text-color)}input[type=range]{margin-top:1em;width:100%}.controller-module{padding:1em;display:flex;flex-direction:column;align-items:center;border:1px solid;font-size:1vw}.component-title{margin-top:0;margin-bottom:0;width:100%;height:3rem;line-height:3rem;cursor:pointer;-webkit-user-select:none;user-select:none}.controller-row{border-top:1px solid;justify-content:center;align-items:center;overflow-y:scroll;height:40vw}.controller{padding-top:0;border:1px solid}.note-on{color:var(--green)}.note-off{color:var(--red)}.all-notes-off{color:var(--blue)}.message-row{width:100%;height:10vw;overflow-y:scroll}.synthesizer-row{width:100%}.synthesizer{display:flex;flex-direction:column;align-items:center;width:100%;border:1px solid}.part{text-align:center;border:1px solid;min-width:20%}#part-container{display:flex;flex-wrap:wrap;justify-content:space-around;align-items:start}.hidden{display:none}
</style>
</head>

<body>
</body>

</html>