<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sequencer</title>
  <script type="module" crossorigin>var at=Object.defineProperty;var fe=p=>{throw TypeError(p)};var ct=(p,d,m)=>d in p?at(p,d,{enumerable:!0,configurable:!0,writable:!0,value:m}):p[d]=m;var u=(p,d,m)=>ct(p,typeof d!="symbol"?d+"":d,m),me=(p,d,m)=>d.has(p)||fe("Cannot "+m);var i=(p,d,m)=>(me(p,d,"read from private field"),m?m.call(p):d.get(p)),g=(p,d,m)=>d.has(p)?fe("Cannot add the same private member more than once"):d instanceof WeakSet?d.add(p):d.set(p,m),h=(p,d,m,f)=>(me(p,d,"write to private field"),f?f.call(p,m):d.set(p,m),m);(async()=>{var O,A,N,R,$,U,G,j,S,M,L,_,H,F,x,B,q,ne,v,k,D;(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))t(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&t(o)}).observe(document,{childList:!0,subtree:!0});function e(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function t(r){if(r.ep)return;r.ep=!0;const n=e(r);fetch(r.href,n)}})();var p=(s=>(s[s.Dom=0]="Dom",s[s.Midi=1]="Midi",s))(p||{}),d=(s=>(s[s.Dom=0]="Dom",s[s.Midi=1]="Midi",s))(d||{}),m=(s=>(s[s.Log=0]="Log",s[s.Dom=1]="Dom",s[s.Midi=2]="Midi",s))(m||{}),f=(s=>(s[s.Playing=0]="Playing",s[s.Paused=1]="Paused",s[s.Stopped=2]="Stopped",s))(f||{}),I=(s=>(s[s.Play=0]="Play",s[s.Pause=1]="Pause",s[s.Resume=2]="Resume",s[s.Stop=3]="Stop",s))(I||{}),C=(s=>(s[s.Finish=0]="Finish",s[s.NoteOn=1]="NoteOn",s[s.NoteOff=2]="NoteOff",s[s.Compute=3]="Compute",s))(C||{});function a(s,e={},...t){const r=document.createElement(s);for(const[n,o]of Object.entries(e))r.setAttribute(n,o);for(const n of t)typeof n=="string"?r.appendChild(document.createTextNode(n)):n&&r.appendChild(n);return r}const E=await navigator.requestMIDIAccess({sysex:!0}).catch(()=>null);function J(s,e,t){const r=[];if(!E)return r.push(`The ${s} cannot be type MIDI without MIDI access`),r;const n=E[t].values(),o=Array.from(n);if(!o)return r.push(`No MIDI ${t}`),r;const c=o.find(({name:l})=>l===e);return console.log("port",c),c||r.push(`No MIDI ${t} named ${e} for ${s}`),r}function oe(s,e){const t=[],{input:r,output:n}=e;return r?t.push(...J(s,r,"inputs")):t.push(`No MIDI input for ${s}`),n?t.push(...J(s,n,"outputs")):t.push(`No MIDI output for ${s}`),t.length||r===n&&t.push(`Input and output are the same for ${s}`),t}function ge(s,e){const t=[],{output:r,channel:n}=e;return r?t.push(...J(s,r,"outputs")):t.push(`No MIDI output for ${s}`),n?(n<1||n>16)&&t.push(`Invalid MIDI channel for ${s}: ${n}`):t.push(`No MIDI channel for ${s}`),t}function ye(s){const e=[];if(s.type===void 0)return e.push("No transporter type"),e;if(!(s.type in p))return e.push(`Invalid transporter type: ${s.type}`),e;if(s.type===p.Midi){if(!E)return e.push("No MIDI access"),e;const{midi:t}=s;if(!t)return e.push("No MIDI config"),e;e.push(...oe("Transporter",t))}return e}function Ce(s,e){const t=[];if(e.type===void 0)return t.push(`No controller type for ${s} part`),t;if(!(e.type in d))return t.push(`Invalid controller type for ${s} part: ${e.type}`),t;if(e.type===d.Midi){if(!E)return t.push("No MIDI access"),t;const{midi:r}=e;if(!r)return t.push("No MIDI config"),t;t.push(...oe(`${s} controller`,r))}return t}function be(s,e){const t=[];if(e.type===void 0)return t.push(`No synthesizer type for ${s} part`),t;if(e.type in m||t.push(`Invalid synthesizer type for ${s} part: ${e.type}`),e.type===m.Midi){if(!E)return t.push("No MIDI access"),t;const{midi:r}=e;if(!r)return t.push("No MIDI config"),t;t.push(...ge(`${s} synthesizer`,r))}return t}function ve(s,e){const t=[],{controller:r,synthesizer:n}=e;return r?t.push(...Ce(s,r)):t.push(`No controller for ${s} part`),n?t.push(...be(s,n)):t.push(`No synthesizer for ${s} part`),t}function we(s){const e=[],t=["bass","drum","keys","lead"];for(const r of t){const n=s[r];if(!n){e.push(`No ${r} part`);continue}e.push(...ve(r,n))}return e}function Ie(s){const e=[],{transporter:t,parts:r}=s;return t?e.push(...ye(t)):e.push("No transporter"),r?e.push(...we(r)):e.push("No parts"),e}const Ee=[["DOM",p.Dom],["MIDI",p.Midi]],Pe=[["DOM",d.Dom],["MIDI",d.Midi]],Oe=[["DOM",m.Dom],["MIDI",m.Midi]],P={CONFIG_FORM_ID:"config-form",TRANSPORTER_CONFIG_ID:"transporter-config",PART_CONFIG_CLASS:"part-config",TYPE_DIV_CLASS:"type-div",MIDI_DIV_CLASS:"midi-div",MIDI_INPUT_SELECT_CLASS:"midi-input-select",MIDI_OUTPUT_SELECT_CLASS:"midi-output-select",REMEMBER_CHECKBOX_ID:"remember-config"};function Q(s,e){if(!s.div)throw new Error("setUpRadioButtons called before render");const t=Array.from(s.div.querySelectorAll('input[type="radio"]'));for(const r of t)for(const[n,o]of e)r.addEventListener("change",()=>{if(!o.div)throw new Error("setUpRadioButtons called before render");o.div.classList[Number(r.value)===n?"remove":"add"]("hidden")})}class Z{constructor(e,t,r){u(this,"name");u(this,"title");u(this,"typeNamesAndEnums");u(this,"inputs");u(this,"div");this.name=e,this.title=t,this.typeNamesAndEnums=r,this.inputs={},this.div=null}render(){const e=this.typeNamesAndEnums.map(([t,r])=>{const n=`${this.name}-${t}`,o=a("input",{id:n,type:"radio",name:this.name,value:r}),c=a("label",{for:n},t);return this.inputs[r]=o,[o,c]}).flat();return this.div=a("div",{class:P.TYPE_DIV_CLASS},this.title,...e)}getConfig(){if(!this.div)throw new Error("getConfig called before render");return Number(this.div.querySelector('input[type="radio"]:checked').value)}}class ie{constructor(){u(this,"inputSelect",null);u(this,"outputSelect",null);u(this,"div",null)}render(){const e=this.inputSelect=a("select",{class:P.MIDI_INPUT_SELECT_CLASS}),t=this.outputSelect=a("select",{class:P.MIDI_OUTPUT_SELECT_CLASS});return this.div=a("div",{},e," \u2192 Here \u2192 ",t)}getConfig(){if(!this.inputSelect||!this.outputSelect)throw new Error("getConfig called before render");return{input:this.inputSelect.value,output:this.outputSelect.value}}}class Me{constructor(){u(this,"select",null);u(this,"input",null);u(this,"div",null)}render(){const e=this.select=a("select",{class:P.MIDI_OUTPUT_SELECT_CLASS}),t=this.input=a("input",{type:"number",name:"channel",min:1,max:16,value:1});return this.div=a("div",{},e," on channel ",t)}getConfig(){if(!this.select||!this.input)throw new Error("getConfig called before render");return{output:this.select.value,channel:this.input.value}}}class De{constructor(){u(this,"typeConfig",new Z("transporter-type","Type: ",Ee));u(this,"midiConfig",new ie)}render(){const e=a("legend",{},"TRANSPORTER"),t=this.typeConfig.render(),r=this.midiConfig.render();return a("fieldset",{id:P.TRANSPORTER_CONFIG_ID},e,t,r)}setUp(){Q(this.typeConfig,[[p.Midi,this.midiConfig]])}getConfig(){const e={};return(e.type=this.typeConfig.getConfig())===p.Midi&&(e.midi=this.midiConfig.getConfig()),e}}class ke{constructor(e){u(this,"typeConfig");u(this,"midiConfig",new ie);u(this,"div",null);this.typeConfig=new Z(`${e}-controller-type`,"Controller: ",Pe)}render(){const e=this.typeConfig.render(),t=this.midiConfig.render();return this.div=a("div",{},e,t)}setUp(){Q(this.typeConfig,[[d.Midi,this.midiConfig]])}getConfig(){const e={};return(e.type=this.typeConfig.getConfig())===d.Midi&&(e.midi=this.midiConfig.getConfig()),e}}class Ne{constructor(e){u(this,"typeConfig");u(this,"midiConfig",new Me);this.typeConfig=new Z(`${e}-synthesizer-type`,"Synthesizer: ",Oe)}render(){const e=this.typeConfig.render(),t=this.midiConfig.render();return a("div",{},e,t)}setUp(){Q(this.typeConfig,[[m.Midi,this.midiConfig]])}getConfig(){const e={};return(e.type=this.typeConfig.getConfig())===m.Midi&&(e.midi=this.midiConfig.getConfig()),e}}class K{constructor(e){u(this,"name");u(this,"controllerConfig");u(this,"synthesizerConfig");this.name=e,this.controllerConfig=new ke(e),this.synthesizerConfig=new Ne(e)}render(){const e=a("legend",{},this.name.toUpperCase()),t=this.controllerConfig.render(),r=a("hr"),n=this.synthesizerConfig.render();return a("fieldset",{},e,t,r,n)}setUp(){this.controllerConfig.setUp(),this.synthesizerConfig.setUp()}getConfig(){return{controller:this.controllerConfig.getConfig(),synthesizer:this.synthesizerConfig.getConfig()}}}class Se{constructor(){u(this,"div",null)}render(){return this.div=a("div",{class:"problem-div"})}addProblems(e){if(!this.div)throw new Error("addProblems called before render");const t=this.div;t.innerHTML="";for(const r of e){const n=a("p",{},r);t.appendChild(n)}}}class Le{constructor(){u(this,"refreshButton",null);u(this,"rememberCheckbox",null);u(this,"problemDiv",new Se)}render(){const e=this.refreshButton=a("button",{type:"button"},"Refresh MIDI Ports"),t=this.rememberCheckbox=a("input",{type:"checkbox",id:P.REMEMBER_CHECKBOX_ID}),r=a("label",{for:P.REMEMBER_CHECKBOX_ID},"Remember"),n=a("button",{type:"submit"},"Submit"),o=this.problemDiv.render();return a("div",{},e,t,r,n,o)}setUp(){}}class _e{constructor(){u(this,"transporterConfig",new De);u(this,"partConfigs",{bass:new K("bass"),drum:new K("drum"),keys:new K("keys"),lead:new K("lead")});u(this,"miscellaneousDiv",new Le);u(this,"form",null)}render(){const e=this.transporterConfig.render(),t=Object.values(this.partConfigs).map(n=>n.render()),r=this.miscellaneousDiv.render();return this.form=a("form",{id:P.CONFIG_FORM_ID},e,...t,r)}setUp(){if(!this.form)throw new Error("setUp called before render");this.transporterConfig.setUp();for(const e of Object.values(this.partConfigs))e.setUp();if(!this.miscellaneousDiv.refreshButton)throw new Error("setUp called before render");this.miscellaneousDiv.refreshButton.addEventListener("mousedown",this.refreshMidi.bind(this)),this.refreshMidi(),this.clickAllFirstRadioButtons(),this.form.classList.remove("hidden")}getConfig(){return{transporter:this.transporterConfig.getConfig(),parts:{bass:this.partConfigs.bass.getConfig(),drum:this.partConfigs.drum.getConfig(),keys:this.partConfigs.keys.getConfig(),lead:this.partConfigs.lead.getConfig()}}}refreshMidi(){if(!this.form)throw new Error("refreshMidi called before render");const e=Array.from(this.form.querySelectorAll('input[type="radio"][value="midi"]'));for(const r of e)r.disabled=!E;if(!E)return;function t(r,n){const o=document.getElementsByClassName(r),c=Array.from(E[n].values()).map(l=>l.name);for(const l of o){const y=l.value||c[0];l.innerHTML="";for(const b of c){const w=a("option",{value:b},b);l.appendChild(w)}c.includes(y)&&(l.value=y)}}t(P.MIDI_INPUT_SELECT_CLASS,"inputs"),t(P.MIDI_OUTPUT_SELECT_CLASS,"outputs")}clickAllFirstRadioButtons(){if(!this.form)throw new Error("clickAllFirstRadioButtons called before render");const e=Array.from(this.form.querySelectorAll('input[type="radio"]:enabled:first-of-type'));for(const t of e)t.click()}getPromise(){return new Promise(e=>{if(!this.form)throw new Error("getPromise called before render");this.form.addEventListener("submit",t=>{if(!this.form)throw new Error("submit event listener called after form was removed");t.preventDefault();const r=this.getConfig(),n=Ie(r);this.miscellaneousDiv.problemDiv.addProblems(n),!n.length&&(this.form.remove(),e(r))})})}}async function Te(){const s=new _e;return document.body.append(s.render()),s.setUp(),await s.getPromise()}const Ae=async()=>await Te();function Re(s){const e=a("h2"),t={previous:a("button",{class:"transporter-button"},"\u23EE"),play:a("button",{class:"transporter-button"},"\u25B6"),pause:a("button",{class:"transporter-button"},"\u23F8"),stop:a("button",{class:"transporter-button"},"\u23F9"),next:a("button",{class:"transporter-button"},"\u23ED")};s.connect=(o,c)=>{t.previous.addEventListener("click",()=>o.goPrevious()),t.next.addEventListener("click",()=>o.goNext()),t.play.addEventListener("click",()=>c.play()),t.pause.addEventListener("click",()=>c.pause()),t.stop.addEventListener("click",()=>c.stop())},s.changeChart=(o,c,l)=>{e.innerText=o,t.previous.disabled=!c,t.next.disabled=!l},s.changePlayback=o=>{t.play.disabled=o===f.Playing,t.pause.disabled=o!==f.Playing,t.stop.disabled=o===f.Stopped};const r=a("div",{},...Object.values(t)),n=a("div",{id:"transporter"},e,r);s.render=()=>n}class $e{constructor(e){switch(e.type){case p.Dom:Re(this);break;default:throw new Error(`Invalid Transporter type: ${e}`)}}connect(e,t){}changeChart(e,t,r){}changePlayback(e){}render(){return null}}function ee(s){const e=s[0].toUpperCase(),t=parseInt(s[1]);if(isNaN(t))throw new Error(`Invalid pitch: ${s}`);const r={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[e];if(r===void 0)throw new Error(`Invalid pitch name: ${e}`);return 12*t+r}function te(s){return 6e4/s}function V(...s){const e={millisecondsPerBeat:te(120),position:-1/0,bufferEvents:[]};return s.reduce((t,r)=>r(t),e).bufferEvents}function se(s){return e=>Object.assign({},e,{millisecondsPerBeat:te(s)})}function re(s,e,t,r,n){if(typeof e=="function")return o=>{const{millisecondsPerBeat:c}=o,l=b=>{const w=e(),ot={time:t*c,type:C.NoteOn,part:s,pitch:w,velocity:n},it={time:(t+r)*c,type:C.NoteOff,part:s,pitch:w};b.unshift(ot,it)},y={time:t*c-100,type:C.Compute,callback:l};return Object.assign({},o,{position:t+r,bufferEvents:[...o.bufferEvents,y]})};{const o=typeof e=="number"?e:ee(e);return c=>{const{millisecondsPerBeat:l}=c,y={time:t*l,type:C.NoteOn,part:s,pitch:o,velocity:n},b={time:(t+r)*l,type:C.NoteOff,part:s,pitch:o};return Object.assign({},c,{position:t+r,bufferEvents:[...c.bufferEvents,y,b]})}}}function T(...s){return e=>{const{position:t,millisecondsPerBeat:r,bufferEvents:n}=e,o=s.map(c=>({time:t*r,type:C.Finish,part:c}));return Object.assign({},e,{bufferEvents:[...n,...o]})}}const Ue={title:"Hello World",compose:({bass:s,drum:e,keys:t,lead:r})=>V(T(s,e,t),se(60),re(r,"C4",0,4,127),T(r))},Fe=["C2","D2","E2","F2","G2","A2","B2","C3"],xe={title:"Bass Scale",compose:({bass:s,drum:e,keys:t,lead:r})=>V(T(e,t,r),se(120),...Fe.map((n,o)=>re(s,n,o,.9,127)),T(s))},ze=[["C4",0,.9],["C4",1,.9],["G4",2,.9],["G4",3,.9],["A4",4,.9],["A4",5,.9],["G4",6,1.9],["F4",8,.9],["F4",9,.9],["E4",10,.9],["E4",11,.9],["D4",12,.9],["D4",13,.9],["C4",14,1.9],["G4",16,.9],["G4",17,.9],["F4",18,.9],["F4",19,.9],["E4",20,.9],["E4",21,.9],["D4",22,1.9],["G4",24,.9],["G4",25,.9],["F4",26,.9],["F4",27,.9],["E4",28,.9],["E4",29,.9],["D4",30,1.9],["C4",32,.9],["C4",33,.9],["G4",34,.9],["G4",35,.9],["A4",36,.9],["A4",37,.9],["G4",38,1.9],["F4",40,.9],["F4",41,.9],["E4",42,.9],["E4",43,.9],["D4",44,.9],["D4",45,.9],["C4",46,2]];function Be(s){const e=s.controller.getRangeControl("8va chance: ",0,100,"%");return ze.map(([t,r,n])=>{const o=Math.random()*100,c=ee(t);return re(s,()=>e.value>o?c+12:c,r,n,127)})}const Ge={title:"Twinkle Twinkle Little Star",compose:({bass:s,drum:e,keys:t,lead:r})=>V(T(s,e,t),se(120),...Be(r),T(r))},ae=["E3","G3","A3","G3","D4","C4","D4","E4"],ce=2,le=ce/ae.length,Y=te(165);function je(s){const e=ae.map(ee);return t=>{const r=s.controller.getOptionControl("Repeat again: ",["No","Yes"],"!"),n=o=>({time:o*Y-100,type:C.Compute,callback:c=>{if(r.value){const l=e.map((y,b)=>{const w=o+b*le;return[{time:w*Y,type:C.NoteOn,part:s,pitch:y,velocity:127},{time:(w+le-.05)*Y,type:C.NoteOff,part:s,pitch:y}]}).flat();c.push(...l,n(o+ce))}else c.push({time:o*Y,type:C.Finish,part:s})}});return Object.assign({},t,{bufferEvents:[...t.bufferEvents,n(0)]})}}const He={title:"On the Run",compose:({bass:s,drum:e,keys:t,lead:r})=>V(T(s,e,t),je(r))},ue=[Ue,xe,Ge,He],he=ue.length;class qe{constructor(){g(this,O,0);g(this,A,()=>{})}goPrevious(){i(this,O)>0&&(h(this,O,i(this,O)-1),i(this,A).call(this))}goNext(){i(this,O)<he-1&&(h(this,O,i(this,O)+1),i(this,A).call(this))}connect(e,t){h(this,A,()=>{const r=ue[i(this,O)],n=r.title,o=i(this,O)>0,c=i(this,O)<he-1;e.changeChart(n,o,c),t.changeChart(r)})}start(){i(this,A).call(this)}}O=new WeakMap,A=new WeakMap;const pe=12,z={min:0,max:127,step:1,default:63};class Ke{constructor(){g(this,N);g(this,R);g(this,$,()=>{});g(this,U,()=>0);const e=a("span",{},"EMPTY");h(this,N,{0:a("span",{},"%%"),1:e,2:a("span",{},"%%")}),h(this,R,a("input",{type:"range",min:z.min,max:z.max,step:z.step,value:z.default})).addEventListener("input",()=>{i(this,$).call(this)})}clear(){h(this,U,()=>0),h(this,$,()=>{});const e=Object.values(i(this,N));for(const t of e)t.textContent=""}get value(){return i(this,U).call(this)}makeIntoRangeControl(e,t,r,n=""){const o=i(this,N),c=o[1],l=i(this,R);o[0].textContent=e,o[2].textContent=n;const y=h(this,U,()=>t+Math.round((r-t)*Number(l.value)/z.max));h(this,$,()=>{c.textContent=y().toString()})()}makeIntoOptionControl(e,t,r=""){const n=i(this,N),o=n[1],c=i(this,R);n[0].textContent=e,n[2].textContent=r;const l=h(this,U,()=>Math.round((t.length-1)*Number(c.value)/z.max));h(this,$,()=>{o.textContent=t[l()]})()}render(){const e=a("label",{class:"lcd"},...Object.values(i(this,N)));return a("div",{class:"controller-module"},e,i(this,R))}}N=new WeakMap,R=new WeakMap,$=new WeakMap,U=new WeakMap;function Ve(s){const e=Array.from({length:pe},()=>new Ke);let t=0;s.clear=()=>{e.forEach(n=>n.clear()),t=0};function r(){if(t>=pe)throw new Error("No more controllers available");const n=e[t];return t+=1,n}s.getRangeControl=(n,o,c,l="")=>{const y=r();return y.makeIntoRangeControl(n,o,c,l),y},s.getOptionControl=(n,o,c="")=>{const l=r();return l.makeIntoOptionControl(n,o,c),l},s.render=()=>{const n=a("h2",{class:"component-title"},"Controller"),o=e.map(l=>l.render()),c=a("div",{class:"controller-row"},...o);return n.addEventListener("click",()=>{c.classList.toggle("hidden")}),a("div",{class:"controller"},n,c)}}class Ye{constructor(e,t){switch(t.type){case d.Dom:Ve(this);break;default:throw new Error(`Invalid Controller type: ${t}`)}}clear(){}getRangeControl(e,t,r,n=""){return{value:0}}getOptionControl(e,t,r=""){return{value:0}}render(){return null}}function Xe(s){s.noteOn=(e,t,r)=>{console.log("noteOn",e,r,t)},s.noteOff=(e,t)=>{console.log("noteOff",e,t)},s.allNotesOff=()=>{console.log("allNotesOff")}}function We(s){const e=a("h2",{class:"component-title"},"Synthesizer"),t=a("button",{},"Clear"),r=a("div",{class:"message-row"}),n=a("div",{class:"synthesizer-row"},t,r),o=a("div",{class:"synthesizer"},e,n);function c(l,y){const b=a("div",{class:y},l);r.appendChild(b),r.scrollTop=r.scrollHeight}s.noteOn=(l,y,b,w=!0)=>{w&&s.currentlyPlayingPitches.push(l),c(`noteOn ${l} ${y} ${b.toFixed(0)}`,"note-on")},s.noteOff=(l,y,b=!0)=>{c(`noteOff ${l} ${y.toFixed(0)}`,"note-off"),b&&(s.currentlyPlayingPitches=s.currentlyPlayingPitches.filter(w=>w!==l))},s.allNotesOff=()=>{c("allNotesOff","all-notes-off"),s.currentlyPlayingPitches=[]},t.addEventListener("click",()=>{r.innerHTML=""}),e.addEventListener("click",()=>{n.classList.toggle("hidden")}),s.render=()=>o}function Je(s,e){if(!E)throw new Error("No MIDI access");const t=E.outputs.values().find(n=>n.name===e.midi.output);if(!t)throw new Error(`No MIDI output named ${e.midi.output}`);const r=e.midi.channel-1;s.noteOn=(n,o,c,l=!0)=>{l&&s.currentlyPlayingPitches.push(n),t.send([144+r,n,o],c)},s.noteOff=(n,o,c=!0)=>{t.send([128+r,n,0],o),c&&(s.currentlyPlayingPitches=s.currentlyPlayingPitches.filter(l=>l!==n))},s.allNotesOff=()=>{t.send([176+r,123,0]),s.currentlyPlayingPitches=[]}}class Qe{constructor(e,t){u(this,"currentlyPlayingPitches",[]);switch(t.type){case m.Log:Xe(this);break;case m.Dom:We(this);break;case m.Midi:Je(this,t);break}}noteOn(e,t,r,n=!0){}noteOff(e,t,r=!0){}allNotesOff(){}pause(){const e=window.performance.now();for(const t of this.currentlyPlayingPitches)this.noteOff(t,e,!1)}resume(){const e=window.performance.now();for(const t of this.currentlyPlayingPitches)this.noteOn(t,31,e,!1)}render(){return null}}class X{constructor(e,t){g(this,G);u(this,"controller");u(this,"synthesizer");h(this,G,e),this.controller=new Ye(e,t.controller),this.synthesizer=new Qe(e,t.synthesizer)}render(){const e=a("h2",{},i(this,G).toUpperCase()),t=this.controller.render(),r=this.synthesizer.render();return t||r?a("div",{class:"part"},e,t,r):null}}G=new WeakMap;function Ze(s){return{bass:new X("bass",s.bass),drum:new X("drum",s.drum),keys:new X("keys",s.keys),lead:new X("lead",s.lead)}}const W=100;function et(){return new Worker(new URL(""+new URL("worker-Dukc8-Vk.js",import.meta.url).href,import.meta.url),{type:"module"})}class tt{constructor(e,t){g(this,q);g(this,j);g(this,S,et());g(this,M);g(this,L,!1);g(this,_,[]);g(this,H,()=>{});g(this,F,0);g(this,x,0);g(this,B,new Set);h(this,j,e),h(this,M,Ze(t)),i(this,S).onmessage=r=>this.schedule()}schedule(){const e=window.performance.now()+W;for(;i(this,L)&&i(this,q,ne)<e;){const t=i(this,q,ne),r=i(this,_).shift();if(r)switch(r.type){case C.Finish:i(this,B).add(r.part),i(this,B).size===4&&i(this,j).stop();break;case C.NoteOn:r.part.synthesizer.noteOn(r.pitch,r.velocity,t);break;case C.NoteOff:r.part.synthesizer.noteOff(r.pitch,t);break;case C.Compute:r.callback(i(this,_));break}}}changeChart(e){h(this,H,()=>{for(const t of Object.values(i(this,M)))t.controller.clear();console.debug("buffer",h(this,_,e.compose(i(this,M))))})()}play(){h(this,L,!0),h(this,F,window.performance.now()+W),h(this,x,0),i(this,S).postMessage(0)}pause(){h(this,L,!1),i(this,S).postMessage(1),h(this,x,window.performance.now()-i(this,F)),setTimeout(()=>{for(const e of Object.values(i(this,M)))e.synthesizer.pause()},W*2)}resume(){h(this,L,!0),h(this,F,window.performance.now()-i(this,x)),i(this,S).postMessage(0);for(const e of Object.values(i(this,M)))e.synthesizer.resume()}stop(){h(this,L,!1),i(this,S).postMessage(1),h(this,x,0),i(this,B).clear(),i(this,H).call(this),setTimeout(()=>{for(const e of Object.values(i(this,M)))e.synthesizer.allNotesOff()},W*2)}render(){const e=Object.values(i(this,M)).map(t=>t.render());return e.some(t=>t!==null)?a("div",{id:"part-container"},...e):null}}j=new WeakMap,S=new WeakMap,M=new WeakMap,L=new WeakMap,_=new WeakMap,H=new WeakMap,F=new WeakMap,x=new WeakMap,B=new WeakMap,q=new WeakSet,ne=function(){return i(this,_).length===0?1/0:i(this,_)[0].time+i(this,F)};class st{constructor(e){g(this,v,f.Paused);g(this,k,()=>{});g(this,D);console.debug("Playbacker",e),h(this,D,new tt(this,e))}changeChart(e){console.debug("changeChart",e),i(this,D).changeChart(e),i(this,v)!=f.Stopped&&this.stop()}play(){switch(i(this,v)){case f.Playing:console.debug("already playing");break;case f.Paused:console.debug("resume"),i(this,k).call(this,I.Resume),h(this,v,f.Playing);break;case f.Stopped:console.debug("play"),i(this,k).call(this,I.Play),h(this,v,f.Playing);break}}pause(){switch(i(this,v)){case f.Playing:console.debug("pause"),i(this,k).call(this,I.Pause),h(this,v,f.Paused);break;case f.Paused:console.debug("already paused");break;case f.Stopped:console.debug("already stopped");break}}stop(){switch(i(this,v)){case f.Playing:console.debug("stop"),i(this,k).call(this,I.Stop),h(this,v,f.Stopped);break;case f.Paused:console.debug("stop"),i(this,k).call(this,I.Stop),h(this,v,f.Stopped);break;case f.Stopped:console.debug("already stopped");break}}connect(e){h(this,k,t=>{switch(t){case I.Play:i(this,D).play(),e.changePlayback(f.Playing);break;case I.Pause:i(this,D).pause(),e.changePlayback(f.Paused);break;case I.Resume:i(this,D).resume(),e.changePlayback(f.Playing);break;case I.Stop:i(this,D).stop(),e.changePlayback(f.Stopped);break}})}render(){return i(this,D).render()}}v=new WeakMap,k=new WeakMap,D=new WeakMap;function de(s){s&&document.body.append(s)}function rt(s){const e=new $e(s.transporter),t=new qe,r=new st(s.parts);e.connect(t,r),t.connect(e,r),r.connect(e);const n=e.render(),o=r.render();de(n),de(o),t.start()}const nt=await Ae();rt(nt)})();
</script>
  <style rel="stylesheet" crossorigin>:root{--red: #b23535;--green: #38ad5f;--blue: #464ca5;--white: #eeeade;--black: #282828;--text-color: var(--black);--background-color: var(--white)}@media (prefers-color-scheme: dark){:root{--text-color: var(--white);--background-color: var(--black)}}*{color:inherit;background-color:inherit;border-color:inherit;font-family:inherit;box-sizing:inherit}body{min-height:100vh;font-family:Arial,sans-serif;color:var(--text-color);background-color:var(--background-color);border-color:var(--text-color);box-sizing:border-box;padding:0;margin:0}#config-form{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}fieldset{margin-bottom:20px}legend{font-weight:700;margin-bottom:10px}.type-div{margin-bottom:10px}label{-webkit-user-select:none;user-select:none}input[type=radio]:disabled+label{text-decoration:line-through}button{color:var(--text-color);background-color:var(--background-color);border:1px solid var(--text-color);cursor:pointer;transition:background-color .3s ease}button:hover{background-color:var(--text-color);color:var(--background-color)}.transporter-button{width:2em;height:2em;border:1.5px solid;border-radius:50%;font-size:2.5rem;padding:1rem;margin:0 .5rem 2rem;cursor:pointer;color:var(--background-color);background-color:var(--text-color);transition:transform .2s}.transporter-button:hover:enabled{transform:scale(1.1)}.transporter-button:disabled{color:var(--text-color);background-color:var(--background-color);cursor:auto}#transporter{text-align:center;border-bottom:1px solid var(--text-color)}.lcd{padding:.5em 1em;border-radius:5px;width:16ch;min-height:4em;line-height:1.5;text-align:left;font-family:hd44780,monospace;color:var(--background-color);background-color:var(--text-color)}input[type=range]{margin-top:1em;width:100%}.controller-module{padding:1em;display:flex;flex-direction:column;align-items:center;border:1px solid;font-size:1vw}.component-title{margin-top:0;margin-bottom:0;width:100%;height:3rem;line-height:3rem;cursor:pointer;-webkit-user-select:none;user-select:none}.controller-row{border-top:1px solid;justify-content:center;align-items:center;overflow-y:scroll;height:40vw}.controller{padding-top:0;border:1px solid}.note-on{color:var(--green)}.note-off{color:var(--red)}.all-notes-off{color:var(--blue)}.message-row{width:100%;height:10vw;overflow-y:scroll}.synthesizer-row{width:100%}.synthesizer{display:flex;flex-direction:column;align-items:center;width:100%;border:1px solid}.part{text-align:center;border:1px solid;min-width:20%}#part-container{display:flex;flex-wrap:wrap;justify-content:space-around;align-items:start}.hidden{display:none}
</style>
</head>

<body>
</body>

</html>