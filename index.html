<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sequencer</title>
  <script type="module" crossorigin>var ae=Object.defineProperty;var mt=h=>{throw TypeError(h)};var ce=(h,d,m)=>d in h?ae(h,d,{enumerable:!0,configurable:!0,writable:!0,value:m}):h[d]=m;var p=(h,d,m)=>ce(h,typeof d!="symbol"?d+"":d,m),gt=(h,d,m)=>d.has(h)||mt("Cannot "+m);var n=(h,d,m)=>(gt(h,d,"read from private field"),m?m.call(h):d.get(h)),y=(h,d,m)=>d.has(h)?mt("Cannot add the same private member more than once"):d instanceof WeakSet?d.add(h):d.set(h,m),u=(h,d,m,f)=>(gt(h,d,"write to private field"),f?f.call(h,m):d.set(h,m),m);(async()=>{var O,_,E,R,$,A,B,j,S,M,D,L,H,U,x,q,F,G,st,v,N,k;(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))e(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&e(i)}).observe(document,{childList:!0,subtree:!0});function t(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function e(o){if(o.ep)return;o.ep=!0;const r=t(o);fetch(o.href,r)}})();var h=(s=>(s[s.Dom=0]="Dom",s[s.Midi=1]="Midi",s))(h||{}),d=(s=>(s[s.Dom=0]="Dom",s[s.Midi=1]="Midi",s))(d||{}),m=(s=>(s[s.Log=0]="Log",s[s.Dom=1]="Dom",s[s.Midi=2]="Midi",s))(m||{}),f=(s=>(s[s.Playing=0]="Playing",s[s.Paused=1]="Paused",s[s.Stopped=2]="Stopped",s))(f||{}),w=(s=>(s[s.Play=0]="Play",s[s.Pause=1]="Pause",s[s.Resume=2]="Resume",s[s.Stop=3]="Stop",s))(w||{}),g=(s=>(s[s.Tempo=0]="Tempo",s[s.Finish=1]="Finish",s[s.NoteOn=2]="NoteOn",s[s.NoteOff=3]="NoteOff",s[s.Compute=4]="Compute",s))(g||{});function a(s,t={},...e){const o=document.createElement(s);for(const[r,i]of Object.entries(t))o.setAttribute(r,i);for(const r of e)typeof r=="string"?o.appendChild(document.createTextNode(r)):r&&o.appendChild(r);return o}const I=await navigator.requestMIDIAccess({sysex:!0}).catch(()=>null);function Q(s,t,e){const o=[];if(!I)return o.push(`The ${s} cannot be type MIDI without MIDI access`),o;const r=I[e].values(),i=Array.from(r);if(!i)return o.push(`No MIDI ${e}`),o;const c=i.find(({name:l})=>l===t);return console.log("port",c),c||o.push(`No MIDI ${e} named ${t} for ${s}`),o}function ot(s,t){const e=[],{input:o,output:r}=t;return o?e.push(...Q(s,o,"inputs")):e.push(`No MIDI input for ${s}`),r?e.push(...Q(s,r,"outputs")):e.push(`No MIDI output for ${s}`),e.length||o===r&&e.push(`Input and output are the same for ${s}`),e}function yt(s,t){const e=[],{output:o,channel:r}=t;return o?e.push(...Q(s,o,"outputs")):e.push(`No MIDI output for ${s}`),r?(r<1||r>16)&&e.push(`Invalid MIDI channel for ${s}: ${r}`):e.push(`No MIDI channel for ${s}`),e}function Ct(s){const t=[];if(s.type===void 0)return t.push("No transporter type"),t;if(!(s.type in h))return t.push(`Invalid transporter type: ${s.type}`),t;if(s.type===h.Midi){if(!I)return t.push("No MIDI access"),t;const{midi:e}=s;if(!e)return t.push("No MIDI config"),t;t.push(...ot("Transporter",e))}return t}function bt(s,t){const e=[];if(t.type===void 0)return e.push(`No controller type for ${s} part`),e;if(!(t.type in d))return e.push(`Invalid controller type for ${s} part: ${t.type}`),e;if(t.type===d.Midi){if(!I)return e.push("No MIDI access"),e;const{midi:o}=t;if(!o)return e.push("No MIDI config"),e;e.push(...ot(`${s} controller`,o))}return e}function vt(s,t){const e=[];if(t.type===void 0)return e.push(`No synthesizer type for ${s} part`),e;if(t.type in m||e.push(`Invalid synthesizer type for ${s} part: ${t.type}`),t.type===m.Midi){if(!I)return e.push("No MIDI access"),e;const{midi:o}=t;if(!o)return e.push("No MIDI config"),e;e.push(...yt(`${s} synthesizer`,o))}return e}function wt(s,t){const e=[],{controller:o,synthesizer:r}=t;return o?e.push(...bt(s,o)):e.push(`No controller for ${s} part`),r?e.push(...vt(s,r)):e.push(`No synthesizer for ${s} part`),e}function It(s){const t=[],e=["bass","drum","keys","lead"];for(const o of e){const r=s[o];if(!r){t.push(`No ${o} part`);continue}t.push(...wt(o,r))}return t}function Pt(s){const t=[],{transporter:e,parts:o}=s;return e?t.push(...Ct(e)):t.push("No transporter"),o?t.push(...It(o)):t.push("No parts"),t}const Ot=[["DOM",h.Dom],["MIDI",h.Midi]],Mt=[["DOM",d.Dom],["MIDI",d.Midi]],kt=[["DOM",m.Dom],["MIDI",m.Midi]],P={CONFIG_FORM_ID:"config-form",TRANSPORTER_CONFIG_ID:"transporter-config",PART_CONFIG_CLASS:"part-config",TYPE_DIV_CLASS:"type-div",MIDI_DIV_CLASS:"midi-div",MIDI_INPUT_SELECT_CLASS:"midi-input-select",MIDI_OUTPUT_SELECT_CLASS:"midi-output-select",REMEMBER_CHECKBOX_ID:"remember-config"};function Z(s,t){if(!s.div)throw new Error("setUpRadioButtons called before render");const e=Array.from(s.div.querySelectorAll('input[type="radio"]'));for(const o of e)for(const[r,i]of t)o.addEventListener("change",()=>{if(!i.div)throw new Error("setUpRadioButtons called before render");i.div.classList[Number(o.value)===r?"remove":"add"]("hidden")})}class tt{constructor(t,e,o){p(this,"name");p(this,"title");p(this,"typeNamesAndEnums");p(this,"inputs");p(this,"div");this.name=t,this.title=e,this.typeNamesAndEnums=o,this.inputs={},this.div=null}render(){const t=this.typeNamesAndEnums.map(([e,o])=>{const r=`${this.name}-${e}`,i=a("input",{id:r,type:"radio",name:this.name,value:o}),c=a("label",{for:r},e);return this.inputs[o]=i,[i,c]}).flat();return this.div=a("div",{class:P.TYPE_DIV_CLASS},this.title,...t)}getConfig(){if(!this.div)throw new Error("getConfig called before render");return Number(this.div.querySelector('input[type="radio"]:checked').value)}}class rt{constructor(){p(this,"inputSelect",null);p(this,"outputSelect",null);p(this,"div",null)}render(){const t=this.inputSelect=a("select",{class:P.MIDI_INPUT_SELECT_CLASS}),e=this.outputSelect=a("select",{class:P.MIDI_OUTPUT_SELECT_CLASS});return this.div=a("div",{},t," \u2192 Here \u2192 ",e)}getConfig(){if(!this.inputSelect||!this.outputSelect)throw new Error("getConfig called before render");return{input:this.inputSelect.value,output:this.outputSelect.value}}}class Nt{constructor(){p(this,"select",null);p(this,"input",null);p(this,"div",null)}render(){const t=this.select=a("select",{class:P.MIDI_OUTPUT_SELECT_CLASS}),e=this.input=a("input",{type:"number",name:"channel",min:1,max:16,value:1});return this.div=a("div",{},t," on channel ",e)}getConfig(){if(!this.select||!this.input)throw new Error("getConfig called before render");return{output:this.select.value,channel:this.input.value}}}class Et{constructor(){p(this,"typeConfig",new tt("transporter-type","Type: ",Ot));p(this,"midiConfig",new rt)}render(){const t=a("legend",{},"TRANSPORTER"),e=this.typeConfig.render(),o=this.midiConfig.render();return a("fieldset",{id:P.TRANSPORTER_CONFIG_ID},t,e,o)}setUp(){Z(this.typeConfig,[[h.Midi,this.midiConfig]])}getConfig(){const t={};return(t.type=this.typeConfig.getConfig())===h.Midi&&(t.midi=this.midiConfig.getConfig()),t}}class St{constructor(t){p(this,"typeConfig");p(this,"midiConfig",new rt);p(this,"div",null);this.typeConfig=new tt(`${t}-controller-type`,"Controller: ",Mt)}render(){const t=this.typeConfig.render(),e=this.midiConfig.render();return this.div=a("div",{},t,e)}setUp(){Z(this.typeConfig,[[d.Midi,this.midiConfig]])}getConfig(){const t={};return(t.type=this.typeConfig.getConfig())===d.Midi&&(t.midi=this.midiConfig.getConfig()),t}}class Dt{constructor(t){p(this,"typeConfig");p(this,"midiConfig",new Nt);this.typeConfig=new tt(`${t}-synthesizer-type`,"Synthesizer: ",kt)}render(){const t=this.typeConfig.render(),e=this.midiConfig.render();return a("div",{},t,e)}setUp(){Z(this.typeConfig,[[m.Midi,this.midiConfig]])}getConfig(){const t={};return(t.type=this.typeConfig.getConfig())===m.Midi&&(t.midi=this.midiConfig.getConfig()),t}}class K{constructor(t){p(this,"name");p(this,"controllerConfig");p(this,"synthesizerConfig");this.name=t,this.controllerConfig=new St(t),this.synthesizerConfig=new Dt(t)}render(){const t=a("legend",{},this.name.toUpperCase()),e=this.controllerConfig.render(),o=a("hr"),r=this.synthesizerConfig.render();return a("fieldset",{},t,e,o,r)}setUp(){this.controllerConfig.setUp(),this.synthesizerConfig.setUp()}getConfig(){return{controller:this.controllerConfig.getConfig(),synthesizer:this.synthesizerConfig.getConfig()}}}class Lt{constructor(){p(this,"div",null)}render(){return this.div=a("div",{class:"problem-div"})}addProblems(t){if(!this.div)throw new Error("addProblems called before render");const e=this.div;e.innerHTML="";for(const o of t){const r=a("p",{},o);e.appendChild(r)}}}class Tt{constructor(){p(this,"refreshButton",null);p(this,"rememberCheckbox",null);p(this,"problemDiv",new Lt)}render(){const t=this.refreshButton=a("button",{type:"button"},"Refresh MIDI Ports"),e=this.rememberCheckbox=a("input",{type:"checkbox",id:P.REMEMBER_CHECKBOX_ID}),o=a("label",{for:P.REMEMBER_CHECKBOX_ID},"Remember"),r=a("button",{type:"submit"},"Submit"),i=this.problemDiv.render();return a("div",{},t,e,o,r,i)}setUp(){}}class _t{constructor(){p(this,"transporterConfig",new Et);p(this,"partConfigs",{bass:new K("bass"),drum:new K("drum"),keys:new K("keys"),lead:new K("lead")});p(this,"miscellaneousDiv",new Tt);p(this,"form",null)}render(){const t=this.transporterConfig.render(),e=Object.values(this.partConfigs).map(r=>r.render()),o=this.miscellaneousDiv.render();return this.form=a("form",{id:P.CONFIG_FORM_ID},t,...e,o)}setUp(){if(!this.form)throw new Error("setUp called before render");this.transporterConfig.setUp();for(const t of Object.values(this.partConfigs))t.setUp();if(!this.miscellaneousDiv.refreshButton)throw new Error("setUp called before render");this.miscellaneousDiv.refreshButton.addEventListener("mousedown",this.refreshMidi.bind(this)),this.refreshMidi(),this.clickAllFirstRadioButtons(),this.form.classList.remove("hidden")}getConfig(){return{transporter:this.transporterConfig.getConfig(),parts:{bass:this.partConfigs.bass.getConfig(),drum:this.partConfigs.drum.getConfig(),keys:this.partConfigs.keys.getConfig(),lead:this.partConfigs.lead.getConfig()}}}refreshMidi(){if(!this.form)throw new Error("refreshMidi called before render");const t=Array.from(this.form.querySelectorAll('input[type="radio"][value="midi"]'));for(const o of t)o.disabled=!I;if(!I)return;function e(o,r){const i=document.getElementsByClassName(o),c=Array.from(I[r].values()).map(l=>l.name);for(const l of i){const C=l.value||c[0];l.innerHTML="";for(const b of c){const T=a("option",{value:b},b);l.appendChild(T)}c.includes(C)&&(l.value=C)}}e(P.MIDI_INPUT_SELECT_CLASS,"inputs"),e(P.MIDI_OUTPUT_SELECT_CLASS,"outputs")}clickAllFirstRadioButtons(){if(!this.form)throw new Error("clickAllFirstRadioButtons called before render");const t=Array.from(this.form.querySelectorAll('input[type="radio"]:enabled:first-of-type'));for(const e of t)e.click()}getPromise(){return new Promise(t=>{if(!this.form)throw new Error("getPromise called before render");this.form.addEventListener("submit",e=>{if(!this.form)throw new Error("submit event listener called after form was removed");e.preventDefault();const o=this.getConfig(),r=Pt(o);this.miscellaneousDiv.problemDiv.addProblems(r),!r.length&&(this.form.remove(),t(o))})})}}async function Rt(){const s=new _t;return document.body.append(s.render()),s.setUp(),await s.getPromise()}const $t=async()=>await Rt();function At(s){const t=a("h2"),e={previous:a("button",{class:"transporter-button"},"\u23EE"),play:a("button",{class:"transporter-button"},"\u25B6"),pause:a("button",{class:"transporter-button"},"\u23F8"),stop:a("button",{class:"transporter-button"},"\u23F9"),next:a("button",{class:"transporter-button"},"\u23ED")};s.connect=(i,c)=>{e.previous.addEventListener("click",()=>i.goPrevious()),e.next.addEventListener("click",()=>i.goNext()),e.play.addEventListener("click",()=>c.play()),e.pause.addEventListener("click",()=>c.pause()),e.stop.addEventListener("click",()=>c.stop())},s.changeChart=(i,c,l)=>{t.innerText=i,e.previous.disabled=!c,e.next.disabled=!l},s.changePlayback=i=>{e.play.disabled=i===f.Playing,e.pause.disabled=i!==f.Playing,e.stop.disabled=i===f.Stopped};const o=a("div",{},...Object.values(e)),r=a("div",{id:"transporter"},t,o);s.render=()=>r}class Ut{constructor(t){switch(t.type){case h.Dom:At(this);break;default:throw new Error(`Invalid Transporter type: ${t}`)}}connect(t,e){}changeChart(t,e,o){}changePlayback(t){}render(){return null}}function V(s){return{position:-1/0,type:g.Tempo,bpm:s}}function Y(...s){return s.map(t=>({position:-1/0,part:t,type:g.Finish}))}const xt={title:"Hello World",compose:({bass:s,drum:t,keys:e,lead:o})=>[V(60),...Y(s,t,e),{position:0,type:g.NoteOn,part:o,pitch:60},{position:4,type:g.NoteOff,part:o,pitch:60},{position:4,type:g.Finish,part:o}]},nt=[0,2,4,5,7,9,11,12];function zt(s){return nt.map(t=>t+24).map((t,e)=>[{position:e,part:s,type:g.NoteOn,pitch:t},{position:e+.9,part:s,type:g.NoteOff,pitch:t}]).flat()}const Ft={title:"Bass Scale",compose:({bass:s,drum:t,keys:e,lead:o})=>[V(120),...Y(t,e,o),...zt(s),{position:nt.length,type:g.Finish,part:s}]},it=[[60,0,1],[60,1,1],[67,2,1],[67,3,1],[69,4,1],[69,5,1],[67,6,2],[65,8,1],[65,9,1],[64,10,1],[64,11,1],[62,12,1],[62,13,1],[60,14,2]];function Bt(s){const t=s.controller.getRangeControl("8va chance: ",0,100,"%");function e([C,b,T]){const et=Math.random()*100;return{position:b-.1,type:g.Compute,callback:J=>{const re=t.value,ft=et<re?C+12:C,ne={position:b,type:g.NoteOn,part:s,pitch:ft},ie={position:b+T-.1,type:g.NoteOff,part:s,pitch:ft};J.unshift(ne,ie)}}}const o=it.map(e),[r,i,c]=it.at(-1)??[0,0,0],l={position:c+i+.1,type:g.Finish,part:s};return[...o,l]}const jt={title:"Twinkle Twinkle Little Star",compose:({bass:s,drum:t,keys:e,lead:o})=>[V(120),...Y(s,t,e),...Bt(o)]},at=[40,43,45,43,50,48,50,52],ct=2,lt=ct/at.length,Ht={title:"On the Run",compose:({bass:s,drum:t,keys:e,lead:o})=>{const r=o.controller.getOptionControl("Repeat again: ",["No","Yes"],"!");function i(l){const C=at.map((T,et)=>{const J=l+et*lt;return[{position:J,type:g.NoteOn,part:o,pitch:T},{position:J+lt-.05,type:g.NoteOff,part:o,pitch:T}]}).flat(),b=c(l+ct);return[...C,b]}function c(l){return{position:l-.1,type:g.Compute,callback:C=>{r.value?C.push(...i(l)):C.push({position:l,type:g.Finish,part:o})}}}return[V(165),...Y(s,t,e),c(0)]}},ut=[xt,Ft,jt,Ht],pt=ut.length;class qt{constructor(){y(this,O,0);y(this,_,()=>{})}goPrevious(){n(this,O)>0&&(u(this,O,n(this,O)-1),n(this,_).call(this))}goNext(){n(this,O)<pt-1&&(u(this,O,n(this,O)+1),n(this,_).call(this))}connect(t,e){u(this,_,()=>{const o=ut[n(this,O)],r=o.title,i=n(this,O)>0,c=n(this,O)<pt-1;t.changeChart(r,i,c),e.changeChart(o)})}start(){n(this,_).call(this)}}O=new WeakMap,_=new WeakMap;const ht=12,z={min:0,max:127,step:1,default:63};class Gt{constructor(){y(this,E);y(this,R);y(this,$,()=>{});y(this,A,()=>0);const t=a("span",{},"EMPTY");u(this,E,{0:a("span",{},"%%"),1:t,2:a("span",{},"%%")}),u(this,R,a("input",{type:"range",min:z.min,max:z.max,step:z.step,value:z.default})).addEventListener("input",()=>{n(this,$).call(this)})}clear(){u(this,A,()=>0),u(this,$,()=>{});const t=Object.values(n(this,E));for(const e of t)e.textContent=""}get value(){return n(this,A).call(this)}makeIntoRangeControl(t,e,o,r=""){const i=n(this,E),c=i[1],l=n(this,R);i[0].textContent=t,i[2].textContent=r;const C=u(this,A,()=>e+Math.round((o-e)*Number(l.value)/z.max));u(this,$,()=>{c.textContent=C().toString()})()}makeIntoOptionControl(t,e,o=""){const r=n(this,E),i=r[1],c=n(this,R);r[0].textContent=t,r[2].textContent=o;const l=u(this,A,()=>Math.round((e.length-1)*Number(c.value)/z.max));u(this,$,()=>{i.textContent=e[l()]})()}render(){const t=a("label",{class:"lcd"},...Object.values(n(this,E)));return a("div",{class:"controller-module"},t,n(this,R))}}E=new WeakMap,R=new WeakMap,$=new WeakMap,A=new WeakMap;function Kt(s){const t=Array.from({length:ht},()=>new Gt);let e=0;s.clear=()=>{t.forEach(r=>r.clear()),e=0};function o(){if(e>=ht)throw new Error("No more controllers available");const r=t[e];return e+=1,r}s.getRangeControl=(r,i,c,l="")=>{const C=o();return C.makeIntoRangeControl(r,i,c,l),C},s.getOptionControl=(r,i,c="")=>{const l=o();return l.makeIntoOptionControl(r,i,c),l},s.render=()=>{const r=a("h2",{class:"component-title"},"Controller"),i=t.map(l=>l.render()),c=a("div",{class:"controller-row"},...i);return r.addEventListener("click",()=>{c.classList.toggle("hidden")}),a("div",{class:"controller"},r,c)}}class Vt{constructor(t,e){switch(e.type){case d.Dom:Kt(this);break;default:throw new Error(`Invalid Controller type: ${e}`)}}clear(){}getRangeControl(t,e,o,r=""){return{value:0}}getOptionControl(t,e,o=""){return{value:0}}render(){return null}}function Yt(s){s.noteOn=(t,e)=>{console.log("noteOn",t,e)},s.noteOff=(t,e)=>{console.log("noteOff",t,e)},s.allNotesOff=()=>{console.log("allNotesOff")}}function Xt(s){const t=a("h2",{class:"component-title"},"Synthesizer"),e=a("button",{},"Clear"),o=a("div",{class:"message-row"}),r=a("div",{class:"synthesizer-row"},e,o),i=a("div",{class:"synthesizer"},t,r);function c(l,C){const b=a("div",{class:C},l);o.appendChild(b),o.scrollTop=o.scrollHeight}s.noteOn=(l,C,b=!0)=>{b&&s.currentlyPlayingPitches.push(l),c(`noteOn ${l} ${C.toFixed(0)}`,"note-on")},s.noteOff=(l,C,b=!0)=>{c(`noteOff ${l} ${C.toFixed(0)}`,"note-off"),b&&(s.currentlyPlayingPitches=s.currentlyPlayingPitches.filter(T=>T!==l))},s.allNotesOff=()=>{c("allNotesOff","all-notes-off"),s.currentlyPlayingPitches=[]},e.addEventListener("click",()=>{o.innerHTML=""}),t.addEventListener("click",()=>{r.classList.toggle("hidden")}),s.render=()=>i}function Wt(s,t){if(!I)throw new Error("No MIDI access");const e=I.outputs.values().find(r=>r.name===t.midi.output);if(!e)throw new Error(`No MIDI output named ${t.midi.output}`);const o=t.midi.channel-1;s.noteOn=(r,i,c=!0)=>{c&&s.currentlyPlayingPitches.push(r),e.send([144+o,r,127],i)},s.noteOff=(r,i,c=!0)=>{e.send([128+o,r,0],i),c&&(s.currentlyPlayingPitches=s.currentlyPlayingPitches.filter(l=>l!==r))},s.allNotesOff=()=>{e.send([176+o,123,0]),s.currentlyPlayingPitches=[]}}class Jt{constructor(t,e){p(this,"currentlyPlayingPitches",[]);switch(e.type){case m.Log:Yt(this);break;case m.Dom:Xt(this);break;case m.Midi:Wt(this,e);break}}noteOn(t,e,o=!0){}noteOff(t,e,o=!0){}allNotesOff(){}pause(){const t=window.performance.now();for(const e of this.currentlyPlayingPitches)this.noteOff(e,t,!1)}resume(){const t=window.performance.now();for(const e of this.currentlyPlayingPitches)this.noteOn(e,t,!1)}render(){return null}}class X{constructor(t,e){y(this,B);p(this,"controller");p(this,"synthesizer");u(this,B,t),this.controller=new Vt(t,e.controller),this.synthesizer=new Jt(t,e.synthesizer)}render(){const t=a("h2",{},n(this,B).toUpperCase()),e=this.controller.render(),o=this.synthesizer.render();return e||o?a("div",{class:"part"},t,e,o):null}}B=new WeakMap;function Qt(s){return{bass:new X("bass",s.bass),drum:new X("drum",s.drum),keys:new X("keys",s.keys),lead:new X("lead",s.lead)}}const W=100;function Zt(){return new Worker(new URL(""+new URL("worker-Dukc8-Vk.js",import.meta.url).href,import.meta.url),{type:"module"})}class te{constructor(t,e){y(this,G);y(this,j);y(this,S,Zt());y(this,M);y(this,D,!1);y(this,L,[]);y(this,H,()=>{});y(this,U,0);y(this,x,0);y(this,q,6e4/120);y(this,F,new Set);u(this,j,t),u(this,M,Qt(e)),n(this,S).onmessage=o=>this.schedule()}schedule(){const t=window.performance.now()+W;for(;n(this,D)&&n(this,G,st)<t;){const e=n(this,G,st),o=n(this,L).shift();if(o)switch(o.type){case g.Tempo:u(this,q,6e4/o.bpm);break;case g.Finish:n(this,F).add(o.part),n(this,F).size===4&&n(this,j).stop();break;case g.NoteOn:o.part.synthesizer.noteOn(o.pitch,e);break;case g.NoteOff:o.part.synthesizer.noteOff(o.pitch,e);break;case g.Compute:o.callback(n(this,L));break}}}changeChart(t){u(this,H,()=>{for(const e of Object.values(n(this,M)))e.controller.clear();u(this,L,t.compose(n(this,M)))})()}play(){u(this,D,!0),u(this,U,window.performance.now()+W),u(this,x,0),n(this,S).postMessage(0)}pause(){u(this,D,!1),n(this,S).postMessage(1),u(this,x,window.performance.now()-n(this,U)),setTimeout(()=>{for(const t of Object.values(n(this,M)))t.synthesizer.pause()},W*2)}resume(){u(this,D,!0),u(this,U,window.performance.now()-n(this,x)),n(this,S).postMessage(0);for(const t of Object.values(n(this,M)))t.synthesizer.resume()}stop(){u(this,D,!1),n(this,S).postMessage(1),u(this,x,0),n(this,F).clear(),n(this,H).call(this),setTimeout(()=>{for(const t of Object.values(n(this,M)))t.synthesizer.allNotesOff()},W*2)}render(){const t=Object.values(n(this,M)).map(e=>e.render());return t.some(e=>e!==null)?a("div",{id:"part-container"},...t):null}}j=new WeakMap,S=new WeakMap,M=new WeakMap,D=new WeakMap,L=new WeakMap,H=new WeakMap,U=new WeakMap,x=new WeakMap,q=new WeakMap,F=new WeakMap,G=new WeakSet,st=function(){return n(this,L).length===0?1/0:n(this,L)[0].position*n(this,q)+n(this,U)};class ee{constructor(t){y(this,v,f.Paused);y(this,N,()=>{});y(this,k);console.debug("Playbacker",t),u(this,k,new te(this,t))}changeChart(t){console.debug("changeChart",t),n(this,k).changeChart(t),n(this,v)!=f.Stopped&&this.stop()}play(){switch(n(this,v)){case f.Playing:console.debug("already playing");break;case f.Paused:console.debug("resume"),n(this,N).call(this,w.Resume),u(this,v,f.Playing);break;case f.Stopped:console.debug("play"),n(this,N).call(this,w.Play),u(this,v,f.Playing);break}}pause(){switch(n(this,v)){case f.Playing:console.debug("pause"),n(this,N).call(this,w.Pause),u(this,v,f.Paused);break;case f.Paused:console.debug("already paused");break;case f.Stopped:console.debug("already stopped");break}}stop(){switch(n(this,v)){case f.Playing:console.debug("stop"),n(this,N).call(this,w.Stop),u(this,v,f.Stopped);break;case f.Paused:console.debug("stop"),n(this,N).call(this,w.Stop),u(this,v,f.Stopped);break;case f.Stopped:console.debug("already stopped");break}}connect(t){u(this,N,e=>{switch(e){case w.Play:n(this,k).play(),t.changePlayback(f.Playing);break;case w.Pause:n(this,k).pause(),t.changePlayback(f.Paused);break;case w.Resume:n(this,k).resume(),t.changePlayback(f.Playing);break;case w.Stop:n(this,k).stop(),t.changePlayback(f.Stopped);break}})}render(){return n(this,k).render()}}v=new WeakMap,N=new WeakMap,k=new WeakMap;function dt(s){s&&document.body.append(s)}function se(s){const t=new Ut(s.transporter),e=new qt,o=new ee(s.parts);t.connect(e,o),e.connect(t,o),o.connect(t);const r=t.render(),i=o.render();dt(r),dt(i),e.start()}const oe=await $t();se(oe)})();
</script>
  <style rel="stylesheet" crossorigin>:root{--red: #b23535;--green: #38ad5f;--blue: #464ca5;--white: #eeeade;--black: #282828;--text-color: var(--black);--background-color: var(--white)}@media (prefers-color-scheme: dark){:root{--text-color: var(--white);--background-color: var(--black)}}*{color:inherit;background-color:inherit;border-color:inherit;font-family:inherit;box-sizing:inherit}body{min-height:100vh;font-family:Arial,sans-serif;color:var(--text-color);background-color:var(--background-color);border-color:var(--text-color);box-sizing:border-box;padding:0;margin:0}#config-form{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}fieldset{margin-bottom:20px}legend{font-weight:700;margin-bottom:10px}.type-div{margin-bottom:10px}label{-webkit-user-select:none;user-select:none}input[type=radio]:disabled+label{text-decoration:line-through}button{color:var(--text-color);background-color:var(--background-color);border:1px solid var(--text-color);cursor:pointer;transition:background-color .3s ease}button:hover{background-color:var(--text-color);color:var(--background-color)}.transporter-button{width:2em;height:2em;border:1.5px solid;border-radius:50%;font-size:2.5rem;padding:1rem;margin:0 .5rem 2rem;cursor:pointer;color:var(--background-color);background-color:var(--text-color);transition:transform .2s}.transporter-button:hover:enabled{transform:scale(1.1)}.transporter-button:disabled{color:var(--text-color);background-color:var(--background-color);cursor:auto}#transporter{text-align:center;border-bottom:1px solid var(--text-color)}.lcd{padding:.5em 1em;border-radius:5px;width:16ch;min-height:4em;line-height:1.5;text-align:left;font-family:hd44780,monospace;color:var(--background-color);background-color:var(--text-color)}input[type=range]{margin-top:1em;width:100%}.controller-module{padding:1em;display:flex;flex-direction:column;align-items:center;border:1px solid;font-size:1vw}.component-title{margin-top:0;margin-bottom:0;width:100%;height:3rem;line-height:3rem;cursor:pointer;-webkit-user-select:none;user-select:none}.controller-row{border-top:1px solid;justify-content:center;align-items:center;overflow-y:scroll;height:40vw}.controller{padding-top:0;border:1px solid}.note-on{color:var(--green)}.note-off{color:var(--red)}.all-notes-off{color:var(--blue)}.message-row{width:100%;height:10vw;overflow-y:scroll}.synthesizer-row{width:100%}.synthesizer{display:flex;flex-direction:column;align-items:center;width:100%;border:1px solid}.part{text-align:center;border:1px solid;min-width:20%}#part-container{display:flex;flex-wrap:wrap;justify-content:space-around;align-items:start}.hidden{display:none}
</style>
</head>

<body>
</body>

</html>