<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sequencer</title>
  <script type="module" crossorigin>var Re=Object.defineProperty;var vt=h=>{throw TypeError(h)};var Te=(h,g,f)=>g in h?Re(h,g,{enumerable:!0,configurable:!0,writable:!0,value:f}):h[g]=f;var d=(h,g,f)=>Te(h,typeof g!="symbol"?g+"":g,f),bt=(h,g,f)=>g.has(h)||vt("Cannot "+f);var a=(h,g,f)=>(bt(h,g,"read from private field"),f?f.call(h):g.get(h)),C=(h,g,f)=>g.has(h)?vt("Cannot add the same private member more than once"):g instanceof WeakSet?g.add(h):g.set(h,f),u=(h,g,f,p)=>(bt(h,g,"write to private field"),p?p.call(h,f):g.set(h,f),f);(async()=>{var x,j,M,$,R,T,K,W,q,I,S,G,X,B,_,J,it,D,A,N;(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function e(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(n){if(n.ep)return;n.ep=!0;const i=e(n);fetch(n.href,i)}})();var h=(t=>(t[t.Dom=0]="Dom",t[t.Midi=1]="Midi",t))(h||{}),g=(t=>(t[t.Dom=0]="Dom",t[t.Midi=1]="Midi",t))(g||{}),f=(t=>(t[t.Log=0]="Log",t[t.Dom=1]="Dom",t[t.Midi=2]="Midi",t))(f||{}),p=(t=>(t[t.Playing=0]="Playing",t[t.Paused=1]="Paused",t[t.Stopped=2]="Stopped",t))(p||{}),P=(t=>(t[t.Play=0]="Play",t[t.Pause=1]="Pause",t[t.Resume=2]="Resume",t[t.Stop=3]="Stop",t))(P||{}),v=(t=>(t[t.Compute=0]="Compute",t[t.NoteOn=1]="NoteOn",t[t.NoteOff=2]="NoteOff",t))(v||{});function l(t,e={},...o){const n=document.createElement(t);for(const[i,r]of Object.entries(e))n.setAttribute(i,r);for(const i of o)typeof i=="string"?n.appendChild(document.createTextNode(i)):i&&n.appendChild(i);return n}const k=await navigator.requestMIDIAccess({sysex:!0}).catch(()=>null);function wt(t,e,o){const n=[];if(!k)return n.push(`The ${t} cannot be type MIDI without MIDI access`),n;const i=k[o].values(),r=Array.from(i);return r?(r.find(({name:s})=>s===e)||n.push(`No MIDI ${o} named ${e} for ${t}`),n):(n.push(`No MIDI ${o}`),n)}function Et(t,e){const o=[],{output:n,channel:i}=e;return n?o.push(...wt(t,n,"outputs")):o.push(`No MIDI output for ${t}`),i?(i<1||i>16)&&o.push(`Invalid MIDI channel for ${t}: ${i}`):o.push(`No MIDI channel for ${t}`),o}function Dt(t){const e=[];return t.type===void 0?(e.push("No transporter type"),e):(t.type in h||e.push(`Invalid transporter type: ${t.type}`),e)}function Ot(t,e){const o=[];return e.type===void 0?(o.push(`No controller type for ${t} part`),o):(e.type in g||o.push(`Invalid controller type for ${t} part: ${e.type}`),o)}function Pt(t,e){const o=[];if(e.type===void 0)return o.push(`No synthesizer type for ${t} part`),o;if(e.type in f||o.push(`Invalid synthesizer type for ${t} part: ${e.type}`),e.type===f.Midi){if(!k)return o.push("No MIDI access"),o;const{midi:n}=e;if(!n)return o.push("No MIDI config"),o;o.push(...Et(`${t} synthesizer`,n))}return o}function xt(t,e){const o=[],{controller:n,synthesizer:i}=e;return n?o.push(...Ot(t,n)):o.push(`No controller for ${t} part`),i?o.push(...Pt(t,i)):o.push(`No synthesizer for ${t} part`),o}function It(t){const e=[],o=["bass","drum","keys","lead"];for(const n of o){const i=t[n];if(!i){e.push(`No ${n} part`);continue}e.push(...xt(n,i))}return e}function Nt(t){const e=[],{transporter:o,parts:n}=t;return o?e.push(...Dt(o)):e.push("No transporter"),n?e.push(...It(n)):e.push("No parts"),e}const At=[["DOM",h.Dom]],kt=[["DOM",g.Dom]],Mt=[["DOM",f.Dom],["MIDI",f.Midi]],z={CONFIG_FORM_ID:"config-form",TRANSPORTER_CONFIG_ID:"transporter-config",PART_CONFIG_CLASS:"part-config",TYPE_DIV_CLASS:"type-div",MIDI_DIV_CLASS:"midi-div",MIDI_OUTPUT_SELECT_CLASS:"midi-output-select",REMEMBER_CHECKBOX_ID:"remember-config"};function qt(t,e){if(!t.div)throw new Error("setUpRadioButtons called before render");const o=Array.from(t.div.querySelectorAll('input[type="radio"]'));for(const n of o)for(const[i,r]of e)n.addEventListener("change",()=>{if(!r.div)throw new Error("setUpRadioButtons called before render");r.div.classList[Number(n.value)===i?"remove":"add"]("hidden")})}class ot{constructor(e,o,n){d(this,"name");d(this,"title");d(this,"typeNamesAndEnums");d(this,"inputs");d(this,"div");this.name=e,this.title=o,this.typeNamesAndEnums=n,this.inputs={},this.div=null}render(){const e=this.typeNamesAndEnums.map(([o,n])=>{const i=`${this.name}-${o}`,r=l("input",{id:i,type:"radio",name:this.name,value:n}),s=l("label",{for:i},o);return this.inputs[n]=r,[r,s]}).flat();return this.div=l("div",{class:z.TYPE_DIV_CLASS},this.title,...e)}getConfig(){if(!this.div)throw new Error("getConfig called before render");return Number(this.div.querySelector('input[type="radio"]:checked').value)}}class St{constructor(){d(this,"select",null);d(this,"input",null);d(this,"div",null)}render(){const e=this.select=l("select",{class:z.MIDI_OUTPUT_SELECT_CLASS}),o=this.input=l("input",{type:"number",name:"channel",min:1,max:16,value:1});return this.div=l("div",{},e," on channel ",o)}getConfig(){if(!this.select||!this.input)throw new Error("getConfig called before render");return{output:this.select.value,channel:this.input.value}}}class Gt{constructor(){d(this,"typeConfig",new ot("transporter-type","Type: ",At))}render(){const e=l("legend",{},"TRANSPORTER"),o=this.typeConfig.render();return l("fieldset",{id:z.TRANSPORTER_CONFIG_ID},e,o)}setUp(){}getConfig(){const e={};return e.type=this.typeConfig.getConfig(),e}}class Ft{constructor(e){d(this,"typeConfig");d(this,"div",null);this.typeConfig=new ot(`${e}-controller-type`,"Controller: ",kt)}render(){const e=this.typeConfig.render();return this.div=l("div",{},e)}setUp(){}getConfig(){const e={};return e.type=this.typeConfig.getConfig(),e}}class Lt{constructor(e){d(this,"typeConfig");d(this,"midiConfig",new St);this.typeConfig=new ot(`${e}-synthesizer-type`,"Synthesizer: ",Mt)}render(){const e=this.typeConfig.render(),o=this.midiConfig.render();return l("div",{},e,o)}setUp(){qt(this.typeConfig,[[f.Midi,this.midiConfig]])}getConfig(){const e={};return(e.type=this.typeConfig.getConfig())===f.Midi&&(e.midi=this.midiConfig.getConfig()),e}}class Z{constructor(e){d(this,"name");d(this,"controllerConfig");d(this,"synthesizerConfig");this.name=e,this.controllerConfig=new Ft(e),this.synthesizerConfig=new Lt(e)}render(){const e=l("legend",{},this.name.toUpperCase()),o=this.controllerConfig.render(),n=l("hr"),i=this.synthesizerConfig.render();return l("fieldset",{},e,o,n,i)}setUp(){this.controllerConfig.setUp(),this.synthesizerConfig.setUp()}getConfig(){return{controller:this.controllerConfig.getConfig(),synthesizer:this.synthesizerConfig.getConfig()}}}class jt{constructor(){d(this,"div",null)}render(){return this.div=l("div",{class:"problem-div"})}addProblems(e){if(!this.div)throw new Error("addProblems called before render");const o=this.div;o.innerHTML="";for(const n of e){const i=l("p",{},n);o.appendChild(i)}}}class $t{constructor(){d(this,"refreshButton",null);d(this,"problemDiv",new jt)}render(){const e=this.refreshButton=l("button",{type:"button"},"Refresh MIDI Ports"),o=l("label",{for:z.REMEMBER_CHECKBOX_ID},"Remember"),n=l("button",{type:"submit"},"Submit"),i=this.problemDiv.render();return l("div",{},e,o,n,i)}setUp(){}}class Rt{constructor(){d(this,"transporterConfig",new Gt);d(this,"partConfigs",{bass:new Z("bass"),drum:new Z("drum"),keys:new Z("keys"),lead:new Z("lead")});d(this,"miscellaneousDiv",new $t);d(this,"form",null)}render(){const e=this.transporterConfig.render(),o=Object.values(this.partConfigs).map(i=>i.render()),n=this.miscellaneousDiv.render();return this.form=l("form",{id:z.CONFIG_FORM_ID},e,...o,n)}setUp(){if(!this.form)throw new Error("setUp called before render");this.transporterConfig.setUp();for(const e of Object.values(this.partConfigs))e.setUp();if(!this.miscellaneousDiv.refreshButton)throw new Error("setUp called before render");this.miscellaneousDiv.refreshButton.addEventListener("mousedown",this.refreshMidi.bind(this)),this.refreshMidi(),this.clickAllFirstRadioButtons(),this.form.classList.remove("hidden")}getConfig(){return{transporter:this.transporterConfig.getConfig(),parts:{bass:this.partConfigs.bass.getConfig(),drum:this.partConfigs.drum.getConfig(),keys:this.partConfigs.keys.getConfig(),lead:this.partConfigs.lead.getConfig()}}}refreshMidi(){if(!this.form)throw new Error("refreshMidi called before render");const e=Array.from(this.form.querySelectorAll('input[type="radio"][value="midi"]'));for(const n of e)n.disabled=!k;if(!k)return;function o(n,i){const r=document.getElementsByClassName(n),s=Array.from(k[i].values()).map(c=>c.name);for(const c of r){const m=c.value||s[0];c.innerHTML="";for(const y of s){const E=l("option",{value:y},y);c.appendChild(E)}s.includes(m)&&(c.value=m)}}o(z.MIDI_OUTPUT_SELECT_CLASS,"outputs")}clickAllFirstRadioButtons(){if(!this.form)throw new Error("clickAllFirstRadioButtons called before render");const e=Array.from(this.form.querySelectorAll('input[type="radio"]:enabled:first-of-type'));for(const o of e)o.click()}getPromise(){return new Promise(e=>{if(!this.form)throw new Error("getPromise called before render");this.form.addEventListener("submit",o=>{if(!this.form)throw new Error("submit event listener called after form was removed");o.preventDefault();const n=this.getConfig(),i=Nt(n);this.miscellaneousDiv.problemDiv.addProblems(i),!i.length&&(this.form.remove(),e(n))})})}}async function Tt(){const t=new Rt;return document.body.append(t.render()),t.setUp(),await t.getPromise()}const Bt=async()=>await Tt();function _t(t){const e=l("h2"),o={previous:l("button",{class:"transporter-button"},"\u23EE"),play:l("button",{class:"transporter-button"},"\u25B6"),pause:l("button",{class:"transporter-button"},"\u23F8"),stop:l("button",{class:"transporter-button"},"\u23F9"),next:l("button",{class:"transporter-button"},"\u23ED")};t.connect=(r,s)=>{o.previous.addEventListener("click",()=>r.goPrevious()),o.next.addEventListener("click",()=>r.goNext()),o.play.addEventListener("click",()=>s.play()),o.pause.addEventListener("click",()=>s.pause()),o.stop.addEventListener("click",()=>s.stop())},t.changeChart=(r,s,c)=>{e.innerText=r,o.previous.disabled=!s,o.next.disabled=!c},t.changePlayback=r=>{o.play.disabled=r===p.Playing,o.pause.disabled=r!==p.Playing,o.stop.disabled=r===p.Stopped};const n=l("div",{},...Object.values(o)),i=l("div",{id:"transporter"},e,n);t.render=()=>i}class zt{constructor(e){switch(e.type){case h.Dom:_t(this);break;default:throw new Error(`Invalid Transporter type: ${e}`)}}connect(e,o){}changeChart(e,o,n){}changePlayback(e){}render(){return null}}function Ut(t,...e){return[...t,...e].sort((o,n)=>o.time-n.time)}function Y(t){return 6e4/t}function O(t){return Math.max(t-.1,t*.9)}const Ht=/[CDEFGAB]/,Vt=/♮|b{1,2}|#{1,2}/,Yt=/-?[0-8]/,Kt=/[CDEFGAB](♮|b{1,2}|#{1,2})?/;function U(t){var y,E,F,V;const e=(y=t.match(Kt))==null?void 0:y[0];if(e===void 0)throw new Error(`Invalid pitch class: ${t}`);const o=(E=e.match(Ht))==null?void 0:E[0];if(o===void 0)throw new Error(`Invalid pitch letter: ${e}`);const n={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[o];if(n===void 0)throw new Error(`Invalid pitch letter: ${e}`);const i=((F=e.match(Vt))==null?void 0:F[0])||"\u266E",r={"\u266E":0,b:-1,bb:-2,"#":1,"##":2}[i];if(r===void 0)throw new Error(`Invalid accidental: ${e}`);const s=Number((V=t.match(Yt))==null?void 0:V[0]);if(isNaN(s))throw new Error(`Invalid octave: ${e}`);const c=(s+1)*12,m=n+r+c;if(m<0||m>127)throw new Error(`Out of MIDI range: ${e}`);return m}var L=(t=>(t[t.pp=21]="pp",t[t.p=41]="p",t[t.mp=61]="mp",t[t.mf=81]="mf",t[t.f=101]="f",t[t.ff=121]="ff",t[t.fff=127]="fff",t))(L||{});const nt=100,Wt=5;function b(t,e,o,n){if(t===-1/0||t===1/0)return t;const i=t%n,r=n*Math.floor(t/n),s=i<n/2?(o+1)*i:(1-o)*i+o*n;return(r+s)*e}const rt=60,Xt=L.mf,Jt=4e3,Qt={title:"Hello World",compose:({lead:t})=>[{time:0,type:v.NoteOn,part:t,pitch:rt,velocity:Xt},{time:Jt,type:v.NoteOff,part:t,pitch:rt}]},Zt=120,st=["C2","D2","E2","F2","G2","A2","B2","C3"],te=L.mf,ee=2,at=Y(Zt),oe=st.map((t,e)=>{const o=U(t),n=e*at,i=e===st.length-1?ee:1,r=(e+O(i))*at;return[o,n,r]}),ne={title:"Bass Scale",compose:({bass:t})=>oe.map(([e,o,n])=>[{time:o,type:v.NoteOn,part:t,pitch:e,velocity:te},{time:n,type:v.NoteOff,part:t,pitch:e}]).flat()},ie=60,re=240,lt=32,se=L.f,ae={title:"Metronome",compose:({drum:t})=>{const e=t.controller.getRangeControl("Tempo: ",ie,re," BPM"),o=n=>[{time:n-nt,type:v.Compute,callback:i=>{const r=e.value,s=n+Y(r);i.push(...o(s))}},{time:n,type:v.NoteOn,part:t,pitch:lt,velocity:se},{time:n+Wt,type:v.NoteOff,part:t,pitch:lt}];return o(0)}},le=120,ce=[["C4",0,.9],["C4",1,.9],["G4",2,.9],["G4",3,.9],["A4",4,.9],["A4",5,.9],["G4",6,1.9],["F4",8,.9],["F4",9,.9],["E4",10,.9],["E4",11,.9],["D4",12,.9],["D4",13,.9],["C4",14,1.9],["G4",16,.9],["G4",17,.9],["F4",18,.9],["F4",19,.9],["E4",20,.9],["E4",21,.9],["D4",22,1.9],["G4",24,.9],["G4",25,.9],["F4",26,.9],["F4",27,.9],["E4",28,.9],["E4",29,.9],["D4",30,1.9],["C4",32,.9],["C4",33,.9],["G4",34,.9],["G4",35,.9],["A4",36,.9],["A4",37,.9],["G4",38,1.9],["F4",40,.9],["F4",41,.9],["E4",42,.9],["E4",43,.9],["D4",44,.9],["D4",45,.9],["C4",46,2]],ue=L.mf,ct=Y(le),pe=ce.map(([t,e,o])=>{const n=U(t),i=e*ct,r=(e+O(o))*ct;return[n,i,r]}),de={title:"Twinkle Twinkle Little Star",compose:({lead:t})=>{const e=t.controller.getRangeControl("8va chance: ",0,100,"%");return pe.map(([o,n,i])=>({time:n-nt,type:v.Compute,callback:r=>{const s=e.value>Math.random()*100?o+12:o,c={time:n,type:v.NoteOn,part:t,pitch:s,velocity:ue},m={time:i,type:v.NoteOff,part:t,pitch:s};r.unshift(c,m)}}))}},he=165,fe=["E3","G3","A3","G3","D4","C4","D4","E4"],me=2,ye=L.mf,ge=Y(he),ut=fe.map(U),pt=me*ge,dt=pt/ut.length,Ce={title:"On the Run",compose:({lead:t})=>{const e=t.controller.getOptionControl("Repeat again: ",["No","Yes"],"!");function o(n){return{time:n-nt,type:v.Compute,callback:i=>{if(e.value){const r=ut.map((s,c)=>{const m=n+c*dt;return[{time:m,type:v.NoteOn,part:t,pitch:s,velocity:ye},{time:m+O(dt),type:v.NoteOff,part:t,pitch:s}]}).flat();i.unshift(...r,o(n+pt))}}}}return[o(0)]}},ve=118,ht=(()=>{const t={"1-16":{length:64,melody:[["C5",0,1],["B4",1,1],["A4",2,.5],["G4",2.5,1.5],["F4",4,1.5],["G4",5.5,.5],["A4",6,1],["C5",7,1],["B4",8,1],["A4",9,1],["G4",10,.5],["F4",10.5,1.5],["E4",12,4],["A4",16,1],["G4",17,1],["F4",18,.5],["E4",18.5,1.5],["D4",20,1.5],["E4",21.5,.5],["F4",22,1],["A4",23,1],["G#4",24,1],["F4",25,1],["E4",26,.5],["D4",26.5,1.5],["C4",28,3],["C#4",31,1],["D4",32,.5],["A4",32.5,1],["A4",33.5,3.5],["C5",37,2],["B4",39,1],["G4",40,7],["B3",47,1],["C4",48,.5],["F4",48.5,1],["F4",49.5,3.5],["A4",53,2],["G4",55,1],["F4",56,2],["E4",58,7]],chords:[{root:"A",quality:"minor",extension:"7",position:0,duration:4},{root:"D",quality:"minor",extension:"7",position:4,duration:4},{root:"G",quality:"major",extension:"7",position:8,duration:4},{root:"C",quality:"major",extension:"maj7",position:12,duration:2},{root:"C",quality:"major",extension:"7",position:14,duration:2},{root:"F",quality:"major",extension:"7",position:16,duration:4},{root:"B",quality:"minor",extension:"7(b5)",position:20,duration:4},{root:"E",quality:"minor",extension:"7",position:24,duration:4},{root:"A",quality:"minor",extension:"7",position:28,duration:2},{root:"A",quality:"major",extension:"7",position:30,duration:2},{root:"D",quality:"minor",extension:"7",position:32,duration:4},{root:"G",quality:"major",extension:"7",position:36,duration:4},{root:"C",quality:"major",extension:"maj7",position:40,duration:4},{root:"E",quality:"minor",extension:"7",position:44,duration:2},{root:"A",quality:"minor",extension:"7",position:46,duration:2},{root:"D",quality:"minor",extension:"7",position:48,duration:4},{root:"G",quality:"major",extension:"7",position:52,duration:4},{root:"F",quality:"major",extension:"6",position:56,duration:2},{root:"C",quality:"major",extension:"maj7",position:58,duration:2},{root:"B",quality:"minor",extension:"7(b5)",position:60,duration:2},{root:"E",quality:"minor",extension:"7",position:62,duration:2}]},"17-26":{length:40,melody:[["C5",0,1],["B4",1,1],["A4",2,.5],["G4",2.5,1.5],["F4",4,1.5],["G4",5.5,.5],["A4",6,1],["C5",7,1],["B4",8,1],["A4",9,1],["G4",10,.5],["F4",10.5,1.5],["E4",12,4],["A4",16,1],["G4",17,1],["F4",18,.5],["E4",18.5,1.5],["D4",20,1],["E4",21,1],["F4",22,1],["A4",23,1],["G#4",24,1],["F4",25,1],["E4",26,.5],["D4",26.5,1.5],["C4",28,3],["C#4",31,1],["D4",32,.5],["A4",32.5,1],["A4",33.5,3.5],["C5",37,2],["B4",39,1]],chords:[{root:"A",quality:"minor",extension:"7",position:0,duration:4},{root:"D",quality:"minor",extension:"7",position:4,duration:4},{root:"G",quality:"major",extension:"7",position:8,duration:4},{root:"C",quality:"major",extension:"maj7",position:12,duration:2},{root:"C",quality:"major",extension:"7",position:14,duration:2},{root:"F",quality:"major",extension:"maj7",position:16,duration:4},{root:"B",quality:"minor",extension:"7(b5)",position:20,duration:4},{root:"E",quality:"minor",extension:"7",position:24,duration:4},{root:"A",quality:"minor",extension:"7",position:28,duration:2},{root:"A",quality:"major",extension:"7",position:30,duration:2},{root:"D",quality:"minor",extension:"7",position:32,duration:4},{root:"G",quality:"major",extension:"7",position:36,duration:4}]},"27-32":{length:24,melody:[["G4",0,7],["G#4",7,1],["A4",8,.5],["C4",8.5,1],["C4",9.5,3.5],["C4",13,2],["D4",15,1],["C4",16,4]],chords:[{root:"E",quality:"minor",extension:"7",position:0,duration:4},{root:"A",quality:"minor",extension:"7",position:4,duration:4},{root:"D",quality:"minor",extension:"7",position:8,duration:4},{root:"G",quality:"major",extension:"7",position:12,duration:4},{root:"C",quality:"major",extension:"6",position:16,duration:4},{root:"B",quality:"minor",extension:"7(b5)",position:20,duration:2},{root:"E",quality:"minor",extension:"7",position:22,duration:2}]},"33-38":{length:24,melody:[["E5",0,7],["C5",7,1],["D5",8,.5],["A4",8.5,1],["A4",9.5,3.5],["B4",13,2],["D5",15,1],["C5",16,7]],chords:[{root:"E",quality:"minor",extension:"7",position:0,duration:4},{root:"A",quality:"minor",extension:"7",position:4,duration:4},{root:"D",quality:"minor",extension:"7",position:8,duration:4},{root:"G",quality:"major",extension:"7",position:12,duration:4},{root:"C",quality:"major",extension:"6",position:16,duration:8}]}},e=["1-16","17-26","27-32","1-16","17-26","33-38"],o=[],n=[];let i=0;for(const r of e){const s=t[r],c=s.length,m=s.melody,y=s.chords;for(const[E,F,V]of m)o.push([E,F+i,V]);for(const E of y)n.push({...E,position:E.position+i});i+=c}return{length:i,melody:o,chords:n}})(),be=L.mf,we="E1",w=Y(ve),Ee=(()=>{const t=[],e=U(we);function o(n){return n>=e?n:o(n+12)}for(const{root:n,quality:i,extension:r,position:s,duration:c}of ht.chords){const m=U(`${n}1`),y=o(m),E=i==="major"?y+4:y+3,F=r==="7(b5)"?y+6:y+7,V=r==="6"?y+9:r==="7"?y+10:r==="maj7"?y+11:r==="7(b5)"?y+10:y+12;if(c===4)t.push([y,b(s,w,.2,1),b(s+O(1),w,.2,1)],[E,b(s+1,w,.2,1),b(s+O(2),w,.2,1)],[F,b(s+2,w,.2,1),b(s+O(3),w,.2,1)],[V,b(s+3,w,.2,1),b(s+O(4),w,.2,1)]);else if(c===2)t.push([y,b(s,w,.2,1),b(s+O(1),w,.2,1)],[F,b(s+1,w,.2,1),b(s+O(2),w,.2,1)]);else for(let Q=0;Q<c;Q+=1)t.push([Q%2===0?y:F,b(s+Q,w,.2,1),b(s+Q+O(1),w,.2,1)])}return t})(),De=ht.melody.map(([t,e,o])=>{const n=U(t),i=.25,r=1,s=b(e,w,i,r),c=b(e+O(o),w,i,r);return[n,s,c]});function ft(t,e){return e.map(([o,n,i])=>[{time:n,type:v.NoteOn,part:t,pitch:o,velocity:be},{time:i,type:v.NoteOff,part:t,pitch:o}]).flat()}const Oe={title:"Fly Me to the Moon",compose:({bass:t,lead:e})=>Ut([],...ft(t,Ee),...ft(e,De))},mt=[Qt,ne,ae,de,Ce,Oe],yt=mt.length;class Pe{constructor(){C(this,x,0);C(this,j,()=>{})}goPrevious(){a(this,x)>0&&(u(this,x,a(this,x)-1),a(this,j).call(this))}goNext(){a(this,x)<yt-1&&(u(this,x,a(this,x)+1),a(this,j).call(this))}connect(e,o){u(this,j,()=>{const n=mt[a(this,x)],i=n.title,r=a(this,x)>0,s=a(this,x)<yt-1;e.changeChart(i,r,s),o.changeChart(n)})}start(){a(this,j).call(this)}}x=new WeakMap,j=new WeakMap;const gt=12,H={min:0,max:127,step:1,default:63};class xe{constructor(){C(this,M);C(this,$);C(this,R,()=>{});C(this,T,()=>0);const e=l("span",{},"EMPTY");u(this,M,{0:l("span",{},"%%"),1:e,2:l("span",{},"%%")}),u(this,$,l("input",{type:"range",min:H.min,max:H.max,step:H.step,value:H.default})).addEventListener("input",()=>{a(this,R).call(this)})}clear(){u(this,T,()=>0),u(this,R,()=>{});const e=Object.values(a(this,M));for(const o of e)o.textContent=""}get value(){return a(this,T).call(this)}makeIntoRangeControl(e,o,n,i=""){const r=a(this,M),s=r[1],c=a(this,$);r[0].textContent=e,r[2].textContent=i;const m=u(this,T,()=>o+Math.round((n-o)*Number(c.value)/H.max));u(this,R,()=>{s.textContent=m().toString()})()}makeIntoOptionControl(e,o,n=""){const i=a(this,M),r=i[1],s=a(this,$);i[0].textContent=e,i[2].textContent=n;const c=u(this,T,()=>Math.round((o.length-1)*Number(s.value)/H.max));u(this,R,()=>{r.textContent=o[c()]})()}render(){const e=l("label",{class:"lcd"},...Object.values(a(this,M)));return l("div",{class:"controller-module"},e,a(this,$))}}M=new WeakMap,$=new WeakMap,R=new WeakMap,T=new WeakMap;function Ie(t){const e=Array.from({length:gt},()=>new xe);let o=0;t.clear=()=>{e.forEach(i=>i.clear()),o=0};function n(){if(o>=gt)throw new Error("No more controllers available");const i=e[o];return o+=1,i}t.getRangeControl=(i,r,s,c="")=>{const m=n();return m.makeIntoRangeControl(i,r,s,c),m},t.getOptionControl=(i,r,s="")=>{const c=n();return c.makeIntoOptionControl(i,r,s),c},t.render=()=>{const i=l("h2",{class:"component-title"},"Controller"),r=e.map(c=>c.render()),s=l("div",{class:"controller-row"},...r);return i.addEventListener("click",()=>{s.classList.toggle("hidden")}),s.classList.add("hidden"),l("div",{class:"controller"},i,s)}}class Ne{constructor(e,o){switch(o.type){case g.Dom:Ie(this);break;default:throw new Error(`Invalid Controller type: ${o}`)}}clear(){}getRangeControl(e,o,n,i=""){return{value:0}}getOptionControl(e,o,n=""){return{value:0}}render(){return null}}function Ae(t){t.noteOn=(e,o,n)=>{console.log("noteOn",e,n,o)},t.noteOff=(e,o)=>{console.log("noteOff",e,o)},t.allNotesOff=()=>{console.log("allNotesOff")}}function ke(t){const e=l("h2",{class:"component-title"},"Synthesizer"),o=l("button",{},"Clear"),n=l("div",{class:"message-row"}),i=l("div",{class:"synthesizer-row"},o,n),r=l("div",{class:"synthesizer"},e,i);function s(c,m){const y=l("div",{class:m},c);n.appendChild(y),n.scrollTop=n.scrollHeight}t.noteOn=(c,m,y,E=!0)=>{E&&t.currentlyPlayingPitches.push(c),s(`noteOn ${c} ${m} ${y.toFixed(0)}`,"note-on")},t.noteOff=(c,m,y=!0)=>{s(`noteOff ${c} ${m.toFixed(0)}`,"note-off"),y&&(t.currentlyPlayingPitches=t.currentlyPlayingPitches.filter(E=>E!==c))},t.allNotesOff=()=>{s("allNotesOff","all-notes-off"),t.currentlyPlayingPitches=[]},o.addEventListener("click",()=>{n.innerHTML=""}),e.addEventListener("click",()=>{i.classList.toggle("hidden")}),i.classList.add("hidden"),t.render=()=>r}function Me(t,e){if(!k)throw new Error("No MIDI access");const o=k.outputs.values().find(i=>i.name===e.midi.output);if(!o)throw new Error(`No MIDI output named ${e.midi.output}`);const n=e.midi.channel-1;t.noteOn=(i,r,s,c=!0)=>{c&&t.currentlyPlayingPitches.push(i),o.send([144+n,i,r],s)},t.noteOff=(i,r,s=!0)=>{o.send([128+n,i,0],r),s&&(t.currentlyPlayingPitches=t.currentlyPlayingPitches.filter(c=>c!==i))},t.allNotesOff=()=>{o.send([176+n,123,0]),t.currentlyPlayingPitches=[]}}class qe{constructor(e,o){d(this,"currentlyPlayingPitches",[]);switch(o.type){case f.Log:Ae(this);break;case f.Dom:ke(this);break;case f.Midi:Me(this,o);break}}noteOn(e,o,n,i=!0){}noteOff(e,o,n=!0){}allNotesOff(){}pause(){const e=window.performance.now();for(const o of this.currentlyPlayingPitches)this.noteOff(o,e,!1)}resume(){const e=window.performance.now();for(const o of this.currentlyPlayingPitches)this.noteOn(o,31,e,!1)}render(){return null}}class tt{constructor(e,o){C(this,K);d(this,"controller");d(this,"synthesizer");u(this,K,e),this.controller=new Ne(e,o.controller),this.synthesizer=new qe(e,o.synthesizer)}render(){const e=l("h2",{},a(this,K).toUpperCase()),o=this.controller.render(),n=this.synthesizer.render();return o||n?l("div",{class:"part"},e,o,n):null}}K=new WeakMap;function Se(t){return{bass:new tt("bass",t.bass),drum:new tt("drum",t.drum),keys:new tt("keys",t.keys),lead:new tt("lead",t.lead)}}const et=100;function Ge(){return new Worker(new URL(""+new URL("worker-Dukc8-Vk.js",import.meta.url).href,import.meta.url),{type:"module"})}class Fe{constructor(e,o){C(this,J);C(this,W);C(this,q,Ge());C(this,I);C(this,S,!1);C(this,G,[]);C(this,X,()=>{});C(this,B,0);C(this,_,0);u(this,W,e),u(this,I,Se(o)),a(this,q).onmessage=n=>this.schedule()}schedule(){const e=window.performance.now()+et;for(;a(this,S)&&a(this,J,it)<e;){const o=a(this,J,it),n=a(this,G).shift();if(n)switch(n.type){case v.NoteOn:n.part.synthesizer.noteOn(n.pitch,n.velocity,o);break;case v.NoteOff:n.part.synthesizer.noteOff(n.pitch,o);break;case v.Compute:n.callback(a(this,G));break}}}changeChart(e){u(this,X,()=>{for(const o of Object.values(a(this,I)))o.controller.clear();console.debug("buffer",u(this,G,e.compose(a(this,I))))})()}play(){u(this,S,!0),u(this,B,window.performance.now()+et),u(this,_,0),a(this,q).postMessage(0)}pause(){u(this,S,!1),a(this,q).postMessage(1),u(this,_,window.performance.now()-a(this,B)),setTimeout(()=>{for(const e of Object.values(a(this,I)))e.synthesizer.pause()},et*2)}resume(){u(this,S,!0),u(this,B,window.performance.now()-a(this,_)),a(this,q).postMessage(0);for(const e of Object.values(a(this,I)))e.synthesizer.resume()}stop(){u(this,S,!1),a(this,q).postMessage(1),u(this,_,0),a(this,X).call(this),setTimeout(()=>{for(const e of Object.values(a(this,I)))e.synthesizer.allNotesOff()},et*2)}render(){const e=Object.values(a(this,I)).map(o=>o.render());return e.some(o=>o!==null)?l("div",{id:"part-container"},...e):null}}W=new WeakMap,q=new WeakMap,I=new WeakMap,S=new WeakMap,G=new WeakMap,X=new WeakMap,B=new WeakMap,_=new WeakMap,J=new WeakSet,it=function(){return a(this,G).length===0?(a(this,W).stop(),1/0):a(this,G)[0].time+a(this,B)};class Le{constructor(e){C(this,D,p.Paused);C(this,A,()=>{});C(this,N);u(this,N,new Fe(this,e))}changeChart(e){a(this,N).changeChart(e),a(this,D)!=p.Stopped&&this.stop()}play(){switch(a(this,D)){case p.Playing:break;case p.Paused:a(this,A).call(this,P.Resume),u(this,D,p.Playing);break;case p.Stopped:a(this,A).call(this,P.Play),u(this,D,p.Playing);break}}pause(){switch(a(this,D)){case p.Playing:a(this,A).call(this,P.Pause),u(this,D,p.Paused);break;case p.Paused:break;case p.Stopped:break}}stop(){switch(a(this,D)){case p.Playing:a(this,A).call(this,P.Stop),u(this,D,p.Stopped);break;case p.Paused:a(this,A).call(this,P.Stop),u(this,D,p.Stopped);break;case p.Stopped:break}}connect(e){u(this,A,o=>{switch(o){case P.Play:a(this,N).play(),e.changePlayback(p.Playing);break;case P.Pause:a(this,N).pause(),e.changePlayback(p.Paused);break;case P.Resume:a(this,N).resume(),e.changePlayback(p.Playing);break;case P.Stop:a(this,N).stop(),e.changePlayback(p.Stopped);break}})}render(){return a(this,N).render()}}D=new WeakMap,A=new WeakMap,N=new WeakMap;function Ct(t){t&&document.body.append(t)}function je(t){const e=new zt(t.transporter),o=new Pe,n=new Le(t.parts);e.connect(o,n),o.connect(e,n),n.connect(e);const i=e.render(),r=n.render();Ct(i),Ct(r),o.start()}const $e=await Bt();je($e)})();
</script>
  <style rel="stylesheet" crossorigin>:root{--red: #b23535;--green: #38ad5f;--blue: #464ca5;--white: #eeeade;--black: #282828;--text-color: var(--black);--background-color: var(--white)}@media (prefers-color-scheme: dark){:root{--text-color: var(--white);--background-color: var(--black)}}*{color:inherit;background-color:inherit;border-color:inherit;font-family:inherit;box-sizing:inherit}body{min-height:100vh;font-family:Arial,sans-serif;color:var(--text-color);background-color:var(--background-color);border-color:var(--text-color);box-sizing:border-box;padding:0;margin:0}#config-form{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}fieldset{margin-bottom:20px}legend{font-weight:700;margin-bottom:10px}.type-div{margin-bottom:10px}label{-webkit-user-select:none;user-select:none}input[type=radio]:disabled+label{text-decoration:line-through}button{color:var(--text-color);background-color:var(--background-color);border:1px solid var(--text-color);cursor:pointer;transition:background-color .3s ease}button:hover{background-color:var(--text-color);color:var(--background-color)}.transporter-button{width:2em;height:2em;border:1.5px solid;border-radius:50%;font-size:2.5rem;padding:1rem;margin:0 .5rem 2rem;cursor:pointer;color:var(--background-color);background-color:var(--text-color);transition:transform .2s}.transporter-button:hover:enabled{transform:scale(1.1)}.transporter-button:disabled{color:var(--text-color);background-color:var(--background-color);cursor:auto}#transporter{text-align:center;border-bottom:1px solid var(--text-color)}.lcd{padding:.5em 1em;border-radius:5px;width:16ch;min-height:4em;line-height:1.5;text-align:left;font-family:hd44780,monospace;color:var(--background-color);background-color:var(--text-color)}input[type=range]{margin-top:1em;width:100%}.controller-module{padding:1em;display:flex;flex-direction:column;align-items:center;border:1px solid;font-size:1vw}.component-title{margin-top:0;margin-bottom:0;width:100%;height:3rem;line-height:3rem;cursor:pointer;-webkit-user-select:none;user-select:none}.controller-row{border-top:1px solid;justify-content:center;align-items:center;overflow-y:scroll;height:40vw}.controller{padding-top:0;border:1px solid}.note-on{color:var(--green)}.note-off{color:var(--red)}.all-notes-off{color:var(--blue)}.message-row{width:100%;height:10vw;overflow-y:scroll}.synthesizer-row{width:100%}.synthesizer{display:flex;flex-direction:column;align-items:center;width:100%;border:1px solid}.part{text-align:center;border:1px solid;min-width:20%}#part-container{display:flex;flex-wrap:wrap;justify-content:space-around;align-items:start}.hidden{display:none}
</style>
</head>

<body>
</body>

</html>