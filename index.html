<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sequencer</title>
  <script type="module" crossorigin>var oo=Object.defineProperty;var $t=p=>{throw TypeError(p)};var no=(p,g,b)=>g in p?oo(p,g,{enumerable:!0,configurable:!0,writable:!0,value:b}):p[g]=b;var y=(p,g,b)=>no(p,typeof g!="symbol"?g+"":g,b),Ct=(p,g,b)=>g.has(p)||$t("Cannot "+b);var a=(p,g,b)=>(Ct(p,g,"read from private field"),b?b.call(p):g.get(p)),E=(p,g,b)=>g.has(p)?$t("Cannot add the same private member more than once"):g instanceof WeakSet?g.add(p):g.set(p,b),u=(p,g,b,P)=>(Ct(p,g,"write to private field"),P?P.call(p,b):g.set(p,b),b),dt=(p,g,b)=>(Ct(p,g,"access private method"),b);(async()=>{var M,_,L,U,z,H,ot,J,W,$,Q,nt,Z,K,Y,tt,et,ht,N,F,q;(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();const p=await(()=>{try{return navigator.requestMIDIAccess({sysex:!0})}catch{return null}})();var g=(e=>(e[e.Dom=0]="Dom",e))(g||{}),b=(e=>(e[e.Dom=0]="Dom",e))(b||{}),P=(e=>(e[e.Dom=0]="Dom",e[e.Midi=1]="Midi",e))(P||{}),w=(e=>(e[e.Playing=0]="Playing",e[e.Paused=1]="Paused",e[e.Stopped=2]="Stopped",e))(w||{}),k=(e=>(e[e.Play=0]="Play",e[e.Pause=1]="Pause",e[e.Resume=2]="Resume",e[e.Stop=3]="Stop",e))(k||{}),f=(e=>(e[e.Compute=0]="Compute",e[e.NoteOn=1]="NoteOn",e[e.NoteOff=2]="NoteOff",e))(f||{});function Ft(e,t,o){const n=[];if(!p)return n.push(`The ${e} cannot be type MIDI without MIDI access`),n;const i=p[o].values(),r=Array.from(i);return r?(r.find(({name:s})=>s===t)||n.push(`No MIDI ${o} named ${t} for ${e}`),n):(n.push(`No MIDI ${o}`),n)}function Rt(e,t){const o=[],{output:n,channel:i}=t;return n?o.push(...Ft(e,n,"outputs")):o.push(`No MIDI output for ${e}`),i?(i<1||i>16)&&o.push(`Invalid MIDI channel for ${e}: ${i}`):o.push(`No MIDI channel for ${e}`),o}function jt(e){const t=[];return e.type===void 0?(t.push("No transporter type"),t):(e.type in g||t.push(`Invalid transporter type: ${e.type}`),t)}function Gt(e,t){const o=[];return t.type===void 0?(o.push(`No controller type for ${e} part`),o):(t.type in b||o.push(`Invalid controller type for ${e} part: ${t.type}`),o)}function Lt(e,t){const o=[];if(t.type===void 0)return o.push(`No synthesizer type for ${e} part`),o;if(t.type in P||o.push(`Invalid synthesizer type for ${e} part: ${t.type}`),t.type===P.Midi){if(!p)return o.push("No MIDI access"),o;const{midi:n}=t;if(!n)return o.push("No MIDI config"),o;o.push(...Rt(`${e} synthesizer`,n))}return o}function Tt(e,t){const o=[],{controller:n,synthesizer:i}=t;return n?o.push(...Gt(e,n)):o.push(`No controller for ${e} part`),i?o.push(...Lt(e,i)):o.push(`No synthesizer for ${e} part`),o}function Bt(e){const t=[],o=["bass","drum","keys","lead"];for(const n of o){const i=e[n];if(!i){t.push(`No ${n} part`);continue}t.push(...Tt(n,i))}return t}function vt(e){const t=[],{transporter:o,parts:n}=e;return o?t.push(...jt(o)):t.push("No transporter"),n?t.push(...Bt(n)):t.push("No parts"),t}function _t(){const e=new URLSearchParams(window.location.search),t=e.get("config");try{if(!t)return null;const o=decodeURIComponent(t),n=atob(o),i=JSON.parse(n),r=vt(i);if(r.length)throw new Error(r.join(`
`));return i}catch(o){alert(o.message),console.error(o),e.delete("config");const n=`${window.location.origin}${window.location.pathname}?${e.toString()}`;window.history.replaceState(null,"",n)}return null}function c(e,t={},...o){const n=document.createElement(e);for(const[i,r]of Object.entries(t))n.setAttribute(i,r);for(const i of o)typeof i=="string"?n.appendChild(document.createTextNode(i)):i&&n.appendChild(i);return n}const Ut=[["DOM",g.Dom]],zt=[["DOM",b.Dom]],Ht=[["DOM",P.Dom],["MIDI",P.Midi]],T={CONFIG_FORM_ID:"config-form",TRANSPORTER_CONFIG_ID:"transporter-config",PART_CONFIG_CLASS:"part-config",TYPE_DIV_CLASS:"type-div",MIDI_DIV_CLASS:"midi-div",MIDI_OUTPUT_SELECT_CLASS:"midi-output-select",REMEMBER_CHECKBOX_ID:"remember-config"};function Kt(e,t){if(!e.div)throw new Error("setUpRadioButtons called before render");const o=Array.from(e.div.querySelectorAll('input[type="radio"]'));for(const n of o)for(const[i,r]of t)n.addEventListener("change",()=>{if(!r.div)throw new Error("setUpRadioButtons called before render");r.div.classList[Number(n.value)===i?"remove":"add"]("hidden")})}class ft{constructor(t,o,n){y(this,"name");y(this,"title");y(this,"typeNamesAndEnums");y(this,"inputs");y(this,"div");this.name=t,this.title=o,this.typeNamesAndEnums=n,this.inputs={},this.div=null}render(){const t=this.typeNamesAndEnums.map(([o,n])=>{const i=`${this.name}-${o}`,r=c("input",{id:i,type:"radio",name:this.name,value:n}),s=c("label",{for:i},o);return this.inputs[n]=r,[r,s]}).flat();return this.div=c("div",{class:T.TYPE_DIV_CLASS},this.title,...t)}getConfig(){if(!this.div)throw new Error("getConfig called before render");return Number(this.div.querySelector('input[type="radio"]:checked').value)}}class Yt{constructor(){y(this,"select",null);y(this,"input",null);y(this,"div",null)}render(){const t=this.select=c("select",{class:T.MIDI_OUTPUT_SELECT_CLASS}),o=this.input=c("input",{type:"number",name:"channel",min:1,max:16,value:1});return this.div=c("div",{},t," on channel ",o)}getConfig(){if(!this.select||!this.input)throw new Error("getConfig called before render");return{output:this.select.value,channel:this.input.value}}}class Vt{constructor(){y(this,"typeConfig",new ft("transporter-type","Type: ",Ut))}render(){const t=c("legend",{},"TRANSPORTER"),o=this.typeConfig.render();return c("fieldset",{id:T.TRANSPORTER_CONFIG_ID},t,o)}setUp(){}getConfig(){const t={};return t.type=this.typeConfig.getConfig(),t}}class Xt{constructor(t){y(this,"typeConfig");y(this,"div",null);this.typeConfig=new ft(`${t}-controller-type`,"Controller: ",zt)}render(){const t=this.typeConfig.render();return this.div=c("div",{},t)}setUp(){}getConfig(){const t={};return t.type=this.typeConfig.getConfig(),t}}class Jt{constructor(t){y(this,"typeConfig");y(this,"midiConfig",new Yt);this.typeConfig=new ft(`${t}-synthesizer-type`,"Synthesizer: ",Ht)}render(){const t=this.typeConfig.render(),o=this.midiConfig.render();return c("div",{},t,o)}setUp(){Kt(this.typeConfig,[[P.Midi,this.midiConfig]])}getConfig(){const t={};return(t.type=this.typeConfig.getConfig())===P.Midi&&(t.midi=this.midiConfig.getConfig()),t}}class it{constructor(t){y(this,"name");y(this,"controllerConfig");y(this,"synthesizerConfig");this.name=t,this.controllerConfig=new Xt(t),this.synthesizerConfig=new Jt(t)}render(){const t=c("legend",{},this.name.toUpperCase()),o=this.controllerConfig.render(),n=c("hr"),i=this.synthesizerConfig.render();return c("fieldset",{},t,o,n,i)}setUp(){this.controllerConfig.setUp(),this.synthesizerConfig.setUp()}getConfig(){return{controller:this.controllerConfig.getConfig(),synthesizer:this.synthesizerConfig.getConfig()}}}class Wt{constructor(){y(this,"div",null)}render(){return this.div=c("div",{class:"problem-div"})}addProblems(t){if(!this.div)throw new Error("addProblems called before render");const o=this.div;o.innerHTML="";for(const n of t){const i=c("p",{},n);o.appendChild(i)}}}class Qt{constructor(){y(this,"refreshButton",null);y(this,"rememberCheckbox",null);y(this,"problemDiv",new Wt)}render(){const t=this.refreshButton=c("button",{type:"button"},"Refresh MIDI Ports"),o=this.rememberCheckbox=c("input",{type:"checkbox",id:T.REMEMBER_CHECKBOX_ID}),n=c("label",{for:T.REMEMBER_CHECKBOX_ID},"Remember"),i=c("button",{type:"submit"},"Submit"),r=this.problemDiv.render();return c("div",{},t,o,n,i,r)}setUp(){}}class Zt{constructor(){y(this,"transporterConfig",new Vt);y(this,"partConfigs",{bass:new it("bass"),drum:new it("drum"),keys:new it("keys"),lead:new it("lead")});y(this,"miscellaneousDiv",new Qt);y(this,"form",null)}render(){const t=this.transporterConfig.render(),o=Object.values(this.partConfigs).map(i=>i.render()),n=this.miscellaneousDiv.render();return this.form=c("form",{id:T.CONFIG_FORM_ID},t,...o,n)}setUp(){if(!this.form)throw new Error("setUp called before render");this.transporterConfig.setUp();for(const t of Object.values(this.partConfigs))t.setUp();if(!this.miscellaneousDiv.refreshButton)throw new Error("setUp called before render");this.miscellaneousDiv.refreshButton.addEventListener("mousedown",this.refreshMidi.bind(this)),this.refreshMidi(),this.clickAllFirstRadioButtons(),this.form.classList.remove("hidden")}getConfig(){return{transporter:this.transporterConfig.getConfig(),parts:{bass:this.partConfigs.bass.getConfig(),drum:this.partConfigs.drum.getConfig(),keys:this.partConfigs.keys.getConfig(),lead:this.partConfigs.lead.getConfig()}}}refreshMidi(){if(!this.form)throw new Error("refreshMidi called before render");const t=Array.from(this.form.querySelectorAll('input[type="radio"][value="1"]'));for(const n of t)n.disabled=!p;if(!p)return;function o(n,i){const r=document.getElementsByClassName(n),s=Array.from(p[i].values()).map(l=>l.name);for(const l of r){const d=l.value||s[0];l.innerHTML="";for(const h of s){const v=c("option",{value:h},h);l.appendChild(v)}s.includes(d)&&(l.value=d)}}o(T.MIDI_OUTPUT_SELECT_CLASS,"outputs")}clickAllFirstRadioButtons(){if(!this.form)throw new Error("clickAllFirstRadioButtons called before render");const t=Array.from(this.form.querySelectorAll('input[type="radio"]:enabled:first-of-type'));for(const o of t)o.click()}getPromise(){return new Promise(t=>{if(!this.form)throw new Error("getPromise called before render");this.form.addEventListener("submit",o=>{var r;if(!this.form)throw new Error("submit event listener called after form was removed");o.preventDefault();const n=this.getConfig(),i=vt(n);if(this.miscellaneousDiv.problemDiv.addProblems(i),!i.length){if((r=this.miscellaneousDiv.rememberCheckbox)!=null&&r.checked)try{const s=JSON.stringify(n),l=btoa(s),d=encodeURIComponent(l),h=`${window.location.origin}${window.location.pathname}?config=${d}`;window.history.pushState({},"",h)}catch(s){alert("Error saving config to URL"),console.error(s)}this.form.remove(),t(n)}})})}}async function te(){const e=new Zt;return document.body.append(e.render()),e.setUp(),await e.getPromise()}const ee=async()=>_t()||await te();function oe(e){const t=c("h2"),o={previous:c("button",{class:"transporter-button"},"\u23EE"),play:c("button",{class:"transporter-button"},"\u25B6"),pause:c("button",{class:"transporter-button"},"\u23F8"),stop:c("button",{class:"transporter-button"},"\u23F9"),next:c("button",{class:"transporter-button"},"\u23ED")};e.connect=(r,s)=>{o.previous.addEventListener("click",()=>r.goPrevious()),o.next.addEventListener("click",()=>r.goNext()),o.play.addEventListener("click",()=>s.play()),o.pause.addEventListener("click",()=>s.pause()),o.stop.addEventListener("click",()=>s.stop())},e.changeChart=(r,s,l)=>{t.innerText=r,o.previous.disabled=!s,o.next.disabled=!l},e.changePlayback=r=>{o.play.disabled=r===w.Playing,o.pause.disabled=r!==w.Playing,o.stop.disabled=r===w.Stopped};const n=c("div",{},...Object.values(o)),i=c("div",{id:"transporter"},t,n);e.render=()=>i}class ne{constructor(t){switch(t.type){case g.Dom:oe(this);break;default:throw new Error(`Invalid Transporter type: ${t}`)}}connect(t,o){}changeChart(t,o,n){}changePlayback(t){}render(){return null}}function*ie(...e){const t=e.map(o=>({generator:o,result:o.next()})).filter(({result:o})=>!o.done).map(({generator:o,result:n})=>({generator:o,value:n.value}));for(t.sort((o,n)=>o.value.time-n.value.time);t.length>0;){const o=t.shift();if(o===void 0)return;yield o.value;const{value:n,done:i}=o.generator.next();if(!i){const r=t.findIndex(s=>s.value.time>n.time);r===-1?t.push({generator:o.generator,value:n}):t.splice(r,0,{generator:o.generator,value:n})}}}function j(e){return 6e4/e}function G(e,t,o,n){if(e===-1/0||e===1/0)return e;const i=e%n,r=n*Math.floor(e/n),s=i<n/2?(o+1)*i:(1-o)*i+o*n;return(r+s)*t}function V(e){return Math.max(e-.1,e*.9)}const re=/[CDEFGAB]/,se=/♮|b{1,2}|#{1,2}/,ae=/-?[0-8]/,le=/[CDEFGAB](♮|b{1,2}|#{1,2})?/;function A(e){var h,v,O,C;const t=(h=e.match(le))==null?void 0:h[0];if(t===void 0)throw new Error(`Invalid pitch class: ${e}`);const o=(v=t.match(re))==null?void 0:v[0];if(o===void 0)throw new Error(`Invalid pitch letter: ${t}`);const n={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[o];if(n===void 0)throw new Error(`Invalid pitch letter: ${t}`);const i=((O=t.match(se))==null?void 0:O[0])||"\u266E",r={"\u266E":0,b:-1,bb:-2,"#":1,"##":2}[i];if(r===void 0)throw new Error(`Invalid accidental: ${t}`);const s=Number((C=e.match(ae))==null?void 0:C[0]);if(isNaN(s))throw new Error(`Invalid octave: ${t}`);const l=(s+1)*12,d=n+r+l;if(d<0||d>127)throw new Error(`Out of MIDI range: ${t}`);return d}var B=(e=>(e[e.pp=21]="pp",e[e.p=41]="p",e[e.mp=61]="mp",e[e.mf=81]="mf",e[e.f=101]="f",e[e.ff=121]="ff",e[e.fff=127]="fff",e))(B||{});const ce=100,mt=5,ue=120,wt=["C2","D2","E2","F2","G2","A2","B2","C3"],pe=B.mf,de=2,bt=j(ue),he=wt.map(A),fe={title:"Bass Scale",compose:function*({bass:e}){for(const[t,o]of he.entries()){const n=t*bt,i=t===wt.length-1?de:1,r=(t+V(i))*bt;yield{time:n,type:f.NoteOn,part:e,pitch:o,velocity:pe},yield{time:r,type:f.NoteOff,part:e,pitch:o}}}};function me(e,t,o,n,i){const r=j(e);return n.map(([s,l,d])=>{const h=A(s),v=G(l,r,t,o),O=G(l+V(d),r,t,o);return[h,i,v,O]})}function*ye(e,t){for(const[o,n,i,r]of t)yield{type:f.NoteOn,time:i,part:e,pitch:o,velocity:n},yield{type:f.NoteOff,time:r,part:e,pitch:o}}function*ge(e,t,o,n,i,r,s){const l=e.controller.getOptionControl("DIR: ",["\\/","/\\"]),d=j(t),h=V(1),v=A("E1");function O(D){return D>=v?D:O(D+12)}function C(D,m){const S=A(`${m.root}1`),x=O(S),R=x+(m.quality==="major"?4:3),I=x+(m.extension==="7(b5)"?6:7),ut=m.extension==="6"?x+9:m.extension==="7"?x+10:m.extension==="maj7"?x+11:m.extension==="7(b5)"?x+10:x+12,Mt=x+12,pt=l.value?x:Mt;switch(m.duration){case 4:return l.value?[x,R,I,ut]:[Mt,ut,I,R];case 2:const qt=m.position%o===0,St=r[D+(qt?1:-1)];return St.root===m.root&&St.extension===m.extension?qt?[pt,pt]:[I,I]:[pt,I];default:return Array.from({length:m.duration},(io,eo)=>eo%2===0?pt:I)}}yield{type:f.Compute,time:-1/0};for(const[D,m]of r.entries())for(const[S,x]of C(D,m).entries()){const R=m.position+S,I=G(R,d,n,i),ut=G(R+h,d,n,i);yield{type:f.NoteOn,time:I,part:e,pitch:x,velocity:s},yield{type:f.NoteOff,time:ut,part:e,pitch:x}}}function*Ce(e,t,o,n,i,r){const s=j(t),l=A("D3"),d=A("D#3");for(let h=0;h<i;h+=1){const v=G(h,s,o,n),O=G(h+.5,s,o,n),C=h%2===0?l:d;yield{type:f.NoteOn,time:v,part:e,pitch:C,velocity:r},yield{type:f.NoteOff,time:v+mt,part:e,pitch:C},yield{type:f.NoteOn,time:O,part:e,pitch:l,velocity:r},yield{type:f.NoteOff,time:O+mt,part:e,pitch:l}}}function*ve(e,t,o,n,i,r){const s=A("C3"),l=A("C5")-s,d=e.controller.getRangeControl("POS: ",0,l),h=j(t);function v(C){const D=s+d.value,m=D-6,S=D+6;return C<m?v(C+12):C>S?v(C-12):C}function O(C){const D=A(`${C.root}1`),m=v(D),S=m+(C.quality==="major"?4:3),x=m+(C.extension==="7(b5)"?6:7),R=C.extension==="6"?m+9:C.extension==="7"?m+10:C.extension==="maj7"?m+11:C.extension==="7(b5)"?m+10:m+12;return[m,S,x,R].map(v)}yield{type:f.Compute,time:-1/0};for(const C of i){const{position:D,duration:m}=C,S=O(C),x=G(D,h,o,n),R=G(V(D+m),h,o,n);for(const I of S)yield{type:f.NoteOn,time:x,part:e,pitch:I,velocity:r};for(const I of S)yield{type:f.NoteOff,time:R,part:e,pitch:I}}}const rt=118,we=4,yt=.3,gt=1,st=(()=>{const e={"1-16":{length:64,melody:[["C5",0,1],["B4",1,1],["A4",2,.5],["G4",2.5,1.5],["F4",4,1.5],["G4",5.5,.5],["A4",6,1],["C5",7,1],["B4",8,1],["A4",9,1],["G4",10,.5],["F4",10.5,1.5],["E4",12,4],["A4",16,1],["G4",17,1],["F4",18,.5],["E4",18.5,1.5],["D4",20,1.5],["E4",21.5,.5],["F4",22,1],["A4",23,1],["G#4",24,1],["F4",25,1],["E4",26,.5],["D4",26.5,1.5],["C4",28,3],["C#4",31,1],["D4",32,.5],["A4",32.5,1],["A4",33.5,3.5],["C5",37,2],["B4",39,1],["G4",40,7],["B3",47,1],["C4",48,.5],["F4",48.5,1],["F4",49.5,3.5],["A4",53,2],["G4",55,1],["F4",56,2],["E4",58,7]],chords:[{root:"A",quality:"minor",extension:"7",position:0,duration:4},{root:"D",quality:"minor",extension:"7",position:4,duration:4},{root:"G",quality:"major",extension:"7",position:8,duration:4},{root:"C",quality:"major",extension:"maj7",position:12,duration:2},{root:"C",quality:"major",extension:"7",position:14,duration:2},{root:"F",quality:"major",extension:"maj7",position:16,duration:4},{root:"B",quality:"minor",extension:"7(b5)",position:20,duration:4},{root:"E",quality:"major",extension:"7",position:24,duration:4},{root:"A",quality:"minor",extension:"7",position:28,duration:2},{root:"A",quality:"major",extension:"7",position:30,duration:2},{root:"D",quality:"minor",extension:"7",position:32,duration:4},{root:"G",quality:"major",extension:"7",position:36,duration:4},{root:"C",quality:"major",extension:"maj7",position:40,duration:4},{root:"E",quality:"minor",extension:"7",position:44,duration:2},{root:"A",quality:"minor",extension:"7",position:46,duration:2},{root:"D",quality:"minor",extension:"7",position:48,duration:4},{root:"G",quality:"major",extension:"7",position:52,duration:4},{root:"F",quality:"major",extension:"6",position:56,duration:2},{root:"C",quality:"major",extension:"maj7",position:58,duration:2},{root:"B",quality:"minor",extension:"7(b5)",position:60,duration:2},{root:"E",quality:"major",extension:"7",position:62,duration:2}]},"17-26":{length:40,melody:[["C5",0,1],["B4",1,1],["A4",2,.5],["G4",2.5,1.5],["F4",4,1.5],["G4",5.5,.5],["A4",6,1],["C5",7,1],["B4",8,1],["A4",9,1],["G4",10,.5],["F4",10.5,1.5],["E4",12,4],["A4",16,1],["G4",17,1],["F4",18,.5],["E4",18.5,1.5],["D4",20,1],["E4",21,1],["F4",22,1],["A4",23,1],["G#4",24,1],["F4",25,1],["E4",26,.5],["D4",26.5,1.5],["C4",28,3],["C#4",31,1],["D4",32,.5],["A4",32.5,1],["A4",33.5,3.5],["C5",37,2],["B4",39,1]],chords:[{root:"A",quality:"minor",extension:"7",position:0,duration:4},{root:"D",quality:"minor",extension:"7",position:4,duration:4},{root:"G",quality:"major",extension:"7",position:8,duration:4},{root:"C",quality:"major",extension:"maj7",position:12,duration:2},{root:"C",quality:"major",extension:"7",position:14,duration:2},{root:"F",quality:"major",extension:"maj7",position:16,duration:4},{root:"B",quality:"minor",extension:"7(b5)",position:20,duration:4},{root:"E",quality:"major",extension:"7",position:24,duration:4},{root:"A",quality:"minor",extension:"7",position:28,duration:2},{root:"A",quality:"major",extension:"7",position:30,duration:2},{root:"D",quality:"minor",extension:"7",position:32,duration:4},{root:"G",quality:"major",extension:"7",position:36,duration:4}]},"27-32":{length:24,melody:[["G4",0,7],["G#4",7,1],["A4",8,.5],["C4",8.5,1],["C4",9.5,3.5],["C4",13,2],["D4",15,1],["C4",16,4]],chords:[{root:"E",quality:"minor",extension:"7",position:0,duration:4},{root:"A",quality:"minor",extension:"7",position:4,duration:4},{root:"D",quality:"minor",extension:"7",position:8,duration:4},{root:"G",quality:"major",extension:"7",position:12,duration:4},{root:"C",quality:"major",extension:"6",position:16,duration:4},{root:"B",quality:"minor",extension:"7(b5)",position:20,duration:2},{root:"E",quality:"major",extension:"7",position:22,duration:2}]},"33-38":{length:24,melody:[["E5",0,7],["C5",7,1],["D5",8,.5],["A4",8.5,1],["A4",9.5,3.5],["B4",13,2],["D5",15,1],["C5",16,7]],chords:[{root:"E",quality:"minor",extension:"7",position:0,duration:4},{root:"A",quality:"minor",extension:"7",position:4,duration:4},{root:"D",quality:"minor",extension:"7",position:8,duration:4},{root:"G",quality:"major",extension:"7",position:12,duration:4},{root:"C",quality:"major",extension:"6",position:16,duration:8}]}},t=["1-16","17-26","27-32","1-16","17-26","33-38"],o=[],n=[];let i=0;for(const r of t){const s=e[r],l=s.length,d=s.melody,h=s.chords;for(const[v,O,C]of d)o.push([v,O+i,C]);for(const v of h)n.push({...v,position:v.position+i});i+=l}return{length:i,melody:o,chords:n}})(),at=B.mf,be={title:"Fly Me to the Moon",compose:function*({bass:e,drum:t,keys:o,lead:n}){const i=ge(e,rt,we,yt,gt,st.chords,at),r=Ce(t,rt,.35,1,st.length,at),s=ve(o,rt,yt,gt,st.chords,at),l=ye(n,me(rt,yt,gt,st.melody,at)),d=ie(i,r,s,l);for(const h of d)yield h}},Et=60,Ee=B.mf,xe=4e3,De={title:"Hello World",compose:function*({lead:e}){yield{time:0,type:f.NoteOn,part:e,pitch:Et,velocity:Ee},yield{time:xe,type:f.NoteOff,part:e,pitch:Et}}},Oe=60,Pe=240,Ne=4,Ie=33,Ae=32,ke=B.f,Me={title:"Metronome",compose:function*({drum:e}){const t=e.controller.getRangeControl("Tempo: ",Oe,Pe," BPM");let o=0,n=0;for(;;){const i=n%Ne===0?Ie:Ae;yield{time:o,type:f.NoteOn,part:e,pitch:i,velocity:ke},yield{time:o+mt,type:f.NoteOff,part:e,pitch:i},o+=j(t.value),n+=1}}},qe=165,xt=["E3","G3","A3","G3","D4","C4","D4","E4"],Se=2,$e=B.mf,Fe=j(qe),Dt=Se*Fe,Ot=Dt/xt.length,Re=xt.map((e,t)=>{const o=A(e),n=t*Ot,i=n+V(Ot);return[o,n,i]}),je={title:"On the Run",compose:function*({lead:e}){const t=e.controller.getOptionControl("Repeat again: ",["No","Yes"],"!");yield{time:-1/0,type:f.Compute};let o=0;for(;t.value;){for(const[n,i,r]of Re)yield{time:o+i,type:f.NoteOn,part:e,pitch:n,velocity:$e},yield{time:o+r,type:f.NoteOff,part:e,pitch:n};o+=Dt}}},Ge=120,Le=[["C4",0,.9],["C4",1,.9],["G4",2,.9],["G4",3,.9],["A4",4,.9],["A4",5,.9],["G4",6,1.9],["F4",8,.9],["F4",9,.9],["E4",10,.9],["E4",11,.9],["D4",12,.9],["D4",13,.9],["C4",14,1.9],["G4",16,.9],["G4",17,.9],["F4",18,.9],["F4",19,.9],["E4",20,.9],["E4",21,.9],["D4",22,1.9],["G4",24,.9],["G4",25,.9],["F4",26,.9],["F4",27,.9],["E4",28,.9],["E4",29,.9],["D4",30,1.9],["C4",32,.9],["C4",33,.9],["G4",34,.9],["G4",35,.9],["A4",36,.9],["A4",37,.9],["G4",38,1.9],["F4",40,.9],["F4",41,.9],["E4",42,.9],["E4",43,.9],["D4",44,.9],["D4",45,.9],["C4",46,2]],Te=B.mf,Pt=j(Ge),Be=Le.map(([e,t,o])=>{const n=A(e),i=t*Pt,r=(t+V(o))*Pt;return[n,i,r]}),_e={title:"Twinkle Twinkle Little Star",compose:function*({lead:e}){const t=e.controller.getRangeControl("8va chance: ",0,100,"%");for(const[o,n,i]of Be){yield{time:n-ce,type:f.Compute};const r=t.value>Math.random()*100?o+12:o;yield{time:n,type:f.NoteOn,part:e,pitch:r,velocity:Te},yield{time:i,type:f.NoteOff,part:e,pitch:r}}}},Nt=[De,fe,Me,_e,je,be],It=Nt.length;class Ue{constructor(){E(this,M,0);E(this,_,()=>{})}goPrevious(){a(this,M)>0&&(u(this,M,a(this,M)-1),a(this,_).call(this))}goNext(){a(this,M)<It-1&&(u(this,M,a(this,M)+1),a(this,_).call(this))}connect(t,o){u(this,_,()=>{const n=Nt[a(this,M)],i=n.title,r=a(this,M)>0,s=a(this,M)<It-1;t.changeChart(i,r,s),o.changeChart(n)})}start(){a(this,_).call(this)}}M=new WeakMap,_=new WeakMap;const At=12,X={min:0,max:127,step:1,default:63};class ze{constructor(){E(this,L);E(this,U);E(this,z,()=>{});E(this,H,()=>0);const t=c("span",{},"EMPTY");u(this,L,{0:c("span",{},"%%"),1:t,2:c("span",{},"%%")}),u(this,U,c("input",{type:"range",min:X.min,max:X.max,step:X.step,value:X.default})).addEventListener("input",()=>{a(this,z).call(this)})}clear(){u(this,H,()=>0),u(this,z,()=>{});const t=Object.values(a(this,L));for(const o of t)o.textContent=""}get value(){return a(this,H).call(this)}makeIntoRangeControl(t,o,n,i=""){const r=a(this,L),s=r[1],l=a(this,U);r[0].textContent=t,r[2].textContent=i;const d=u(this,H,()=>o+Math.round((n-o)*Number(l.value)/X.max));u(this,z,()=>{s.textContent=d().toString()})()}makeIntoOptionControl(t,o,n=""){const i=a(this,L),r=i[1],s=a(this,U);i[0].textContent=t,i[2].textContent=n;const l=u(this,H,()=>Math.round((o.length-1)*Number(s.value)/X.max));u(this,z,()=>{r.textContent=o[l()]})()}render(){const t=c("label",{class:"lcd"},...Object.values(a(this,L)));return c("div",{class:"controller-module"},t,a(this,U))}}L=new WeakMap,U=new WeakMap,z=new WeakMap,H=new WeakMap;function He(e){const t=Array.from({length:At},()=>new ze);let o=0;e.clear=()=>{t.forEach(i=>i.clear()),o=0};function n(){if(o>=At)throw new Error("No more controllers available");const i=t[o];return o+=1,i}e.getRangeControl=(i,r,s,l="")=>{const d=n();return d.makeIntoRangeControl(i,r,s,l),d},e.getOptionControl=(i,r,s="")=>{const l=n();return l.makeIntoOptionControl(i,r,s),l},e.render=()=>{const i=c("h2",{class:"component-title"},"Controller"),r=t.map(l=>l.render()),s=c("div",{class:"controller-row"},...r);return i.addEventListener("click",()=>{s.classList.toggle("hidden")}),s.classList.add("hidden"),c("div",{class:"controller"},i,s)}}class Ke{constructor(t,o){switch(o.type){case b.Dom:He(this);break;default:throw new Error(`Invalid Controller type: ${o}`)}}clear(){}getRangeControl(t,o,n,i=""){return{value:0}}getOptionControl(t,o,n=""){return{value:0}}render(){return null}}function Ye(e){const t=c("h2",{class:"component-title"},"Synthesizer"),o=c("button",{},"Clear"),n=c("div",{class:"message-row"}),i=c("div",{class:"synthesizer-row"},o,n),r=c("div",{class:"synthesizer"},t,i);function s(l,d){const h=c("div",{class:d},l);n.appendChild(h),n.scrollTop=n.scrollHeight}e.noteOn=(l,d,h,v=!0)=>{v&&e.currentlyPlayingPitches.push(l),s(`noteOn ${l} ${d} ${h.toFixed(0)}, scheduled at: ${window.performance.now().toFixed(0)}`,"note-on")},e.noteOff=(l,d,h=!0)=>{s(`noteOff ${l} ${d.toFixed(0)}, scheduled at: ${window.performance.now().toFixed(0)}`,"note-off"),h&&(e.currentlyPlayingPitches=e.currentlyPlayingPitches.filter(v=>v!==l))},e.allNotesOff=()=>{s("allNotesOff","all-notes-off"),e.currentlyPlayingPitches=[]},o.addEventListener("click",()=>{n.innerHTML=""}),t.addEventListener("click",()=>{i.classList.toggle("hidden")}),i.classList.add("hidden"),e.render=()=>r}function Ve(e,t){if(!p)throw new Error("No MIDI access");const o=p.outputs.values().find(i=>i.name===t.midi.output);if(!o)throw new Error(`No MIDI output named ${t.midi.output}`);const n=t.midi.channel-1;e.noteOn=(i,r,s,l=!0)=>{l&&e.currentlyPlayingPitches.push(i),o.send([144+n,i,r],s)},e.noteOff=(i,r,s=!0)=>{o.send([128+n,i,0],r),s&&(e.currentlyPlayingPitches=e.currentlyPlayingPitches.filter(l=>l!==i))},e.allNotesOff=()=>{setTimeout(()=>{o.send([176+n,123,0]),e.currentlyPlayingPitches=[]},ct)}}class Xe{constructor(t,o){y(this,"currentlyPlayingPitches",[]);switch(o.type){case P.Dom:Ye(this);break;case P.Midi:Ve(this,o);break}}noteOn(t,o,n,i=!0){}noteOff(t,o,n=!0){}allNotesOff(){}pause(){const t=window.performance.now();for(const o of this.currentlyPlayingPitches)this.noteOff(o,t+ct,!1)}resume(){const t=window.performance.now();for(const o of this.currentlyPlayingPitches)this.noteOn(o,31,t,!1)}render(){return null}}class lt{constructor(t,o){E(this,ot);y(this,"controller");y(this,"synthesizer");u(this,ot,t),this.controller=new Ke(t,o.controller),this.synthesizer=new Xe(t,o.synthesizer)}render(){const t=this.controller.render(),o=this.synthesizer.render();if(!t&&!o)return null;const n=c("h2",{},a(this,ot).toUpperCase()),i=c("div",{class:"part"},n,t,o);return n.addEventListener("click",()=>{console.log("click"),console.log(t),t&&t.classList.toggle("hidden"),o&&o.classList.toggle("hidden")}),i}}ot=new WeakMap;function Je(e){return{bass:new lt("bass",e.bass),drum:new lt("drum",e.drum),keys:new lt("keys",e.keys),lead:new lt("lead",e.lead)}}const ct=100;class We{constructor(t,o){E(this,et);E(this,J);E(this,W);E(this,$);E(this,Q,0);E(this,nt,()=>{});E(this,Z,function*(){}());E(this,K,0);E(this,Y,0);E(this,tt,null);u(this,J,t),u(this,W,Je(o)),u(this,$,Object.values(a(this,W)))}changeChart(t){u(this,nt,()=>{for(const o of a(this,$))o.controller.clear();u(this,Z,t.compose(a(this,W))),u(this,tt,a(this,Z).next().value)})()}play(){u(this,K,window.performance.now()+ct),u(this,Y,0),dt(this,et,ht).call(this)}pause(){clearTimeout(a(this,Q)),u(this,Y,window.performance.now()-a(this,K));for(const t of a(this,$))t.synthesizer.pause()}resume(){u(this,K,window.performance.now()-a(this,Y));for(const t of a(this,$))t.synthesizer.resume();dt(this,et,ht).call(this)}stop(){clearTimeout(a(this,Q)),u(this,Y,0),a(this,nt).call(this);for(const t of a(this,$))t.synthesizer.allNotesOff()}render(){const t=a(this,$).map(o=>o.render());return t.some(o=>o!==null)?c("div",{id:"part-container"},...t):null}}J=new WeakMap,W=new WeakMap,$=new WeakMap,Q=new WeakMap,nt=new WeakMap,Z=new WeakMap,K=new WeakMap,Y=new WeakMap,tt=new WeakMap,et=new WeakSet,ht=function(){const t=a(this,tt);if(t===null){console.error("nextEvent is null"),a(this,J).stop();return}const o=t.time+a(this,K),n=o-window.performance.now()-ct;u(this,Q,setTimeout(()=>{switch(t.type){case f.Compute:break;case f.NoteOn:t.part.synthesizer.noteOn(t.pitch,t.velocity,o);break;case f.NoteOff:t.part.synthesizer.noteOff(t.pitch,o);break}const i=a(this,Z).next();if(i.done){a(this,J).stop();return}u(this,tt,i.value),dt(this,et,ht).call(this)},n))};class Qe{constructor(t){E(this,N,w.Paused);E(this,F,()=>{});E(this,q);u(this,q,new We(this,t))}changeChart(t){a(this,q).changeChart(t),a(this,N)!=w.Stopped&&this.stop()}play(){switch(a(this,N)){case w.Playing:break;case w.Paused:a(this,F).call(this,k.Resume),u(this,N,w.Playing);break;case w.Stopped:a(this,F).call(this,k.Play),u(this,N,w.Playing);break}}pause(){switch(a(this,N)){case w.Playing:a(this,F).call(this,k.Pause),u(this,N,w.Paused);break;case w.Paused:break;case w.Stopped:break}}stop(){switch(a(this,N)){case w.Playing:a(this,F).call(this,k.Stop),u(this,N,w.Stopped);break;case w.Paused:a(this,F).call(this,k.Stop),u(this,N,w.Stopped);break;case w.Stopped:break}}connect(t){u(this,F,o=>{switch(o){case k.Play:a(this,q).play(),t.changePlayback(w.Playing);break;case k.Pause:a(this,q).pause(),t.changePlayback(w.Paused);break;case k.Resume:a(this,q).resume(),t.changePlayback(w.Playing);break;case k.Stop:a(this,q).stop(),t.changePlayback(w.Stopped);break}})}render(){return a(this,q).render()}}N=new WeakMap,F=new WeakMap,q=new WeakMap;function kt(e){e&&document.body.append(e)}function Ze(e){const t=new ne(e.transporter),o=new Ue,n=new Qe(e.parts);t.connect(o,n),o.connect(t,n),n.connect(t);const i=t.render(),r=n.render();kt(i),kt(r),o.start()}const to=await ee();Ze(to)})();</script>
  <style rel="stylesheet" crossorigin>:root{--red: #b23535;--green: #38ad5f;--blue: #464ca5;--white: #eeeade;--black: #282828;--text-color: var(--black);--background-color: var(--white)}@media (prefers-color-scheme: dark){:root{--text-color: var(--white);--background-color: var(--black)}}*{color:inherit;background-color:inherit;border-color:inherit;font-family:inherit;box-sizing:inherit}body{min-height:100vh;font-family:Arial,sans-serif;color:var(--text-color);background-color:var(--background-color);border-color:var(--text-color);box-sizing:border-box;padding:0;margin:0}#config-form{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}fieldset{margin-bottom:20px}legend{font-weight:700;margin-bottom:10px}.type-div{margin-bottom:10px}label{-webkit-user-select:none;user-select:none}input[type=radio]:disabled+label{text-decoration:line-through}button{color:var(--text-color);background-color:var(--background-color);border:1px solid var(--text-color);cursor:pointer;transition:background-color .3s ease}button:hover{background-color:var(--text-color);color:var(--background-color)}.transporter-button{width:2em;height:2em;border:1.5px solid;border-radius:50%;font-size:2.5rem;padding:1rem;margin:0 .5rem 2rem;cursor:pointer;color:var(--background-color);background-color:var(--text-color);transition:transform .2s}.transporter-button:hover:enabled{transform:scale(1.1)}.transporter-button:disabled{color:var(--text-color);background-color:var(--background-color);cursor:auto}#transporter{text-align:center;border-bottom:1px solid var(--text-color)}.lcd{padding:.5em 1em;border-radius:5px;width:16ch;min-height:4em;line-height:1.5;text-align:left;font-family:hd44780,monospace;color:var(--background-color);background-color:var(--text-color)}input[type=range]{margin-top:1em;width:100%}.controller-module{padding:1em;display:flex;flex-direction:column;align-items:center;border:1px solid;font-size:1vw}.component-title{margin-top:0;margin-bottom:0;width:100%;height:3rem;line-height:3rem;cursor:pointer;-webkit-user-select:none;user-select:none}.controller-row{border-top:1px solid;justify-content:center;align-items:center;overflow-y:scroll;height:40vw}.controller{padding-top:0;border:1px solid}.note-on{color:var(--green)}.note-off{color:var(--red)}.all-notes-off{color:var(--blue)}.message-row{width:100%;height:10vw;overflow-y:scroll}.synthesizer-row{width:100%}.synthesizer{display:flex;flex-direction:column;align-items:center;width:100%;border:1px solid}.part{text-align:center;border:1px solid;min-width:20%}#part-container{display:flex;flex-wrap:wrap;justify-content:space-around;align-items:start}.hidden{display:none}</style>
</head>

<body>
</body>

</html>