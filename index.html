<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vite + TS</title>
  <script type="module" crossorigin>var Fe=Object.defineProperty;var ce=d=>{throw TypeError(d)};var $e=(d,p,y)=>p in d?Fe(d,p,{enumerable:!0,configurable:!0,writable:!0,value:y}):d[p]=y;var G=(d,p,y)=>$e(d,typeof p!="symbol"?p+"":p,y),le=(d,p,y)=>p.has(d)||ce("Cannot "+y);var o=(d,p,y)=>(le(d,p,"read from private field"),y?y.call(d):p.get(d)),m=(d,p,y)=>p.has(d)?ce("Cannot add the same private member more than once"):p instanceof WeakSet?p.add(d):p.set(d,y),c=(d,p,y,h)=>(le(d,p,"write to private field"),h?h.call(d,y):p.set(d,y),y);(async()=>{var k,S,N,x,E,z,$,A,M,w,D,L,U,I,R,q,j,H,Q,b,v,O;(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();var d=(e=>(e[e.Dom=0]="Dom",e[e.Midi=1]="Midi",e))(d||{}),p=(e=>(e[e.Dom=0]="Dom",e[e.Midi=1]="Midi",e))(p||{}),y=(e=>(e[e.Log=0]="Log",e[e.Dom=1]="Dom",e[e.Midi=2]="Midi",e))(y||{}),h=(e=>(e[e.Playing=0]="Playing",e[e.Paused=1]="Paused",e[e.Stopped=2]="Stopped",e))(h||{}),P=(e=>(e[e.Play=0]="Play",e[e.Pause=1]="Pause",e[e.Resume=2]="Resume",e[e.Stop=3]="Stop",e))(P||{}),f=(e=>(e[e.Tempo=0]="Tempo",e[e.Finish=1]="Finish",e[e.NoteOn=2]="NoteOn",e[e.NoteOff=3]="NoteOff",e[e.Compute=4]="Compute",e))(f||{});const pe={parts:{bass:{controller:{type:p.Dom},synthesizer:{type:y.Midi,midi:{output:"loopMIDI Port",channel:1}}},drum:{controller:{type:p.Dom},synthesizer:{type:y.Dom}},keys:{controller:{type:p.Dom},synthesizer:{type:y.Dom}},lead:{controller:{type:p.Dom},synthesizer:{type:y.Midi,midi:{output:"loopMIDI Port",channel:2}}}},transporter:{type:d.Dom}},he=async()=>pe;function l(e,t={},...n){const s=document.createElement(e);for(const[r,i]of Object.entries(t))s.setAttribute(r,i);for(const r of n)typeof r=="string"?s.appendChild(document.createTextNode(r)):r&&s.appendChild(r);return s}function ue(e){const t=l("h2"),n={previous:l("button",{class:"transporter-button"},"\u23EE"),play:l("button",{class:"transporter-button"},"\u25B6"),pause:l("button",{class:"transporter-button"},"\u23F8"),stop:l("button",{class:"transporter-button"},"\u23F9"),next:l("button",{class:"transporter-button"},"\u23ED")};e.connect=(i,a)=>{n.previous.addEventListener("click",()=>i.goPrevious()),n.next.addEventListener("click",()=>i.goNext()),n.play.addEventListener("click",()=>a.play()),n.pause.addEventListener("click",()=>a.pause()),n.stop.addEventListener("click",()=>a.stop())},e.changeChart=(i,a,u)=>{t.innerText=i,n.previous.disabled=!a,n.next.disabled=!u},e.changePlayback=i=>{n.play.disabled=i===h.Playing,n.pause.disabled=i!==h.Playing,n.stop.disabled=i===h.Stopped};const s=l("div",{},...Object.values(n)),r=l("div",{id:"transporter"},t,s);e.render=()=>r}class de{constructor(t){switch(t.type){case d.Dom:ue(this);break;default:throw new Error(`Invalid Transporter type: ${t}`)}}connect(t,n){}changeChart(t,n,s){}changePlayback(t){}render(){return null}}function W(e){return{position:-1/0,type:f.Tempo,bpm:e}}function Y(...e){return e.map(t=>({position:-1/0,part:t,type:f.Finish}))}const ye={title:"Hello World",compose:({bass:e,drum:t,keys:n,lead:s})=>[W(60),...Y(e,t,n),{position:0,type:f.NoteOn,part:s,pitch:60},{position:4,type:f.NoteOff,part:s,pitch:60},{position:4,type:f.Finish,part:s}]},X=[0,2,4,5,7,9,11,12];function fe(e){return X.map(t=>t+24).map((t,n)=>[{position:n,part:e,type:f.NoteOn,pitch:t},{position:n+.9,part:e,type:f.NoteOff,pitch:t}]).flat()}const me={title:"Bass Scale",compose:({bass:e,drum:t,keys:n,lead:s})=>[W(120),...Y(t,n,s),...fe(e),{position:X.length,type:f.Finish,part:e}]},Z=[[60,0,1],[60,1,1],[67,2,1],[67,3,1],[69,4,1],[69,5,1],[67,6,2],[65,8,1],[65,9,1],[64,10,1],[64,11,1],[62,12,1],[62,13,1],[60,14,2]];function ge(e){const t=e.controller.getRangeControl("8va chance: ",0,100,"%");function n([g,C,F]){const J=Math.random()*100;return{position:C-.1,type:f.Compute,callback:V=>{const Re=t.value,ae=J<Re?g+12:g,Te={position:C,type:f.NoteOn,part:e,pitch:ae},je={position:C+F-.1,type:f.NoteOff,part:e,pitch:ae};V.unshift(Te,je)}}}const s=Z.map(n),[r,i,a]=Z.at(-1)??[0,0,0],u={position:a+i+.1,type:f.Finish,part:e};return[...s,u]}const be={title:"Twinkle Twinkle Little Star",compose:({bass:e,drum:t,keys:n,lead:s})=>[W(120),...Y(e,t,n),...ge(s)]},_=[40,43,45,43,50,48,50,52],ee=2,te=ee/_.length,Pe={title:"On the Run",compose:({bass:e,drum:t,keys:n,lead:s})=>{const r=s.controller.getOptionControl("Repeat again: ",["No","Yes"],"!");function i(u){const g=_.map((F,J)=>{const V=u+J*te;return[{position:V,type:f.NoteOn,part:s,pitch:F},{position:V+te-.05,type:f.NoteOff,part:s,pitch:F}]}).flat(),C=a(u+ee);return[...g,C]}function a(u){return{position:u-.1,type:f.Compute,callback:g=>{r.value?g.push(...i(u)):g.push({position:u,type:f.Finish,part:s})}}}return[W(165),...Y(e,t,n),a(0)]}},ne=[ye,me,be,Pe],se=ne.length;class ke{constructor(){m(this,k,0);m(this,S,()=>{})}goPrevious(){o(this,k)>0&&(c(this,k,o(this,k)-1),o(this,S).call(this))}goNext(){o(this,k)<se-1&&(c(this,k,o(this,k)+1),o(this,S).call(this))}connect(t,n){c(this,S,()=>{const s=ne[o(this,k)],r=s.title,i=o(this,k)>0,a=o(this,k)<se-1;t.changeChart(r,i,a),n.changeChart(s)})}start(){o(this,S).call(this)}}k=new WeakMap,S=new WeakMap;const oe=12,T={min:0,max:127,step:1,default:63};class we{constructor(){m(this,N);m(this,x);m(this,E,()=>{});m(this,z,()=>0);const t=l("span",{},"EMPTY");c(this,N,{0:l("span",{},"%%"),1:t,2:l("span",{},"%%")}),c(this,x,l("input",{type:"range",min:T.min,max:T.max,step:T.step,value:T.default})).addEventListener("input",()=>{o(this,E).call(this)})}clear(){c(this,z,()=>0),c(this,E,()=>{});const t=Object.values(o(this,N));for(const n of t)n.textContent=""}get value(){return o(this,z).call(this)}makeIntoRangeControl(t,n,s,r=""){const i=o(this,N),a=i[1],u=o(this,x);i[0].textContent=t,i[2].textContent=r;const g=c(this,z,()=>n+Math.round((s-n)*Number(u.value)/T.max));c(this,E,()=>{a.textContent=g().toString()})()}makeIntoOptionControl(t,n,s=""){const r=o(this,N),i=r[1],a=o(this,x);r[0].textContent=t,r[2].textContent=s;const u=c(this,z,()=>Math.round((n.length-1)*Number(a.value)/T.max));c(this,E,()=>{i.textContent=n[u()]})()}render(){const t=l("label",{class:"lcd"},...Object.values(o(this,N)));return l("div",{class:"controller-module"},t,o(this,x))}}N=new WeakMap,x=new WeakMap,E=new WeakMap,z=new WeakMap;function Oe(e){const t=Array.from({length:oe},()=>new we);let n=0;e.clear=()=>{t.forEach(r=>r.clear()),n=0};function s(){if(n>=oe)throw new Error("No more controllers available");const r=t[n];return n+=1,r}e.getRangeControl=(r,i,a,u="")=>{const g=s();return g.makeIntoRangeControl(r,i,a,u),g},e.getOptionControl=(r,i,a="")=>{const u=s();return u.makeIntoOptionControl(r,i,a),u},e.render=()=>{const r=l("h2",{class:"component-title"},"Controller"),i=t.map(u=>u.render()),a=l("div",{class:"controller-row"},...i);return r.addEventListener("click",()=>{a.classList.toggle("hidden")}),l("div",{class:"controller"},r,a)}}class ve{constructor(t,n){switch(n.type){case p.Dom:Oe(this);break;default:throw new Error(`Invalid Controller type: ${n}`)}}clear(){}getRangeControl(t,n,s,r=""){return{value:0}}getOptionControl(t,n,s=""){return{value:0}}render(){return null}}const re=await navigator.requestMIDIAccess({sysex:!0}).catch(()=>null);function Ce(e){e.noteOn=(t,n)=>{console.log("noteOn",t,n)},e.noteOff=(t,n)=>{console.log("noteOff",t,n)},e.allNotesOff=()=>{console.log("allNotesOff")}}function Ne(e){const t=l("h2",{class:"component-title"},"Synthesizer"),n=l("button",{},"Clear"),s=l("div",{class:"message-row"}),r=l("div",{class:"synthesizer-row"},n,s),i=l("div",{class:"synthesizer"},t,r);e.noteOn=(a,u,g=!0)=>{g&&e.currentlyPlayingPitches.push(a);const C=l("div",{class:"note-on"},`noteOn ${a} ${u}`);s.appendChild(C)},e.noteOff=(a,u,g=!0)=>{const C=l("div",{class:"note-off"},`noteOff ${a} ${u}`);s.appendChild(C),g&&(e.currentlyPlayingPitches=e.currentlyPlayingPitches.filter(F=>F!==a))},e.allNotesOff=()=>{const a=l("div",{class:"all-notes-off"},"allNotesOff");s.appendChild(a),e.currentlyPlayingPitches=[]},n.addEventListener("click",()=>{s.innerHTML=""}),t.addEventListener("click",()=>{r.classList.toggle("hidden")}),e.render=()=>i}function Me(e,t){if(!re)throw new Error("No MIDI access");const n=re.outputs.values().find(r=>r.name===t.midi.output);if(!n)throw new Error(`No MIDI output named ${t.midi.output}`);const s=t.midi.channel-1;e.noteOn=(r,i,a=!0)=>{a&&e.currentlyPlayingPitches.push(r),n.send([144+s,r,127],i)},e.noteOff=(r,i,a=!0)=>{n.send([128+s,r,0],i),a&&(e.currentlyPlayingPitches=e.currentlyPlayingPitches.filter(u=>u!==r))},e.allNotesOff=()=>{n.send([176+s,123,0]),e.currentlyPlayingPitches=[]}}class De{constructor(t,n){G(this,"currentlyPlayingPitches",[]);switch(n.type){case y.Log:Ce(this);break;case y.Dom:Ne(this);break;case y.Midi:Me(this,n);break}}noteOn(t,n,s=!0){}noteOff(t,n,s=!0){}allNotesOff(){}pause(){const t=window.performance.now();for(const n of this.currentlyPlayingPitches)this.noteOff(n,t,!1)}resume(){const t=window.performance.now();for(const n of this.currentlyPlayingPitches)this.noteOn(n,t,!1)}render(){return null}}class B{constructor(t,n){m(this,$);G(this,"controller");G(this,"synthesizer");c(this,$,t),this.controller=new ve(t,n.controller),this.synthesizer=new De(t,n.synthesizer)}render(){const t=l("h2",{},o(this,$).toUpperCase()),n=this.controller.render(),s=this.synthesizer.render();return n||s?l("div",{class:"part"},t,n,s):null}}$=new WeakMap;function Le(e){return{bass:new B("bass",e.bass),drum:new B("drum",e.drum),keys:new B("keys",e.keys),lead:new B("lead",e.lead)}}const K=100;function Se(){return new Worker(new URL(""+new URL("worker-Dukc8-Vk.js",import.meta.url).href,import.meta.url),{type:"module"})}class xe{constructor(t,n){m(this,H);m(this,A);m(this,M,Se());m(this,w);m(this,D,!1);m(this,L,[]);m(this,U,()=>{});m(this,I,0);m(this,R,0);m(this,q,6e4/120);m(this,j,new Set);c(this,A,t),c(this,w,Le(n)),o(this,M).onmessage=s=>this.schedule()}schedule(){const t=window.performance.now()+K;for(;o(this,D)&&o(this,H,Q)<t;){const n=o(this,H,Q),s=o(this,L).shift();if(s)switch(s.type){case f.Tempo:c(this,q,6e4/s.bpm);break;case f.Finish:o(this,j).add(s.part),o(this,j).size===4&&o(this,A).stop();break;case f.NoteOn:s.part.synthesizer.noteOn(s.pitch,n);break;case f.NoteOff:s.part.synthesizer.noteOff(s.pitch,n);break;case f.Compute:s.callback(o(this,L));break}}}changeChart(t){c(this,U,()=>{for(const n of Object.values(o(this,w)))n.controller.clear();c(this,L,t.compose(o(this,w)))})()}play(){c(this,D,!0),c(this,I,window.performance.now()+K),c(this,R,0),o(this,M).postMessage(0)}pause(){c(this,D,!1),o(this,M).postMessage(1),c(this,R,window.performance.now()-o(this,I)),setTimeout(()=>{for(const t of Object.values(o(this,w)))t.synthesizer.pause()},K*2)}resume(){c(this,D,!0),c(this,I,window.performance.now()-o(this,R)),o(this,M).postMessage(0);for(const t of Object.values(o(this,w)))t.synthesizer.resume()}stop(){c(this,D,!1),o(this,M).postMessage(1),c(this,R,0),o(this,j).clear(),o(this,U).call(this),setTimeout(()=>{for(const t of Object.values(o(this,w)))t.synthesizer.allNotesOff()},K*2)}render(){const t=Object.values(o(this,w)).map(n=>n.render());return t.some(n=>n!==null)?l("div",{id:"part-container"},...t):null}}A=new WeakMap,M=new WeakMap,w=new WeakMap,D=new WeakMap,L=new WeakMap,U=new WeakMap,I=new WeakMap,R=new WeakMap,q=new WeakMap,j=new WeakMap,H=new WeakSet,Q=function(){return o(this,L).length===0?1/0:o(this,L)[0].position*o(this,q)+o(this,I)};class Ee{constructor(t){m(this,b,h.Paused);m(this,v,()=>{});m(this,O);console.debug("Playbacker",t),c(this,O,new xe(this,t))}changeChart(t){console.debug("changeChart",t),o(this,O).changeChart(t),o(this,b)!=h.Stopped&&this.stop()}play(){switch(o(this,b)){case h.Playing:console.debug("already playing");break;case h.Paused:console.debug("resume"),o(this,v).call(this,P.Resume),c(this,b,h.Playing);break;case h.Stopped:console.debug("play"),o(this,v).call(this,P.Play),c(this,b,h.Playing);break}}pause(){switch(o(this,b)){case h.Playing:console.debug("pause"),o(this,v).call(this,P.Pause),c(this,b,h.Paused);break;case h.Paused:console.debug("already paused");break;case h.Stopped:console.debug("already stopped");break}}stop(){switch(o(this,b)){case h.Playing:console.debug("stop"),o(this,v).call(this,P.Stop),c(this,b,h.Stopped);break;case h.Paused:console.debug("stop"),o(this,v).call(this,P.Stop),c(this,b,h.Stopped);break;case h.Stopped:console.debug("already stopped");break}}connect(t){c(this,v,n=>{switch(n){case P.Play:o(this,O).play(),t.changePlayback(h.Playing);break;case P.Pause:o(this,O).pause(),t.changePlayback(h.Paused);break;case P.Resume:o(this,O).resume(),t.changePlayback(h.Playing);break;case P.Stop:o(this,O).stop(),t.changePlayback(h.Stopped);break}})}render(){return o(this,O).render()}}b=new WeakMap,v=new WeakMap,O=new WeakMap;function ie(e){e&&document.body.append(e)}function ze(e){const t=new de(e.transporter),n=new ke,s=new Ee(e.parts);t.connect(n,s),n.connect(t,s),s.connect(t);const r=t.render(),i=s.render();ie(r),ie(i),n.start()}const Ie=await he();ze(Ie)})();
</script>
  <style rel="stylesheet" crossorigin>:root{--red: #b23535;--green: #38ad5f;--blue: #464ca5;--white: #eeeade;--black: #282828;--text-color: var(--black);--background-color: var(--white)}@media (prefers-color-scheme: dark){:root{--text-color: var(--white);--background-color: var(--black)}}*{color:inherit;background-color:inherit;border-color:inherit;font-family:inherit;box-sizing:inherit}body{min-height:100vh;font-family:Arial,sans-serif;color:var(--text-color);background-color:var(--background-color);border-color:var(--text-color);box-sizing:border-box;padding:0;margin:0}button{color:var(--text-color);background-color:var(--background-color);border:1px solid var(--text-color);cursor:pointer;transition:background-color .3s ease}button:hover{background-color:var(--text-color);color:var(--background-color)}.transporter-button{width:2em;height:2em;border:1.5px solid;border-radius:50%;font-size:2.5rem;padding:1rem;margin:0 .5rem 2rem;cursor:pointer;color:var(--background-color);background-color:var(--text-color);transition:transform .2s}.transporter-button:hover:enabled{transform:scale(1.1)}.transporter-button:disabled{color:var(--text-color);background-color:var(--background-color);cursor:auto}#transporter{text-align:center;border-bottom:1px solid var(--text-color)}.lcd{padding:.5em 1em;border-radius:5px;width:16ch;min-height:4em;line-height:1.5;text-align:left;font-family:hd44780,monospace;color:var(--background-color);background-color:var(--text-color)}input[type=range]{margin-top:1em;width:100%}.controller-module{padding:1em;display:flex;flex-direction:column;align-items:center;border:1px solid;font-size:1vw}.component-title{margin-top:0;margin-bottom:0;width:100%;height:3rem;line-height:3rem;cursor:pointer;-webkit-user-select:none;user-select:none}.controller-row{border-top:1px solid;justify-content:center;align-items:center;overflow-y:scroll;height:40vw}.controller{padding-top:0;border:1px solid}.note-on{color:var(--green)}.note-off{color:var(--red)}.all-notes-off{color:var(--blue)}.message-row{width:100%;height:10vw;overflow-y:scroll}.synthesizer-row{width:100%}.synthesizer{display:flex;flex-direction:column;align-items:center;width:100%;border:1px solid}.part{text-align:center;border:1px solid;min-width:20%}#part-container{display:flex;flex-wrap:wrap;justify-content:space-around;align-items:start}.hidden{display:none}
</style>
</head>

<body>
</body>

</html>